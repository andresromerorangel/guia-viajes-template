<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plantilla Cartilla de Viaje - P√°gina √önica Din√°mica</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --teal-primary: #0F7A78;
            --teal-light: #5FB4B2;
            --sand: #F6EFE6;
            --coral: #FF6B61;
            --white: #ffffff;
            --text-dark: #2F3A3A;
            --text-light: #666;
            --safe-margin: 20mm;
            --bleed: 3mm;
            --gap: 16px; /* Dynamic gap for compacting */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--sand);
            color: var(--text-dark);
            line-height: 1.4;
            overflow-x: hidden;
        }

        /* LAYER: BACKGROUND */
        .document-container {
            width: 100%;
            min-height: 100vh;
            background: var(--sand);
        }

        /* REMOVE PAGINATION - Single Dynamic Page */
        .page {
            width: 210mm;
            min-height: 297mm;
            height: auto; /* Auto-expand instead of fixed height */
            margin: 0 auto 20px;
            background: var(--sand);
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            page-break-inside: avoid; /* Avoid breaking when printing */
            overflow: visible; /* Allow content to show */
        }

        .page-content {
            padding: var(--safe-margin);
            height: auto; /* Auto height instead of fixed */
            display: flex;
            flex-direction: column;
            gap: var(--gap);
        }

        /* LAYER: BANNER - Master Header with Logo Slot */
        .master-header {
            height: 80px;
            background: linear-gradient(135deg, var(--teal-primary), var(--teal-light));
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            padding: 0 20px;
            flex-shrink: 0;
        }

        /* ADD LOGO SLOT */
        .logo-slot {
            width: 56px;
            height: 36px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background: transparent;
            border: 2px dashed rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 8px;
            color: rgba(255,255,255,0.7);
            text-align: center;
            line-height: 1.1;
            overflow: hidden;
        }

        .logo-slot:hover {
            border-color: rgba(255,255,255,0.6);
            background: rgba(255,255,255,0.1);
        }

        .logo-slot.has-logo {
            border-style: solid;
            border-color: var(--white);
        }

        .logo-slot img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .flag-container {
            width: 48px;
            height: 36px;
            background: var(--white);
            border-radius: 4px;
            border: 2px solid var(--teal-primary);
            margin-right: 12px; /* Updated margin */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--teal-primary);
            font-weight: 600;
        }

        .country-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 32px;
            color: var(--white);
            flex: 1;
        }

        .page-indicator {
            position: absolute;
            top: 8px;
            right: 16px;
            background: rgba(255,255,255,0.9);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 8px;
            color: var(--teal-primary);
            font-weight: 500;
        }

        /* LAYER: FOOTER - Master Footer */
        .master-footer {
            margin-top: auto;
            padding-top: 12px;
            border-top: 1px solid #E5E5E5;
            font-size: 8px;
            color: #999;
            text-align: center;
            flex-shrink: 0;
        }

        /* Main Content Area - No Overflow Hidden */
        .content-area {
            flex: 1;
            display: grid;
            grid-template-columns: 38% 62%;
            gap: var(--gap);
            overflow: visible; /* Allow content to show */
        }

        /* LAYER: SIDEBAR - No Overflow Hidden */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: var(--gap);
            overflow: visible; /* Allow content to show */
        }

        .right-column {
            display: flex;
            flex-direction: column;
            gap: var(--gap);
            overflow: visible; /* Allow content to show */
        }

        /* Auto-Expand Containers */
        .flow-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: visible; /* Allow content to show */
        }

        .flow-item {
            flex-shrink: 0;
            break-inside: avoid;
        }

        /* Component System with Enhanced Controls */
        .component {
            position: relative;
            transition: all 0.2s ease;
        }

        .component:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(15, 122, 120, 0.15);
        }

        .component:hover .component-controls {
            opacity: 1;
        }

        .component-controls {
            position: absolute;
            top: -8px;
            right: -8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .control-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .duplicate-btn {
            background: var(--teal-light);
            color: var(--white);
        }

        .delete-btn {
            background: var(--coral);
            color: var(--white);
        }

        /* Section Headers with Counters */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #E5E5E5;
        }

        .section-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 16px;
            color: var(--teal-primary);
        }

        .section-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item-counter {
            font-size: 10px;
            color: var(--text-light);
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 8px;
        }

        .add-btn {
            background: var(--teal-primary);
            color: var(--white);
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }

        .add-btn:hover {
            background: #0d6866;
        }

        .add-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* LAYER: SUMMARY_CARD */
        .summary-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);
            flex-shrink: 0;
        }

        .summary-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 20px;
            color: var(--teal-primary);
            margin-bottom: 12px;
        }

        .summary-item {
            margin-bottom: 8px;
            font-size: 12px;
        }

        .summary-label {
            font-weight: 600;
            color: var(--teal-primary);
        }

        /* Cost Rating Component */
        .cost-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }

        .cost-circles {
            display: flex;
            gap: 3px;
        }

        .cost-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--coral);
            cursor: pointer;
            transition: all 0.2s;
        }

        .cost-circle.empty {
            background: #E5E5E5;
        }

        .cost-circle:hover {
            transform: scale(1.1);
        }

        .cost-text {
            font-size: 10px;
            color: var(--text-light);
        }

        /* LAYER: PHOTOS - Image Frames System */
        .photo-section {
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .photo-frame {
            background: #f8f9fa;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 60px;
        }

        .photo-frame.hero {
            grid-column: span 2;
            aspect-ratio: 3/1;
            min-height: 80px;
        }

        .photo-frame.mini {
            aspect-ratio: 1/1;
        }

        .photo-frame:hover {
            border-color: var(--teal-primary);
            background: #f0f9f9;
        }

        .photo-frame.has-image {
            border-style: solid;
            border-color: var(--teal-primary);
        }

        .photo-placeholder {
            text-align: center;
            color: var(--text-light);
            font-size: 9px;
            padding: 8px;
        }

        .photo-controls {
            position: absolute;
            bottom: 4px;
            right: 4px;
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .photo-frame:hover .photo-controls {
            opacity: 1;
        }

        .photo-btn {
            background: rgba(0,0,0,0.7);
            color: var(--white);
            border: none;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 8px;
            cursor: pointer;
        }

        /* LAYER: MAP_ROUTE */
        .map-section {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);
        }

        .map-container {
            width: 100%;
            height: 140px;
            background: linear-gradient(135deg, #f0f9f9, #e6f7f7);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .map-route {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .map-pin {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--coral);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 10px;
            font-weight: 600;
            border: 2px solid var(--white);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            cursor: move;
            transition: transform 0.2s;
        }

        .map-pin:hover {
            transform: scale(1.1);
        }

        /* LAYER: ITINERARY */
        .itinerary-section {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);
        }

        .itinerary-card {
            background: #f8fffe;
            border-left: 4px solid var(--teal-light);
            padding: 12px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 8px;
            position: relative;
            break-inside: avoid;
        }

        .day-title {
            font-weight: 600;
            color: var(--teal-primary);
            font-size: 12px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .day-activity {
            font-size: 10px;
            color: var(--text-light);
            line-height: 1.3;
        }

        /* LAYER: TOP_PLACES */
        .top-places {
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);
        }

        .place-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            background: #f8fffe;
            margin-bottom: 8px;
            position: relative;
            break-inside: avoid;
        }

        .place-badge {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 8px;
            font-weight: 600;
            cursor: pointer;
            flex-shrink: 0;
        }

        .place-badge.must { background: var(--coral); color: var(--white); }
        .place-badge.skip { background: #E5E5E5; color: var(--text-light); }
        .place-badge.eco { background: #4CAF50; color: var(--white); }
        .place-badge.family { background: #FF9800; color: var(--white); }

        .place-text {
            font-size: 10px;
            flex: 1;
        }

        .place-name {
            font-weight: 600;
            color: var(--teal-primary);
        }

        /* LAYER: QUICK_TIPS */
        .quick-tips {
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);
        }

        .tips-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .tip-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 9px;
            padding: 8px;
            background: #f8fffe;
            border-radius: 6px;
            position: relative;
            break-inside: avoid;
        }

        .tip-icon {
            width: 16px;
            height: 16px;
            background: var(--coral);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 8px;
            flex-shrink: 0;
        }

        /* Editable System with Character Limits */
        .editable {
            background: rgba(255, 107, 97, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px dashed var(--coral);
            cursor: text;
            position: relative;
            min-height: 1.2em;
            word-wrap: break-word;
        }

        .editable:hover {
            background: rgba(255, 107, 97, 0.2);
        }

        .editable:focus {
            background: rgba(255, 107, 97, 0.3);
            outline: none;
        }

        .char-counter {
            font-size: 8px;
            color: var(--text-light);
            margin-left: 4px;
        }

        .char-counter.warning {
            color: var(--coral);
            font-weight: 600;
        }

        .truncated {
            position: relative;
        }

        .read-more {
            color: var(--teal-primary);
            cursor: pointer;
            font-size: 8px;
            text-decoration: underline;
        }

        /* Control Panel */
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: var(--white);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .control-btn-main {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .control-btn-main:hover {
            transform: translateY(-1px);
        }

        .help-btn { background: var(--teal-primary); color: var(--white); }
        .export-btn { background: var(--coral); color: var(--white); }
        .preview-btn { background: var(--teal-light); color: var(--white); }
        .undo-btn { background: #666; color: var(--white); }
        .save-btn { background: #4CAF50; color: var(--white); }
        .autoextend-btn { background: var(--teal-light); color: var(--white); }
        .autoextend-btn.active { background: var(--teal-primary); }
        .compact-btn { background: #FF9800; color: var(--white); }

        /* Status Indicators */
        .status-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
            color: var(--text-light);
            padding: 4px 0;
            border-top: 1px solid #eee;
            margin-top: 8px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4CAF50;
        }

        .status-dot.warning { background: #FF9800; }
        .status-dot.error { background: var(--coral); }

        /* LAYER: TEMPLATE_VARIABLES - Hidden Data Layer */
        .template-variables {
            display: none;
        }

        /* Responsive Design */
        @media screen and (max-width: 1200px) {
            .page {
                transform: scale(0.8);
                transform-origin: top center;
            }
        }

        @media screen and (max-width: 900px) {
            .page {
                transform: scale(0.6);
            }
            
            .content-area {
                grid-template-columns: 1fr;
            }
        }

        /* Print Styles */
        @media print {
            body { margin: 0; background: var(--white); }
            .page { 
                box-shadow: none; 
                margin: 0;
                width: 210mm;
                min-height: 297mm;
                page-break-inside: avoid;
            }
            .control-panel, .help-panel {
                display: none !important;
            }
        }

        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Overflow Indicators */
        .overflow-warning {
            border: 2px solid var(--coral) !important;
            background: rgba(255, 107, 97, 0.1) !important;
        }

        .overflow-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--coral);
            color: var(--white);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }

        /* Compact Mode Styles */
        .compact-mode {
            --gap: 8px;
        }

        .compact-mode .tips-grid {
            gap: 6px;
        }

        .compact-mode .photo-grid {
            gap: 6px;
        }
    </style>
</head>
<body>
    <!-- Control Panel -->
    <div class="control-panel">
        <button class="control-btn-main help-btn" onclick="toggleHelp()">‚ùì Ayuda</button>
        <button class="control-btn-main save-btn" onclick="autosaveJSON()">üíæ Guardar</button>
        <button class="control-btn-main undo-btn" onclick="undo()" id="undoBtn" disabled>‚Ü∂ Deshacer</button>
        <button class="control-btn-main autoextend-btn active" onclick="toggleAutoExtend()" id="autoExtendBtn">üìè Auto-extendido ON</button>
        <button class="control-btn-main compact-btn" onclick="compactLayout()" id="compactBtn" style="display: none;">üìê Compactar</button>
        <button class="control-btn-main export-btn" onclick="exportTemplate('A4')">üìÑ PDF A4</button>
        <button class="control-btn-main export-btn" onclick="exportTemplate('SOCIAL')">üì± Social</button>
        <button class="control-btn-main preview-btn" onclick="togglePreview()">üëÅÔ∏è Vista previa</button>
        
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="saveStatus"></div>
                <span id="saveText">Guardado</span>
            </div>
            <div class="status-indicator">
                <span id="pageCount">P√°gina 1 de 1</span>
            </div>
        </div>
    </div>

    <!-- LAYER: TEMPLATE_VARIABLES - Hidden Data Layer for CSV/JSON Export -->
    <div class="template-variables">
        <!-- Master Variables -->
        <div data-var="PAIS" data-type="text" data-limit="30">{{PAIS}}</div>
        <div data-var="FECHAS" data-type="text" data-limit="20">{{FECHAS}}</div>
        <div data-var="DURACION" data-type="text" data-limit="15">{{DURACION}}</div>
        <div data-var="COSTE" data-type="number" data-range="1-5">{{COSTE}}</div>
        <div data-var="MONEDA" data-type="text" data-limit="10">{{MONEDA}}</div>
        <div data-var="ENCHUFE" data-type="text" data-limit="10">{{ENCHUFE}}</div>
        <div data-var="EMERGENCIA" data-type="text" data-limit="15">{{EMERGENCIA}}</div>
        <div data-var="EMBAJADA" data-type="text" data-limit="15">{{EMBAJADA}}</div>
        <div data-var="IDIOMA" data-type="text" data-limit="20">{{IDIOMA}}</div>
        
        <!-- Image Variables with ALT text -->
        <div data-var="IMG_HERO" data-type="image" data-ratio="3:1" data-alt="ALT_IMG_HERO">{{IMG_HERO}}</div>
        <div data-var="IMG_1" data-type="image" data-ratio="1:1" data-alt="ALT_IMG_1">{{IMG_1}}</div>
        <div data-var="IMG_2" data-type="image" data-ratio="1:1" data-alt="ALT_IMG_2">{{IMG_2}}</div>
        <div data-var="IMG_3" data-type="image" data-ratio="1:1" data-alt="ALT_IMG_3">{{IMG_3}}</div>
        <div data-var="IMG_4" data-type="image" data-ratio="1:1" data-alt="ALT_IMG_4">{{IMG_4}}</div>
        <div data-var="IMG_5" data-type="image" data-ratio="1:1" data-alt="ALT_IMG_5">{{IMG_5}}</div>
        <div data-var="IMG_6" data-type="image" data-ratio="1:1" data-alt="ALT_IMG_6">{{IMG_6}}</div>
        
        <!-- Dynamic Arrays -->
        <div data-var="CIUDADES" data-type="array" data-max="12" data-item-limit="25">{{CIUDADES}}</div>
        <div data-var="DIAS" data-type="array" data-max="10" data-item-limit="20,120">{{DIAS}}</div>
        <div data-var="LUGARES" data-type="array" data-max="12" data-item-limit="20,15,30">{{LUGARES}}</div>
        <div data-var="TIPS" data-type="array" data-max="12" data-item-limit="80">{{TIPS}}</div>
        
        <!-- Page Metadata -->
        <div data-var="page_index" data-type="number">{{page_index}}</div>
        <div data-var="total_pages" data-type="number">{{total_pages}}</div>
        <div data-var="FECHA_CREACION" data-type="date">{{FECHA_CREACION}}</div>
        <div data-var="CREDITOS" data-type="text" data-limit="50">{{CREDITOS}}</div>
    </div>

    <!-- Document Container -->
    <div class="document-container">
        <!-- Single Dynamic Page -->
        <div class="page" id="page-1" data-page="1">
            <div class="page-content">
                <!-- LAYER: BANNER - Master Header with Logo Slot -->
                <div class="master-header">
                    <!-- ADD LOGO SLOT -->
                    <div class="logo-slot" aria-label="logo" title="Logo del canal" onclick="uploadLogo(this)">
                        <img src="" alt="Logo" style="display: none;" />
                        <div class="logo-placeholder">LOGO<br><small>Click</small></div>
                    </div>
                    <div class="flag-container">üè≥Ô∏è</div>
                    <div class="country-title editable" data-limit="30" data-var="PAIS">{{PA√çS}}<span class="char-counter">0/30</span></div>
                    <div class="page-indicator">P√°gina <span class="page-number">1</span> de <span class="total-pages">1</span></div>
                </div>

                <!-- Main Content Area -->
                <div class="content-area">
                    <!-- LAYER: SIDEBAR - Left Column -->
                    <div class="left-column">
                        <!-- LAYER: SUMMARY_CARD -->
                        <div class="summary-card component flow-item">
                            <div class="summary-title editable" data-limit="25" data-var="NOMBRE_PAIS">{{NOMBRE DEL PA√çS}}<span class="char-counter">0/25</span></div>
                            <div class="summary-item">
                                <span class="summary-label">Fechas:</span> 
                                <span class="editable" data-limit="20" data-var="FECHAS">{{Fechas de visita}}<span class="char-counter">0/20</span></span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Duraci√≥n:</span> 
                                <span class="editable" data-limit="15" data-var="DURACION">{{Duraci√≥n (d√≠as)}}<span class="char-counter">0/15</span></span>
                            </div>
                            
                            <!-- Cost Rating Component -->
                            <div class="cost-rating component" data-component="COST_RATING">
                                <span class="summary-label">Coste:</span>
                                <div class="cost-circles">
                                    <div class="cost-circle" data-value="1"></div>
                                    <div class="cost-circle" data-value="2"></div>
                                    <div class="cost-circle" data-value="3"></div>
                                    <div class="cost-circle empty" data-value="4"></div>
                                    <div class="cost-circle empty" data-value="5"></div>
                                </div>
                                <span class="cost-text">3/5 ‚Äî Moderado</span>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;">
                                    <div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üí∞</div>
                                    <span class="editable" data-limit="10" data-var="MONEDA">{{Moneda}}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;">
                                    <div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üîå</div>
                                    <span class="editable" data-limit="10" data-var="ENCHUFE">{{Enchufe}}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;">
                                    <div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üÜò</div>
                                    <span class="editable" data-limit="15" data-var="EMERGENCIA">{{Tel. emergencia}}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;">
                                    <div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üèõÔ∏è</div>
                                    <span class="editable" data-limit="15" data-var="EMBAJADA">{{Embajada}}</span>
                                </div>
                            </div>
                        </div>

                        <!-- LAYER: PHOTOS -->
                        <div class="photo-section flow-item">
                            <div class="section-header">
                                <div class="section-title">Fotos del Viaje</div>
                                <div class="section-controls">
                                    <span class="item-counter" id="photoCounter">3/7 fotos</span>
                                    <button class="add-btn" onclick="addPhoto()" id="addPhotoBtn">+ Foto</button>
                                </div>
                            </div>
                            
                            <!-- Hero Photo Frame -->
                            <div class="photo-frame hero component" data-component="PHOTO_FRAME" data-frame="IMG_HERO">
                                <div style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px;">3:1 Hero</div>
                                <div class="photo-placeholder">
                                    üì∏ Imagen Principal<br>
                                    <small>Arrastra imagen aqu√≠ (ratio 3:1)</small>
                                </div>
                                <div class="photo-controls">
                                    <button class="photo-btn" onclick="changePhoto(this)">Cambiar</button>
                                    <button class="photo-btn" onclick="removePhoto(this)">Eliminar</button>
                                </div>
                            </div>

                            <!-- Mini Photos Grid -->
                            <div class="photo-grid" id="photoGrid">
                                <div class="photo-frame mini component" data-component="PHOTO_FRAME" data-frame="IMG_1">
                                    <div style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px;">1:1</div>
                                    <div class="photo-placeholder">
                                        üì∑ IMG_1<br>
                                        <small>Drag & Drop</small>
                                    </div>
                                    <div class="photo-controls">
                                        <button class="photo-btn" onclick="changePhoto(this)">Cambiar</button>
                                        <button class="photo-btn" onclick="removePhoto(this)">√ó</button>
                                    </div>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                                <div class="photo-frame mini component" data-component="PHOTO_FRAME" data-frame="IMG_2">
                                    <div style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px;">1:1</div>
                                    <div class="photo-placeholder">
                                        üì∑ IMG_2<br>
                                        <small>Drag & Drop</small>
                                    </div>
                                    <div class="photo-controls">
                                        <button class="photo-btn" onclick="changePhoto(this)">Cambiar</button>
                                        <button class="photo-btn" onclick="removePhoto(this)">√ó</button>
                                    </div>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Language Info -->
                        <div style="background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);" class="flow-item">
                            <div style="font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 14px; color: var(--teal-primary); margin-bottom: 12px;">Informaci√≥n R√°pida</div>
                            <div style="display: flex; align-items: center; gap: 6px; font-size: 10px; margin-bottom: 8px;">
                                <div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üó£Ô∏è</div>
                                <span class="editable" data-limit="20" data-var="IDIOMA">{{Idioma principal}}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="right-column">
                        <!-- LAYER: MAP_ROUTE -->
                        <div class="map-section flow-item">
                            <div class="section-header">
                                <div class="section-title">Ruta del Viaje</div>
                                <div class="section-controls">
                                    <span class="item-counter" id="cityCounter">3/12 ciudades</span>
                                    <button class="add-btn" onclick="addCity()" id="addCityBtn">+ Ciudad</button>
                                </div>
                            </div>
                            
                            <div class="map-container">
                                <svg class="map-route" viewBox="0 0 100 100">
                                    <path d="M 20 30 Q 40 20 60 40 T 80 70" stroke="var(--teal-primary)" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
                                </svg>
                                <div class="map-pin component" data-component="MAP_PIN" data-pin="1" style="top: 20%; left: 20%;">1</div>
                                <div class="map-pin component" data-component="MAP_PIN" data-pin="2" style="top: 40%; left: 50%;">2</div>
                                <div class="map-pin component" data-component="MAP_PIN" data-pin="3" style="top: 60%; left: 75%;">3</div>
                                <div style="position: absolute; bottom: 8px; right: 8px; width: 40px; height: 40px; background: var(--teal-primary); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px; text-align: center; line-height: 1.1;">QR<br>Map</div>
                            </div>
                            
                            <div class="flow-container" id="citiesList">
                                <div class="component flow-item" data-component="CITY_ITEM" style="display: flex; align-items: center; gap: 8px; font-size: 9px;">
                                    <div style="width: 16px; height: 16px; background: var(--teal-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 600;">1</div>
                                    <span class="editable" data-limit="25" data-var="CIUDAD_1">{{Ciudad 1 ‚Äî descripci√≥n breve}}</span>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                                <div class="component flow-item" data-component="CITY_ITEM" style="display: flex; align-items: center; gap: 8px; font-size: 9px;">
                                    <div style="width: 16px; height: 16px; background: var(--teal-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 600;">2</div>
                                    <span class="editable" data-limit="25" data-var="CIUDAD_2">{{Ciudad 2 ‚Äî descripci√≥n breve}}</span>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                                <div class="component flow-item" data-component="CITY_ITEM" style="display: flex; align-items: center; gap: 8px; font-size: 9px;">
                                    <div style="width: 16px; height: 16px; background: var(--teal-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 600;">3</div>
                                    <span class="editable" data-limit="25" data-var="CIUDAD_3">{{Ciudad 3 ‚Äî descripci√≥n breve}}</span>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- LAYER: ITINERARY -->
                        <div class="itinerary-section flow-item">
                            <div class="section-header">
                                <div class="section-title">Itinerario</div>
                                <div class="section-controls">
                                    <span class="item-counter" id="dayCounter">3/10 d√≠as</span>
                                    <button class="add-btn" onclick="addItineraryDay()" id="addDayBtn">+ D√≠a</button>
                                </div>
                            </div>
                            
                            <div class="flow-container" id="itineraryList">
                                <div class="itinerary-card component flow-item" data-component="ITINERARY_CARD">
                                    <div class="day-title">
                                        üïê <span class="editable" data-limit="20" data-var="DIA_1">{{D√≠a 1: Ciudad}}</span>
                                    </div>
                                    <div class="day-activity editable" data-limit="120" data-var="ACTIVIDAD_1">{{Actividad principal del d√≠a - descripci√≥n breve}}<span class="char-counter">0/120</span></div>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                                
                                <div class="itinerary-card component flow-item" data-component="ITINERARY_CARD">
                                    <div class="day-title">
                                        üïê <span class="editable" data-limit="20" data-var="DIA_2">{{D√≠a 2: Ciudad}}</span>
                                    </div>
                                    <div class="day-activity editable" data-limit="120" data-var="ACTIVIDAD_2">{{Actividad principal del d√≠a - descripci√≥n breve}}<span class="char-counter">0/120</span></div>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                                
                                <div class="itinerary-card component flow-item" data-component="ITINERARY_CARD">
                                    <div class="day-title">
                                        üïê <span class="editable" data-limit="20" data-var="DIA_3">{{D√≠a 3: Ciudad}}</span>
                                    </div>
                                    <div class="day-activity editable" data-limit="120" data-var="ACTIVIDAD_3">{{Actividad principal del d√≠a - descripci√≥n breve}}<span class="char-counter">0/120</span></div>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- LAYER: TOP_PLACES -->
                        <div class="top-places flow-item">
                            <div class="section-header">
                                <div class="section-title">Top Lugares</div>
                                <div class="section-controls">
                                    <span class="item-counter" id="placeCounter">3/12 lugares</span>
                                    <button class="add-btn" onclick="addPlace()" id="addPlaceBtn">+ Lugar</button>
                                </div>
                            </div>
                            
                            <div class="flow-container" id="placesList">
                                <div class="place-item component flow-item" data-component="PLACE_ITEM">
                                    <span class="place-badge must" onclick="cyclePlaceBadge(this)">MUST</span>
                                    <div class="place-text">
                                        <div class="place-name editable" data-limit="20" data-var="LUGAR_1">{{Lugar}}</div>
                                        <div style="font-size: 9px; color: var(--text-light);">
                                            <span class="editable" data-limit="15" data-var="CIUDAD_LUGAR_1">{{Ciudad}}</span> ‚Äî 
                                            <span class="editable" data-limit="30" data-var="DESC_LUGAR_1">{{Descripci√≥n breve}}</span>
                                        </div>
                                    </div>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                                
                                <div class="place-item component flow-item" data-component="PLACE_ITEM">
                                    <span class="place-badge eco" onclick="cyclePlaceBadge(this)">ECO</span>
                                    <div class="place-text">
                                        <div class="place-name editable" data-limit="20" data-var="LUGAR_2">{{Lugar}}</div>
                                        <div style="font-size: 9px; color: var(--text-light);">
                                            <span class="editable" data-limit="15" data-var="CIUDAD_LUGAR_2">{{Ciudad}}</span> ‚Äî 
                                            <span class="editable" data-limit="30" data-var="DESC_LUGAR_2">{{Descripci√≥n breve}}</span>
                                        </div>
                                    </div>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                                
                                <div class="place-item component flow-item" data-component="PLACE_ITEM">
                                    <span class="place-badge skip" onclick="cyclePlaceBadge(this)">SKIP</span>
                                    <div class="place-text">
                                        <div class="place-name editable" data-limit="20" data-var="LUGAR_3">{{Lugar}}</div>
                                        <div style="font-size: 9px; color: var(--text-light);">
                                            <span class="editable" data-limit="15" data-var="CIUDAD_LUGAR_3">{{Ciudad}}</span> ‚Äî 
                                            <span class="editable" data-limit="30" data-var="DESC_LUGAR_3">{{Descripci√≥n breve}}</span>
                                        </div>
                                    </div>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- LAYER: QUICK_TIPS -->
                        <div class="quick-tips flow-item">
                            <div class="section-header">
                                <div class="section-title">Consejos R√°pidos</div>
                                <div class="section-controls">
                                    <span class="item-counter" id="tipCounter">6/12 consejos</span>
                                    <button class="add-btn" onclick="addTip()" id="addTipBtn">+ Consejo</button>
                                </div>
                            </div>
                            
                            <div class="tips-grid" id="tipsList">
                                <div class="tip-item component flow-item" data-component="TIP_ITEM">
                                    <div class="tip-icon">üí∞</div>
                                    <span class="editable" data-limit="80" data-var="TIP_1">{{Consejo sobre dinero}}<span class="char-counter">0/80</span></span>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                                
                                <div class="tip-item component flow-item" data-component="TIP_ITEM">
                                    <div class="tip-icon">üöå</div>
                                    <span class="editable" data-limit="80" data-var="TIP_2">{{Consejo sobre transporte}}<span class="char-counter">0/80</span></span>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                                
                                <div class="tip-item component flow-item" data-component="TIP_ITEM">
                                    <div class="tip-icon">üîí</div>
                                    <span class="editable" data-limit="80" data-var="TIP_3">{{Consejo sobre seguridad}}<span class="char-counter">0/80</span></span>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                                
                                <div class="tip-item component flow-item" data-component="TIP_ITEM">
                                    <div class="tip-icon">üì±</div>
                                    <span class="editable" data-limit="80" data-var="TIP_4">{{Consejo sobre tecnolog√≠a}}<span class="char-counter">0/80</span></span>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                                
                                <div class="tip-item component flow-item" data-component="TIP_ITEM">
                                    <div class="tip-icon">üçΩÔ∏è</div>
                                    <span class="editable" data-limit="80" data-var="TIP_5">{{Consejo sobre comida}}<span class="char-counter">0/80</span></span>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                                
                                <div class="tip-item component flow-item" data-component="TIP_ITEM">
                                    <div class="tip-icon">‚ö°</div>
                                    <span class="editable" data-limit="80" data-var="TIP_6">{{Consejo general}}<span class="char-counter">0/80</span></span>
                                    <div class="component-controls">
                                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button>
                                        <button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LAYER: FOOTER - Master Footer -->
                <div class="master-footer">
                    <div>
                        <strong>Fecha de creaci√≥n:</strong> <span class="editable" data-limit="15" data-var="FECHA_CREACION">{{Fecha de creaci√≥n}}</span> | 
                        <strong>Cr√©ditos fotos:</strong> <span class="editable" data-limit="50" data-var="CREDITOS">{{Autores}}</span>
                    </div>
                    <div style="margin-top: 4px;">‚ö†Ô∏è Informaci√≥n aproximada ‚Äî verificar requisitos oficiales antes del viaje</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CORE SYSTEM VARIABLES =====
        let counters = {
            photos: 3,
            cities: 3,
            days: 3,
            places: 3,
            tips: 6,
            pages: 1 // Always 1 for single page
        };

        const limits = {
            photos: 7,
            cities: 12,
            days: 10,
            places: 12,
            tips: 12
        };

        // Undo system - stack of last 10 changes
        let undoStack = [];
        const MAX_UNDO = 10;
        
        // AUTO-EXTEND FUNCTIONS - Auto-extend system instead of pagination
        let autoExtendEnabled = true;

        // ===== AUTO-EXTEND FUNCTIONS =====
        
        // Convert mm to pixels (96 DPI standard)
        function mmToPx(mm) {
            return mm * (96 / 25.4);
        }

        // Check if element fits in current page without creating new pages
        function elementFitsInPage(el) {
            const page = document.querySelector('.page');
            const pageContent = page.querySelector('.page-content');
            
            // Compute used height inside page-content
            const used = Array.from(pageContent.children).reduce((h, child) => {
                return h + child.offsetHeight + parseFloat(getComputedStyle(child).marginBottom || 0);
            }, 0);
            
            const safePx = mmToPx(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-margin')));
            const available = Math.max(pageContent.clientHeight, mmToPx(297) - safePx * 2);
            
            return used <= available;
        }

        // Expand page to fit content instead of creating new pages
        function expandPageToFit() {
            const page = document.querySelector('.page');
            
            // Let content determine height
            page.style.height = 'auto';
            
            // Optionally increase min-height if very short
            page.style.minHeight = '297mm';
            
            // Update UI indicators
            counters.pages = 1;
            updatePageCounters();
            
            console.log('üìè P√°gina expandida autom√°ticamente para ajustar contenido');
        }

        // Clear IDs from cloned elements to avoid duplicates
        function clearIDs(clone) {
            // Remove id from all nodes in the clone
            clone.querySelectorAll('[id]').forEach(el => {
                el.removeAttribute('id');
            });
            
            // Use data-* attributes for templates instead
            if (clone.dataset.component) {
                clone.dataset.cloned = 'true';
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeTemplate();
            loadFromLocalStorage();
            setupEventListeners();
            console.log('üéØ Plantilla P√°gina √önica Din√°mica Canva Code cargada correctamente');
        });

        function initializeTemplate() {
            // Initialize all editable elements
            document.querySelectorAll('.editable').forEach(setupEditableElement);
            
            // Initialize drag and drop for photos
            setupPhotoDragDrop();
            
            // Initialize map pins dragging
            setupMapPins();
            
            // Initialize cost rating circles
            setupCostRating();
            
            // Update all counters
            updateAllCounters();
            
            // Initial page expansion check
            setTimeout(() => {
                expandPageToFit();
                checkOverflow();
            }, 100);
        }

        // Toggle auto-extend functionality
        function toggleAutoExtend() {
            autoExtendEnabled = !autoExtendEnabled;
            const btn = document.getElementById('autoExtendBtn');
            
            if (autoExtendEnabled) {
                btn.textContent = 'üìè Auto-extendido ON';
                btn.classList.add('active');
                // Trigger immediate expansion if enabled
                setTimeout(() => {
                    expandPageToFit();
                    checkOverflow();
                }, 100);
            } else {
                btn.textContent = 'üìè Auto-extendido OFF';
                btn.classList.remove('active');
                // Show compact button when auto-extend is off
                document.getElementById('compactBtn').style.display = 'block';
            }
            
            console.log(`üìè Auto-extendido ${autoExtendEnabled ? 'activado' : 'desactivado'}`);
        }

        // Compact layout by reducing gaps
        function compactLayout() {
            document.body.classList.add('compact-mode');
            
            // Reduce gaps using CSS variables
            document.documentElement.style.setProperty('--gap', '8px');
            
            // Hide compact button after use
            document.getElementById('compactBtn').style.display = 'none';
            
            // Re-check after compacting
            setTimeout(() => {
                expandPageToFit();
                checkOverflow();
            }, 200);
            
            console.log('üìê Layout compactado para optimizar espacio');
        }

        // ADD LOGO SLOT - Logo upload functionality
        function uploadLogo(logoSlot) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = logoSlot.querySelector('img');
                        const placeholder = logoSlot.querySelector('.logo-placeholder');
                        
                        img.src = event.target.result;
                        img.style.display = 'block';
                        placeholder.style.display = 'none';
                        logoSlot.classList.add('has-logo');
                        
                        console.log('üé® Logo cargado correctamente');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function setupEventListeners() {
            // Auto-save every 30 seconds
            setInterval(autosaveJSON, 30000);
            
            // Window resize handler
            window.addEventListener('resize', debounce(() => {
                expandPageToFit();
                checkOverflow();
            }, 300));
        }

        // ===== EDITABLE SYSTEM WITH CHARACTER LIMITS =====
        function setupEditableElement(element) {
            const limit = parseInt(element.dataset.limit) || 100;
            
            element.addEventListener('click', function() {
                saveState(); // Save state before editing
                this.contentEditable = true;
                this.focus();
                this.style.background = 'rgba(255, 107, 97, 0.3)';
                updateCharCounter(this);
            });

            element.addEventListener('input', function() {
                updateCharCounter(this);
                enforceLimit(this, limit);
                // REMOVE PAGINATION - Use expandPageToFit instead of flowToNextPage
                debounce(() => {
                    expandPageToFit();
                    checkOverflow();
                }, 500)();
            });

            element.addEventListener('blur', function() {
                this.contentEditable = false;
                this.style.background = 'rgba(255, 107, 97, 0.1)';
                autosaveJSON(); // Auto-save on blur
            });

            element.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.blur();
                }
            });

            // Initialize character counter
            updateCharCounter(element);
        }

        function updateCharCounter(element) {
            const counter = element.querySelector('.char-counter');
            if (counter) {
                const limit = parseInt(element.dataset.limit) || 100;
                const current = element.textContent.replace(/\d+\/\d+/, '').trim().length;
                counter.textContent = `${current}/${limit}`;
                counter.className = current > limit ? 'char-counter warning' : 'char-counter';
                
                // Add overflow warning if text is too long
                if (current > limit) {
                    element.classList.add('overflow-warning');
                } else {
                    element.classList.remove('overflow-warning');
                }
            }
        }

        function enforceLimit(element, limit) {
            const counter = element.querySelector('.char-counter');
            let text = element.textContent;
            
            if (counter) {
                text = text.replace(/\d+\/\d+/, '').trim();
            }
            
            if (text.length > limit) {
                const truncated = text.substring(0, limit);
                if (counter) {
                    element.innerHTML = truncated + counter.outerHTML;
                } else {
                    element.textContent = truncated;
                }
                
                // Show truncation indicator
                showTruncationWarning(element);
            }
        }

        function showTruncationWarning(element) {
            // Add visual indicator for truncated content
            if (!element.querySelector('.truncated-indicator')) {
                const indicator = document.createElement('span');
                indicator.className = 'truncated-indicator';
                indicator.innerHTML = ' <span class="read-more" onclick="expandToNotes(this)">...m√°s</span>';
                element.appendChild(indicator);
            }
        }

        function expandToNotes(readMoreBtn) {
            alert('Texto demasiado largo. Considera reducir el contenido o usar el modo compacto.');
        }

        // ===== COMPONENT MANAGEMENT =====
        
        function duplicateComponent(button) {
            saveState(); // Save state before action
            
            const component = button.closest('.component');
            const componentType = component.dataset.component;
            
            // Check limits
            const sectionLimits = {
                'ITINERARY_CARD': 'days',
                'PLACE_ITEM': 'places',
                'TIP_ITEM': 'tips',
                'CITY_ITEM': 'cities',
                'PHOTO_FRAME': 'photos'
            };
            
            const limitKey = sectionLimits[componentType];
            if (limitKey && counters[limitKey] >= limits[limitKey]) {
                alert(`M√°ximo ${limits[limitKey]} elementos permitidos`);
                return;
            }
            
            const clone = component.cloneNode(true);
            
            // Clear IDs to avoid duplicates
            clearIDs(clone);
            
            // Update any numbering or content
            updateClonedComponent(clone, componentType);
            
            // Insert clone
            component.parentElement.insertBefore(clone, component.nextSibling);
            
            // Update counter
            if (limitKey) {
                counters[limitKey]++;
                updateCounterDisplay(limitKey);
            }
            
            // Setup editable elements in clone
            clone.querySelectorAll('.editable').forEach(setupEditableElement);
            
            // Add animation
            clone.classList.add('fade-in');
            
            // REMOVE PAGINATION - Use expandPageToFit instead of flowToNextPage
            setTimeout(() => {
                expandPageToFit();
                checkOverflow();
            }, 100);
        }

        function deleteComponent(button) {
            saveState(); // Save state before action
            
            const component = button.closest('.component');
            const componentType = component.dataset.component;
            
            // Prevent deletion if it's the last one
            const siblings = component.parentElement.querySelectorAll(`[data-component="${componentType}"]`);
            if (siblings.length <= 1) {
                alert('Debe mantener al menos un elemento');
                return;
            }
            
            // Add animation before removal
            component.style.transition = 'all 0.3s ease';
            component.style.opacity = '0';
            component.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                component.remove();
                
                // Update counter
                const sectionLimits = {
                    'ITINERARY_CARD': 'days',
                    'PLACE_ITEM': 'places',
                    'TIP_ITEM': 'tips',
                    'CITY_ITEM': 'cities',
                    'PHOTO_FRAME': 'photos'
                };
                
                const limitKey = sectionLimits[componentType];
                if (limitKey) {
                    counters[limitKey]--;
                    updateCounterDisplay(limitKey);
                }
                
                reindexCounters();
                // REMOVE PAGINATION - Use expandPageToFit instead of checkOverflow
                expandPageToFit();
                checkOverflow();
            }, 300);
        }

        function updateClonedComponent(clone, componentType) {
            // Update specific component types
            if (componentType === 'CITY_ITEM') {
                const number = clone.querySelector('div[style*="background: var(--teal-primary)"]');
                if (number) {
                    number.textContent = counters.cities + 1;
                }
            }
            
            if (componentType === 'ITINERARY_CARD') {
                const dayTitle = clone.querySelector('.day-title .editable');
                if (dayTitle) {
                    dayTitle.innerHTML = `{{D√≠a ${counters.days + 1}: Ciudad}}<span class="char-counter">0/20</span>`;
                }
            }
            
            // Clear editable content
            clone.querySelectorAll('.editable').forEach(el => {
                const placeholder = el.dataset.var || 'Nuevo elemento';
                const counter = el.querySelector('.char-counter');
                el.innerHTML = `{{${placeholder}}}` + (counter ? counter.outerHTML : '');
            });
        }

        function updateCounterDisplay(type) {
            const counterMappings = {
                'days': 'dayCounter',
                'places': 'placeCounter',
                'tips': 'tipCounter',
                'cities': 'cityCounter',
                'photos': 'photoCounter'
            };
            
            const counterId = counterMappings[type];
            const counterEl = document.getElementById(counterId);
            
            if (counterEl) {
                const maxLimit = limits[type];
                counterEl.textContent = `${counters[type]}/${maxLimit} ${getTypeLabel(type)}`;
                
                // Update button state
                const addBtnId = `add${type.charAt(0).toUpperCase() + type.slice(1, -1)}Btn`;
                const addBtn = document.getElementById(addBtnId);
                if (addBtn) {
                    addBtn.disabled = counters[type] >= maxLimit;
                }
            }
        }

        function getTypeLabel(type) {
            const labels = {
                'days': 'd√≠as',
                'places': 'lugares',
                'tips': 'consejos',
                'cities': 'ciudades',
                'photos': 'fotos'
            };
            return labels[type] || type;
        }

        function updateAllCounters() {
            Object.keys(counters).forEach(type => {
                if (type !== 'pages') {
                    updateCounterDisplay(type);
                }
            });
            updatePageCounters();
        }

        function updatePageCounters() {
            // Always show "P√°gina 1 de 1" for single page
            document.querySelectorAll('.total-pages').forEach(el => {
                el.textContent = '1';
            });
            
            document.querySelectorAll('.page-number').forEach(el => {
                el.textContent = '1';
            });
            
            // Update control panel
            const pageCountEl = document.getElementById('pageCount');
            if (pageCountEl) {
                pageCountEl.textContent = 'P√°gina 1 de 1';
            }
            
            counters.pages = 1;
        }

        // ===== ADD FUNCTIONS =====
        
        function addItineraryDay() {
            if (counters.days >= limits.days) {
                alert(`M√°ximo ${limits.days} d√≠as permitidos`);
                return;
            }
            
            saveState();
            
            const container = document.querySelector('#itineraryList');
            const template = container.querySelector('.itinerary-card').cloneNode(true);
            
            // Clear IDs
            clearIDs(template);
            
            // Update content
            template.querySelector('.editable[data-var*="DIA"]').innerHTML = `{{D√≠a ${counters.days + 1}: Ciudad}}<span class="char-counter">0/20</span>`;
            template.querySelector('.day-activity').innerHTML = `{{Actividad del d√≠a ${counters.days + 1}}}<span class="char-counter">0/120</span>`;
            
            container.appendChild(template);
            counters.days++;
            updateCounterDisplay('days');
            
            // Setup editable elements
            template.querySelectorAll('.editable').forEach(setupEditableElement);
            template.classList.add('fade-in');
            
            // REMOVE PAGINATION - Use expandPageToFit instead of flowToNextPage
            setTimeout(() => {
                expandPageToFit();
                checkOverflow();
            }, 100);
        }

        function addPlace() {
            if (counters.places >= limits.places) {
                alert(`M√°ximo ${limits.places} lugares permitidos`);
                return;
            }
            
            saveState();
            
            const container = document.querySelector('#placesList');
            const template = container.querySelector('.place-item').cloneNode(true);
            
            // Clear IDs
            clearIDs(template);
            
            // Update content
            template.querySelector('.place-name').innerHTML = `{{Lugar ${counters.places + 1}}}`;
            template.querySelectorAll('.editable')[1].innerHTML = `{{Ciudad}}`;
            template.querySelectorAll('.editable')[2].innerHTML = `{{Descripci√≥n}}`;
            
            container.appendChild(template);
            counters.places++;
            updateCounterDisplay('places');
            
            // Setup editable elements
            template.querySelectorAll('.editable').forEach(setupEditableElement);
            template.classList.add('fade-in');
            
            // REMOVE PAGINATION - Use expandPageToFit instead of flowToNextPage
            setTimeout(() => {
                expandPageToFit();
                checkOverflow();
            }, 100);
        }

        function addTip() {
            if (counters.tips >= limits.tips) {
                alert(`M√°ximo ${limits.tips} consejos permitidos`);
                return;
            }
            
            saveState();
            
            const container = document.querySelector('#tipsList');
            const template = container.querySelector('.tip-item').cloneNode(true);
            
            // Clear IDs
            clearIDs(template);
            
            // Update content
            template.querySelector('.editable').innerHTML = `{{Consejo ${counters.tips + 1}}}<span class="char-counter">0/80</span>`;
            
            container.appendChild(template);
            counters.tips++;
            updateCounterDisplay('tips');
            
            // Setup editable elements
            template.querySelectorAll('.editable').forEach(setupEditableElement);
            template.classList.add('fade-in');
            
            // REMOVE PAGINATION - Use expandPageToFit instead of flowToNextPage
            setTimeout(() => {
                expandPageToFit();
                checkOverflow();
            }, 100);
        }

        function addCity() {
            if (counters.cities >= limits.cities) {
                alert(`M√°ximo ${limits.cities} ciudades permitidas`);
                return;
            }
            
            saveState();
            
            const container = document.querySelector('#citiesList');
            const template = container.querySelector('[data-component="CITY_ITEM"]').cloneNode(true);
            
            // Clear IDs
            clearIDs(template);
            
            // Update content
            template.querySelector('div[style*="background: var(--teal-primary)"]').textContent = counters.cities + 1;
            template.querySelector('.editable').innerHTML = `{{Ciudad ${counters.cities + 1} ‚Äî descripci√≥n}}`;
            
            container.appendChild(template);
            counters.cities++;
            updateCounterDisplay('cities');
            
            // Add new map pin
            addMapPin(counters.cities);
            
            // Setup editable elements
            template.querySelectorAll('.editable').forEach(setupEditableElement);
            template.classList.add('fade-in');
            
            // REMOVE PAGINATION - Use expandPageToFit instead of flowToNextPage
            setTimeout(() => {
                expandPageToFit();
                checkOverflow();
            }, 100);
        }

        function addPhoto() {
            if (counters.photos >= limits.photos) {
                alert(`M√°ximo ${limits.photos} fotos permitidas`);
                return;
            }
            
            saveState();
            
            const container = document.querySelector('#photoGrid');
            const template = container.querySelector('.photo-frame').cloneNode(true);
            
            // Clear IDs
            clearIDs(template);
            
            // Update content
            template.dataset.frame = `IMG_${counters.photos}`;
            template.querySelector('.photo-placeholder').innerHTML = `üì∑ IMG_${counters.photos}<br><small>Drag & Drop</small>`;
            
            // Reset photo state
            template.style.backgroundImage = '';
            template.classList.remove('has-image');
            const title = template.querySelector('.photo-title');
            if (title) title.remove();
            
            container.appendChild(template);
            counters.photos++;
            updateCounterDisplay('photos');
            
            // Setup drag and drop
            setupPhotoDragDropSingle(template);
            template.classList.add('fade-in');
            
            // REMOVE PAGINATION - Use expandPageToFit instead
            setTimeout(() => {
                expandPageToFit();
            }, 100);
        }

        function addMapPin(number) {
            const mapContainer = document.querySelector('.map-container');
            const pin = document.createElement('div');
            pin.className = 'map-pin component';
            pin.dataset.component = 'MAP_PIN';
            pin.dataset.pin = number;
            pin.textContent = number;
            
            // Random position
            const randomTop = Math.random() * 60 + 20; // 20-80%
            const randomLeft = Math.random() * 60 + 20; // 20-80%
            pin.style.top = randomTop + '%';
            pin.style.left = randomLeft + '%';
            
            mapContainer.appendChild(pin);
            setupMapPinSingle(pin);
        }

        // ===== PHOTO MANAGEMENT =====
        
        function setupPhotoDragDrop() {
            document.querySelectorAll('.photo-frame').forEach(setupPhotoDragDropSingle);
        }

        function setupPhotoDragDropSingle(frame) {
            frame.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--teal-primary)';
            });

            frame.addEventListener('dragleave', function(e) {
                this.style.borderColor = '#ccc';
            });

            frame.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ccc';
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    loadImageToFrame(this, files[0]);
                }
            });

            frame.addEventListener('click', function() {
                if (!this.classList.contains('has-image')) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (e) => {
                        if (e.target.files[0]) {
                            loadImageToFrame(this, e.target.files[0]);
                        }
                    };
                    input.click();
                }
            });
        }

        function loadImageToFrame(frame, file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                frame.style.backgroundImage = `url(${e.target.result})`;
                frame.style.backgroundSize = 'cover';
                frame.style.backgroundPosition = 'center';
                frame.classList.add('has-image');
                
                // Hide placeholder
                const placeholder = frame.querySelector('.photo-placeholder');
                if (placeholder) placeholder.style.display = 'none';
                
                // Add photo title if not exists
                let title = frame.querySelector('.photo-title');
                if (!title) {
                    title = document.createElement('div');
                    title.className = 'photo-title editable';
                    title.dataset.limit = '20';
                    title.textContent = file.name.split('.')[0];
                    frame.appendChild(title);
                    setupEditableElement(title);
                }
                
                // REMOVE PAGINATION - Use expandPageToFit instead of checkOverflow
                setTimeout(() => {
                    expandPageToFit();
                }, 100);
            };
            reader.readAsDataURL(file);
        }

        function changePhoto(button) {
            const frame = button.closest('.photo-frame');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    loadImageToFrame(frame, file);
                }
            };
            input.click();
        }

        function removePhoto(button) {
            const frame = button.closest('.photo-frame');
            frame.style.backgroundImage = '';
            frame.classList.remove('has-image');
            
            const title = frame.querySelector('.photo-title');
            if (title) title.remove();
            
            const placeholder = frame.querySelector('.photo-placeholder');
            if (placeholder) placeholder.style.display = 'block';
        }

        // ===== MAP PIN MANAGEMENT =====
        
        function setupMapPins() {
            document.querySelectorAll('.map-pin').forEach(setupMapPinSingle);
        }

        function setupMapPinSingle(pin) {
            let isDragging = false;
            let startX, startY, startLeft, startTop;

            pin.addEventListener('mousedown', function(e) {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                
                const rect = this.getBoundingClientRect();
                const containerRect = this.parentElement.getBoundingClientRect();
                startLeft = ((rect.left - containerRect.left) / containerRect.width) * 100;
                startTop = ((rect.top - containerRect.top) / containerRect.height) * 100;
                
                this.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                const containerRect = pin.parentElement.getBoundingClientRect();
                
                const newLeft = startLeft + (deltaX / containerRect.width) * 100;
                const newTop = startTop + (deltaY / containerRect.height) * 100;
                
                // Constrain to container bounds
                const constrainedLeft = Math.max(5, Math.min(95, newLeft));
                const constrainedTop = Math.max(5, Math.min(95, newTop));
                
                pin.style.left = constrainedLeft + '%';
                pin.style.top = constrainedTop + '%';
            });

            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    pin.style.cursor = 'move';
                }
            });
        }

        // ===== COST RATING SYSTEM =====
        
        function setupCostRating() {
            document.querySelectorAll('.cost-circle').forEach((circle, index) => {
                circle.addEventListener('click', function() {
                    saveState();
                    
                    const circles = this.parentElement.querySelectorAll('.cost-circle');
                    const value = index + 1;
                    
                    circles.forEach((c, i) => {
                        if (i < value) {
                            c.classList.remove('empty');
                        } else {
                            c.classList.add('empty');
                        }
                    });
                    
                    // Update cost text
                    const costText = this.parentElement.parentElement.querySelector('.cost-text');
                    const labels = ['Muy barato', 'Barato', 'Moderado', 'Caro', 'Muy caro'];
                    costText.textContent = `${value}/5 ‚Äî ${labels[value-1]}`;
                });
            });
        }

        // ===== BADGE CYCLING =====
        
        function cyclePlaceBadge(badge) {
            saveState();
            
            const types = ['must', 'skip', 'eco', 'family'];
            const labels = ['MUST', 'SKIP', 'ECO', 'FAMILY'];
            const currentIndex = types.findIndex(type => badge.classList.contains(type));
            const nextIndex = (currentIndex + 1) % types.length;
            
            badge.className = `place-badge ${types[nextIndex]}`;
            badge.textContent = labels[nextIndex];
        }

        // ===== OVERFLOW CHECKING =====
        
        // Enhanced checkOverflow for single page - mark items but don't move them
        function checkOverflow() {
            // Check all elements for visual overflow warnings
            const allElements = document.querySelectorAll('.flow-item, .component');
            let hasOverflow = false;
            
            allElements.forEach(item => {
                // Simple visual check - if element is very tall or causes scroll
                const rect = item.getBoundingClientRect();
                const pageRect = document.querySelector('.page').getBoundingClientRect();
                
                if (rect.bottom > pageRect.bottom + 100) { // 100px tolerance
                    item.classList.add('overflow-warning');
                    hasOverflow = true;
                    
                    // Add overflow indicator
                    if (!item.querySelector('.overflow-indicator')) {
                        const indicator = document.createElement('div');
                        indicator.className = 'overflow-indicator';
                        indicator.textContent = '!';
                        indicator.title = 'Elemento puede estar fuera del √°rea visible';
                        item.appendChild(indicator);
                    }
                } else {
                    item.classList.remove('overflow-warning');
                    const indicator = item.querySelector('.overflow-indicator');
                    if (indicator) indicator.remove();
                }
            });
            
            // Show compact button if there's overflow and auto-extend is off
            if (hasOverflow && !autoExtendEnabled) {
                document.getElementById('compactBtn').style.display = 'block';
            }
        }

        function reindexCounters() {
            // Reasigna numeraci√≥n de d√≠as, pins y actualiza etiquetas
            
            // Update day numbers
            const dayCards = document.querySelectorAll('[data-component="ITINERARY_CARD"]');
            dayCards.forEach((card, index) => {
                const dayTitle = card.querySelector('.day-title .editable');
                if (dayTitle) {
                    const currentText = dayTitle.textContent.replace(/D√≠a \d+/, `D√≠a ${index + 1}`);
                    dayTitle.textContent = currentText;
                }
            });
            
            // Update city numbers
            const cityItems = document.querySelectorAll('[data-component="CITY_ITEM"]');
            cityItems.forEach((item, index) => {
                const numberEl = item.querySelector('div[style*="background: var(--teal-primary)"]');
                if (numberEl) {
                    numberEl.textContent = index + 1;
                }
            });
            
            // Update map pins
            const mapPins = document.querySelectorAll('[data-component="MAP_PIN"]');
            mapPins.forEach((pin, index) => {
                pin.textContent = index + 1;
                pin.dataset.pin = index + 1;
            });
        }

        // ===== UNDO SYSTEM =====
        
        function saveState() {
            const state = serializeTemplate();
            undoStack.push(JSON.stringify(state));
            
            // Keep only last MAX_UNDO states
            if (undoStack.length > MAX_UNDO) {
                undoStack.shift();
            }
            
            // Enable undo button
            const undoBtn = document.getElementById('undoBtn');
            if (undoBtn) {
                undoBtn.disabled = false;
            }
        }

        function undo() {
            if (undoStack.length === 0) return;
            
            const previousState = undoStack.pop();
            if (previousState) {
                restoreTemplate(JSON.parse(previousState));
                
                // Disable undo button if no more states
                const undoBtn = document.getElementById('undoBtn');
                if (undoBtn && undoStack.length === 0) {
                    undoBtn.disabled = true;
                }
                
                console.log('‚Ü∂ Estado anterior restaurado');
            }
        }

        // ===== AUTOSAVE SYSTEM =====
        
        function autosaveJSON() {
            try {
                const templateData = serializeTemplate();
                localStorage.setItem('canva_travel_template_single', JSON.stringify(templateData));
                
                // Update status indicator
                const statusDot = document.getElementById('saveStatus');
                const statusText = document.getElementById('saveText');
                if (statusDot && statusText) {
                    statusDot.className = 'status-dot';
                    statusText.textContent = 'Guardado';
                }
                
                console.log('üíæ Template auto-guardado en localStorage');
            } catch (error) {
                console.error('Error al guardar:', error);
                
                // Update status indicator
                const statusDot = document.getElementById('saveStatus');
                const statusText = document.getElementById('saveText');
                if (statusDot && statusText) {
                    statusDot.className = 'status-dot error';
                    statusText.textContent = 'Error';
                }
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('canva_travel_template_single');
                if (saved) {
                    const templateData = JSON.parse(saved);
                    restoreTemplate(templateData);
                    console.log('üìÇ Template cargado desde localStorage');
                }
            } catch (error) {
                console.error('Error al cargar:', error);
            }
        }

        function serializeTemplate() {
            const data = {
                version: '3.1-single',
                timestamp: new Date().toISOString(),
                counters: { ...counters },
                autoExtendEnabled: autoExtendEnabled,
                editableContent: {},
                images: {},
                components: {}
            };
            
            // Serialize editable content
            document.querySelectorAll('.editable').forEach(el => {
                const varName = el.dataset.var || `editable_${Date.now()}_${Math.random()}`;
                data.editableContent[varName] = el.textContent.replace(/\d+\/\d+/, '').trim();
            });
            
            // Serialize images
            document.querySelectorAll('.photo-frame.has-image').forEach(frame => {
                const frameId = frame.dataset.frame || `img_${Date.now()}`;
                data.images[frameId] = {
                    backgroundImage: frame.style.backgroundImage,
                    title: frame.querySelector('.photo-title')?.textContent || ''
                };
            });
            
            // Serialize logo
            const logoImg = document.querySelector('.logo-slot img');
            if (logoImg && logoImg.src) {
                data.logo = logoImg.src;
            }
            
            // Serialize component states
            document.querySelectorAll('.cost-circle:not(.empty)').forEach((circle, index) => {
                data.components.costRating = index + 1;
            });
            
            return data;
        }

        function restoreTemplate(data) {
            if (!data || !data.version || !data.version.includes('3')) {
                console.warn('Versi√≥n de template incompatible');
                return;
            }
            
            // Restore counters
            counters = { ...data.counters };
            
            // Restore auto-extend setting
            if (data.autoExtendEnabled !== undefined) {
                autoExtendEnabled = data.autoExtendEnabled;
                const btn = document.getElementById('autoExtendBtn');
                if (btn) {
                    btn.textContent = autoExtendEnabled ? 'üìè Auto-extendido ON' : 'üìè Auto-extendido OFF';
                    btn.classList.toggle('active', autoExtendEnabled);
                }
            }
            
            // Restore editable content
            Object.entries(data.editableContent).forEach(([varName, content]) => {
                const element = document.querySelector(`[data-var="${varName}"]`);
                if (element) {
                    const counter = element.querySelector('.char-counter');
                    element.innerHTML = content + (counter ? counter.outerHTML : '');
                }
            });
            
            // Restore images
            Object.entries(data.images).forEach(([frameId, imageData]) => {
                const frame = document.querySelector(`[data-frame="${frameId}"]`);
                if (frame) {
                    frame.style.backgroundImage = imageData.backgroundImage;
                    frame.classList.add('has-image');
                    
                    const placeholder = frame.querySelector('.photo-placeholder');
                    if (placeholder) placeholder.style.display = 'none';
                    
                    if (imageData.title) {
                        let title = frame.querySelector('.photo-title');
                        if (!title) {
                            title = document.createElement('div');
                            title.className = 'photo-title editable';
                            frame.appendChild(title);
                        }
                        title.textContent = imageData.title;
                    }
                }
            });
            
            // Restore logo
            if (data.logo) {
                const logoSlot = document.querySelector('.logo-slot');
                const img = logoSlot.querySelector('img');
                const placeholder = logoSlot.querySelector('.logo-placeholder');
                
                img.src = data.logo;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                logoSlot.classList.add('has-logo');
            }
            
            // Restore component states
            if (data.components.costRating) {
                const circles = document.querySelectorAll('.cost-circle');
                circles.forEach((circle, index) => {
                    if (index < data.components.costRating) {
                        circle.classList.remove('empty');
                    } else {
                        circle.classList.add('empty');
                    }
                });
            }
            
            // Re-initialize
            updateAllCounters();
            document.querySelectorAll('.editable').forEach(setupEditableElement);
            setTimeout(() => {
                expandPageToFit();
            }, 100);
        }

        // ===== EXPORT FUNCTIONS =====
        
        function exportTemplate(format) {
            switch (format) {
                case 'A4':
                    exportA4PDF();
                    break;
                case 'SOCIAL':
                    exportSocialFormats();
                    break;
                default:
                    console.log('Formato no soportado:', format);
            }
        }

        function exportA4PDF() {
            // Hide controls for clean export
            document.querySelectorAll('.component-controls, .add-btn, .control-panel').forEach(el => {
                el.style.display = 'none';
            });
            
            // Trigger print dialog
            window.print();
            
            // Restore controls after print
            setTimeout(() => {
                document.querySelectorAll('.component-controls, .add-btn, .control-panel').forEach(el => {
                    el.style.display = '';
                });
            }, 1000);
        }

        function exportSocialFormats() {
            alert('Exportaci√≥n a formatos sociales (1080x1350, 1080x1920) disponible en Canva. Usa "Descargar" en el editor para obtener PNG de alta calidad.');
        }

        // ===== CONTROL PANEL FUNCTIONS =====
        
        function toggleHelp() {
            alert(`üéØ GU√çA DE USO - Plantilla P√°gina √önica Din√°mica V3.1

üìù EDITAR TEXTO:
‚Ä¢ Haz clic en cualquier texto con borde punteado
‚Ä¢ L√≠mites: T√≠tulo 30 chars, Descripci√≥n 120 chars
‚Ä¢ Presiona Enter para guardar

üñºÔ∏è IM√ÅGENES Y LOGO:
‚Ä¢ Haz clic o arrastra im√°genes a los marcos
‚Ä¢ Hero: ratio 3:1, Minis: ratio 1:1
‚Ä¢ Logo: Haz clic en "LOGO" en el header
‚Ä¢ Formatos: JPG/PNG sRGB recomendado

‚ûï A√ëADIR ELEMENTOS:
‚Ä¢ Usa botones "+ A√±adir" en cada secci√≥n
‚Ä¢ M√°ximos: 10 d√≠as, 12 lugares, 12 consejos
‚Ä¢ Hover sobre elementos para duplicar/eliminar

üìè P√ÅGINA DIN√ÅMICA:
‚Ä¢ Auto-extendido ON: La p√°gina se alarga autom√°ticamente
‚Ä¢ Auto-extendido OFF: Activa modo compacto con l√≠mites visuales
‚Ä¢ Bot√≥n "Compactar": Reduce espacios para optimizar
‚Ä¢ Sin paginaci√≥n: Todo en una sola p√°gina fluida

üéØ COMPONENTES INTERACTIVOS:
‚Ä¢ Calificaci√≥n: Haz clic en c√≠rculos (1-5)
‚Ä¢ Badges: Haz clic para cambiar tipo
‚Ä¢ Pins del mapa: Arrastra para reposicionar
‚Ä¢ Auto-extendido: Activa/desactiva expansi√≥n autom√°tica

üíæ GUARDADO:
‚Ä¢ Auto-guardado cada 30 segundos
‚Ä¢ Deshacer: hasta 10 acciones
‚Ä¢ Datos guardados en tu navegador

üîß FUNCIONES T√âCNICAS:
‚Ä¢ mmToPx(): Convierte mm a p√≠xeles
‚Ä¢ elementFitsInPage(): Verifica si elemento cabe
‚Ä¢ expandPageToFit(): Expande p√°gina autom√°ticamente
‚Ä¢ clearIDs(): Limpia IDs duplicados en clones
‚Ä¢ toggleAutoExtend(): Activa/desactiva auto-extensi√≥n

üöÄ NOVEDADES V3.1:
‚Ä¢ P√°gina √∫nica que se alarga autom√°ticamente
‚Ä¢ Logo slot con carga de im√°genes
‚Ä¢ Sin fragmentaci√≥n en m√∫ltiples p√°ginas
‚Ä¢ Modo compacto cuando auto-extendido est√° OFF
‚Ä¢ Optimizaci√≥n de espacios din√°micos`);
        }

        function togglePreview() {
            const isPreview = document.body.classList.toggle('preview-mode');
            
            document.querySelectorAll('.component-controls, .add-btn').forEach(el => {
                el.style.display = isPreview ? 'none' : '';
            });
            
            const btn = document.querySelector('.preview-btn');
            if (btn) {
                btn.textContent = isPreview ? '‚úèÔ∏è Editar' : 'üëÅÔ∏è Vista previa';
            }
        }

        // ===== UTILITY FUNCTIONS =====
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ===== CONSOLE WELCOME MESSAGE =====
        console.log(`
üéØ CANVA CODE - PLANTILLA P√ÅGINA √öNICA DIN√ÅMICA V3.1
====================================================

‚úÖ P√°gina √∫nica que se alarga autom√°ticamente
‚úÖ Logo slot con carga de im√°genes
‚úÖ Auto-extensi√≥n inteligente de contenido
‚úÖ L√≠mites de caracteres con truncamiento
‚úÖ Sistema de deshacer (10 niveles)
‚úÖ Auto-guardado cada 30s
‚úÖ Exportaci√≥n A4 PDF de p√°gina √∫nica
‚úÖ Componentes interactivos
‚úÖ Drag & drop para im√°genes y logo
‚úÖ Pins de mapa arrastrables
‚úÖ Conversi√≥n mm‚Üípx precisa
‚úÖ Modo compacto cuando auto-extendido OFF
‚úÖ Sin fragmentaci√≥n en m√∫ltiples p√°ginas

üìä L√çMITES ACTUALES:
‚Ä¢ Fotos: ${counters.photos}/${limits.photos}
‚Ä¢ Ciudades: ${counters.cities}/${limits.cities}
‚Ä¢ D√≠as: ${counters.days}/${limits.days}
‚Ä¢ Lugares: ${counters.places}/${limits.places}
‚Ä¢ Consejos: ${counters.tips}/${limits.tips}
‚Ä¢ P√°ginas: ${counters.pages} (siempre 1)
‚Ä¢ Auto-extendido: ${autoExtendEnabled ? 'ON' : 'OFF'}

üîß FUNCIONES DISPONIBLES:
‚Ä¢ mmToPx(mm) - Convertir mm a p√≠xeles
‚Ä¢ elementFitsInPage(el) - Verificar si elemento cabe en p√°gina
‚Ä¢ expandPageToFit() - Expandir p√°gina autom√°ticamente
‚Ä¢ clearIDs(clone) - Limpiar IDs duplicados
‚Ä¢ toggleAutoExtend() - Activar/desactivar auto-extensi√≥n
‚Ä¢ compactLayout() - Reducir espacios para compactar
‚Ä¢ uploadLogo(slot) - Cargar logo
‚Ä¢ autosaveJSON() - Guardar manualmente
‚Ä¢ undo() - Deshacer √∫ltima acci√≥n
‚Ä¢ checkOverflow() - Verificar desbordamiento visual
‚Ä¢ exportTemplate('A4') - Exportar PDF
‚Ä¢ togglePreview() - Alternar vista previa

üöÄ MEJORAS V3.1:
‚Ä¢ REMOVE PAGINATION: Sin creaci√≥n de p√°ginas m√∫ltiples
‚Ä¢ ADD LOGO SLOT: Slot para logo con funcionalidad completa
‚Ä¢ AUTO-EXTEND FUNCTIONS: Sistema de auto-extensi√≥n
‚Ä¢ P√°gina √∫nica fluida que se alarga seg√∫n contenido
‚Ä¢ Modo compacto opcional para optimizar espacio
‚Ä¢ IDs √∫nicos sin duplicaci√≥n en clones

¬°P√°gina √∫nica lista para usar! üéØ
        `);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97e6df5be54cbbba',t:'MTc1Nzc1ODQxMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
