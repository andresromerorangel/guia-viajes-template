<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plantilla Gu√≠a de Viaje V5.1 - CORREGIDO</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- ===== CONFIGURACI√ìN DE VARIABLES ===== -->
    <script>
        // üéØ CONFIGURACI√ìN PRINCIPAL - Esta es tu fuente de verdad
        const TEMPLATE_CONFIG = {
            // === INFORMACI√ìN B√ÅSICA ===
            pais: "Jap√≥n",
            nombre_pais: "Jap√≥n - Tierra del Sol Naciente",
            bandera_imagen: "",
            fechas: "Marzo - Mayo 2024",
            duracion: "14 d√≠as",
            coste_nivel: 2,
            moneda: "Yen (JPY)",
            costo_hospedaje: "$50-80/noche",
            costo_comida: "$15-30/d√≠a",
            costo_bebida: "$5-8/cerveza",
            idioma: "Japon√©s",
            religiones: "Sinto√≠smo, Budismo",
            fecha_creacion: "Enero 2024",
            creditos: "Fotos: @viajero_digital, Unsplash",
            
            // === PRESUPUESTO ===
            presupuesto_dia: "8,000 JPY (~$60 USD)",
            total_gastado: "112,000 JPY (~$840 USD)",
            
            // === CONFIGURACI√ìN DE MAPA ===
            mapa_tipo: "upload",
            mapa_url: "",
            mapa_enlace_google: "",
            
            // === CIUDADES ===
            ciudad1: "Tokio ‚Äî Capital moderna y tradicional",
            ciudad2: "Kioto ‚Äî Templos y cultura ancestral",
            ciudad3: "Osaka ‚Äî Gastronom√≠a y entretenimiento",
            
            // === ITINERARIO ===
            dia1: "Tokio - Shibuya",
            actividad1: "Explorar el famoso cruce de Shibuya, visitar el santuario Meiji y caminar por Harajuku.",
            
            dia2: "Tokio - Asakusa",
            actividad2: "Templo Sensoji, mercado Nakamise, crucero por el r√≠o Sumida.",
            
            dia3: "Tokio - Akihabara",
            actividad3: "Distrito electr√≥nico, tiendas de anime y manga.",
            
            dia4: "Viaje a Kioto",
            actividad4: "Viaje en Shinkansen. Paseo nocturno por Gion.",
            
            dia5: "Kioto - Templos",
            actividad5: "Kiyomizu-dera, bosque de bamb√∫ Arashiyama, Kinkaku-ji.",
            
            // === TOP LUGARES ===
            lugar1: "Templo Sensoji",
            ciudad_lugar1: "Tokio",
            desc_lugar1: "Templo budista m√°s antiguo de Tokio",
            tipo_lugar1: "must",
            
            lugar2: "Bosque de Bamb√∫",
            ciudad_lugar2: "Kioto", 
            desc_lugar2: "Sendero m√°gico entre bamb√∫es gigantes",
            tipo_lugar2: "eco",
            
            lugar3: "Shibuya Crossing",
            ciudad_lugar3: "Tokio",
            desc_lugar3: "El cruce peatonal m√°s famoso del mundo",
            tipo_lugar3: "must",
            
            lugar4: "Parque de Nara",
            ciudad_lugar4: "Nara",
            desc_lugar4: "Ciervos sagrados en libertad",
            tipo_lugar4: "family",
            
            // === CONSEJOS R√ÅPIDOS ===
            tip1: "Compra JR Pass antes de llegar - ahorro significativo",
            tip2: "Aprende frases b√°sicas en japon√©s",
            tip3: "Siempre lleva efectivo",
            tip4: "Descarga Google Translate con c√°mara",
            tip5: "Qu√≠tate los zapatos en templos",
            tip6: "No comas caminando",
            tip7: "Los trenes son puntuales",
            tip8: "Respeta las colas",
            
            // === IM√ÅGENES ===
            img_hero: "",
            img1: "",
            img2: "",
            img3: "",
            img4: "",
            img5: "",
            img6: "",
            
            // === LOGO ===
            logo: "",

            // === COLORES PERSONALIZABLES ===
            color_fondo: "#000000",
            color_primario: "#337653",
            color_secundario: "#1DAA2D",
            color_acento: "#EE3344",
            color_texto: "#2F3A3A",
            color_fondo_logo: "#FFFFFF",
        };

        // üîß FUNCI√ìN DE DETECCI√ìN AUTOM√ÅTICA
        function detectConfigCounts(config) {
            const counts = { ciudades: 0, dias: 0, lugares: 0, tips: 0, fotos: 0 };
            
            for (let key in config) {
                if (key.startsWith('ciudad') && /\d+$/.test(key) && !key.includes('_')) {
                    counts.ciudades = Math.max(counts.ciudades, parseInt(key.replace('ciudad', '')));
                }
                if (key.startsWith('dia') && /\d+$/.test(key)) {
                    counts.dias = Math.max(counts.dias, parseInt(key.replace('dia', '')));
                }
                if (key.startsWith('lugar') && /\d+$/.test(key)) {
                    counts.lugares = Math.max(counts.lugares, parseInt(key.replace('lugar', '')));
                }
                if (key.startsWith('tip') && /\d+$/.test(key)) {
                    counts.tips = Math.max(counts.tips, parseInt(key.replace('tip', '')));
                }
                if (key.startsWith('img') && /\d+$/.test(key)) {
                    counts.fotos = Math.max(counts.fotos, parseInt(key.replace('img', '')));
                }
            }
            return counts;
        }
        
        // üéØ INICIALIZACI√ìN PRINCIPAL
        function initializeFromConfig() {
            const config = TEMPLATE_CONFIG;
            const counts = detectConfigCounts(config);
            
            console.log('üéØ Inicializando V5.1 desde TEMPLATE_CONFIG:', counts);
            
            clearAllSections();
            applyCustomColors(config);
            updateBasicInfo(config);
            generateCities(config, counts.ciudades);
            generateDays(config, counts.dias);  
            generatePlaces(config, counts.lugares);
            generateTips(config, counts.tips);
            loadImages(config, counts.fotos);
            loadLogo(config);
            initializeMap(config);
            updateMapLink(config);
            
            counters.cities = counts.ciudades;
            counters.days = counts.dias;
            counters.places = counts.lugares; 
            counters.tips = counts.tips;
            counters.photos = counts.fotos + 1;
            
            reinitializeJS();
            
            console.log('‚úÖ Plantilla inicializada desde variables');
        }
        
        // üßπ LIMPIEZA COMPLETA DE SECCIONES
        function clearAllSections() {
            const citiesList = document.querySelector('#citiesList');
            if (citiesList) citiesList.innerHTML = '';
            
            const itineraryList = document.querySelector('#itineraryList');
            if (itineraryList) itineraryList.innerHTML = '';
            
            const placesList = document.querySelector('#placesList');
            if (placesList) placesList.innerHTML = '';
            
            const tipsList = document.querySelector('#tipsList');
            if (tipsList) tipsList.innerHTML = '';
            
            document.querySelectorAll('.map-pin').forEach(pin => pin.remove());
            
            console.log('üßπ Secciones limpiadas');
        }
        
        // üìù ACTUALIZAR INFORMACI√ìN B√ÅSICA
        function updateBasicInfo(config) {
            document.querySelector('[data-var="PAIS"]').textContent = config.pais;
            document.querySelector('[data-var="NOMBRE_PAIS"]').textContent = config.nombre_pais;
            document.querySelector('[data-var="FECHAS"]').textContent = config.fechas;
            document.querySelector('[data-var="DURACION"]').textContent = config.duracion;
            document.querySelector('[data-var="MONEDA"]').textContent = config.moneda;
            document.querySelector('[data-var="COSTO_HOSPEDAJE"]').textContent = config.costo_hospedaje;
            document.querySelector('[data-var="COSTO_COMIDA"]').textContent = config.costo_comida;
            document.querySelector('[data-var="IDIOMA"]').textContent = config.idioma;
            document.querySelector('[data-var="COSTO_BEBIDA"]').textContent = config.costo_bebida;
            document.querySelector('[data-var="RELIGIONES"]').textContent = config.religiones;
            document.querySelector('[data-var="FECHA_CREACION"]').textContent = config.fecha_creacion;
            document.querySelector('[data-var="CREDITOS"]').textContent = config.creditos;
            
            const flagContainer = document.querySelector('.flag-container');
            if (flagContainer && config.bandera_imagen) {
                const img = flagContainer.querySelector('img');
                const placeholder = flagContainer.querySelector('.flag-placeholder');
                if (img && placeholder) {
                    img.src = config.bandera_imagen;
                    img.style.display = 'block';
                    placeholder.style.display = 'none';
                    flagContainer.classList.add('has-flag');
                }
            }
            
            document.querySelector('[data-var="PRESUPUESTO_DIA"]').textContent = config.presupuesto_dia;
            document.querySelector('[data-var="TOTAL_GASTADO"]').textContent = config.total_gastado;
            
            if (config.coste_nivel) {
                const circles = document.querySelectorAll('.cost-circle');
                const labels = ['Muy barato', 'Barato', 'Moderado', 'Caro', 'Muy caro'];
                circles.forEach((circle, index) => {
                    if (index < config.coste_nivel) {
                        circle.classList.remove('empty');
                    } else {
                        circle.classList.add('empty'); 
                    }
                });
                document.querySelector('.cost-text').textContent = config.coste_nivel + '/5 ‚Äî ' + labels[config.coste_nivel-1];
            }
        }
        
        // üèôÔ∏è GENERAR CIUDADES
        function generateCities(config, count) {
            const container = document.querySelector('#citiesList');
            container.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const cityKey = 'ciudad' + i;
                if (config[cityKey]) {
                    const cityElement = createCityElement(i, config[cityKey]);
                    container.appendChild(cityElement);
                }
            }
            
            document.querySelector('#cityCounter').textContent = count + '/12 ciudades';
            regenerateMapPins(count, config);
        }
        
        function createCityElement(number, text) {
            const div = document.createElement('div');
            div.className = 'component flow-item';
            div.setAttribute('data-component', 'CITY_ITEM');
            div.style.cssText = 'display: flex; align-items: center; gap: 8px; font-size: 9px;';
            
            div.innerHTML = '<div style="width: 16px; height: 16px; background: var(--teal-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 600;">' + number + '</div><span class="editable" data-limit="500" data-var="CIUDAD_' + number + '">' + text + '</span><div class="component-controls"><button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button><button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button></div>';
            
            return div;
        }
        
        // üìÖ GENERAR D√çAS DE ITINERARIO
        function generateDays(config, count) {
            const container = document.querySelector('#itineraryList');
            container.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const dayKey = 'dia' + i;
                const activityKey = 'actividad' + i;
                if (config[dayKey]) {
                    const dayElement = createDayElement(i, config[dayKey], config[activityKey] || '');
                    container.appendChild(dayElement);
                }
            }
            
            document.querySelector('#dayCounter').textContent = count + '/10 d√≠as';
        }
        
        function createDayElement(number, dayText, activityText) {
            const div = document.createElement('div');
            div.className = 'itinerary-card component flow-item';
            div.setAttribute('data-component', 'ITINERARY_CARD');
            
            div.innerHTML = '<div class="day-title">üïê <span class="editable" data-limit="500" data-var="DIA_' + number + '">' + dayText + '</span></div><div class="day-activity editable" data-limit="500" data-var="ACTIVIDAD_' + number + '">' + activityText + '</div><div class="component-controls"><button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button><button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button></div>';
            
            return div;
        }
        
        // üìç GENERAR LUGARES
        function generatePlaces(config, count) {
            const container = document.querySelector('#placesList');
            container.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const lugarKey = 'lugar' + i;
                if (config[lugarKey]) {
                    const placeElement = createPlaceElement(i, config);
                    container.appendChild(placeElement);
                }
            }
            
            document.querySelector('#placeCounter').textContent = count + '/12 lugares';
        }
        
        function createPlaceElement(number, config) {
            const lugar = config['lugar' + number] || '';
            const ciudad = config['ciudad_lugar' + number] || '';
            const desc = config['desc_lugar' + number] || '';
            const tipo = config['tipo_lugar' + number] || 'must';
            
            const cat = PLACE_CATEGORIES[tipo] || PLACE_CATEGORIES['must'];
            const badgeContent = cat.emoji + ' ' + cat.label;
            const badgeColor = cat.color;
            
            const div = document.createElement('div');
            div.className = 'place-item component flow-item';
            div.setAttribute('data-component', 'PLACE_ITEM');
            
            div.innerHTML = '<span class="place-badge ' + tipo + '" onclick="cyclePlaceBadge(this)" style="background: ' + badgeColor + '">' + badgeContent + '</span><div class="place-text"><div class="place-name editable" data-limit="500" data-var="LUGAR_' + number + '">' + lugar + '</div><div style="font-size: 9px; color: var(--text-light);"><span class="editable" data-limit="500" data-var="CIUDAD_LUGAR_' + number + '">' + ciudad + '</span> ‚Äî <span class="editable" data-limit="500" data-var="DESC_LUGAR_' + number + '">' + desc + '</span></div></div><div class="component-controls"><button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button><button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button></div>';
            
            return div;
        }
        
        // üí° GENERAR CONSEJOS
        function generateTips(config, count) {
            const container = document.querySelector('#tipsList');
            container.innerHTML = '';
            
            const iconos = ['üí∞', 'üöå', 'üîí', 'üì±', 'üçΩÔ∏è', '‚ö°', 'üéØ', 'üìç', 'üó∫Ô∏è', '‚è∞', 'üéå', 'üçú'];
            
            for (let i = 1; i <= count; i++) {
                const tipKey = 'tip' + i;
                if (config[tipKey]) {
                    const tipElement = createTipElement(i, config[tipKey], iconos[i-1] || 'üí°');
                    container.appendChild(tipElement);
                }
            }
            
            document.querySelector('#tipCounter').textContent = count + '/12 consejos';
        }
        
        function createTipElement(number, text, icon) {
            const div = document.createElement('div');
            div.className = 'tip-item component flow-item';
            div.setAttribute('data-component', 'TIP_ITEM');
            
            div.innerHTML = '<div class="tip-icon">' + icon + '</div><span class="editable" data-limit="500" data-var="TIP_' + number + '">' + text + '</span><div class="component-controls"><button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button><button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button></div>';
            
            return div;
        }
        
        // üì∏ CARGAR IM√ÅGENES
        function loadImages(config, count) {
            if (config.img_hero) {
                loadImageToFrame(document.querySelector('[data-frame="IMG_HERO"]'), null, config.img_hero);
            }
            
            for (let i = 1; i <= count; i++) {
                const imgKey = 'img' + i;
                if (config[imgKey]) {
                    const frame = document.querySelector('[data-frame="IMG_' + i + '"]');
                    if (frame) {
                        loadImageToFrame(frame, null, config[imgKey]);
                    }
                }
            }
        }
        
        // üé® CARGAR LOGO
        function loadLogo(config) {
            if (config.logo) {
                const logoSlot = document.querySelector('.logo-slot');
                const img = logoSlot.querySelector('img');
                const placeholder = logoSlot.querySelector('.logo-placeholder');
                
                img.src = config.logo;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                logoSlot.classList.add('has-logo');
            }
        }

        // ===== FUNCIONES DE MAPA =====
        function initializeMap(config) {
            const mapType = config.mapa_tipo || 'static';
            
            switch(mapType) {
                case 'upload':
                    setupMapUpload();
                    break;
                case 'auto':
                    generateCountryMap(config.pais);
                    break;
                default:
                    setupStaticMap();
                    break;
            }
        }

        function updateMapLink(config) {
            const linkElement = document.getElementById('googleMapsLink');
            const linkText = linkElement.querySelector('.link-text');
    
            if (config.mapa_enlace_google && config.mapa_enlace_google.trim() !== '') {
                linkElement.href = config.mapa_enlace_google;
                linkElement.classList.add('has-link');
                const url = config.mapa_enlace_google;
                if (url.includes('google.com/maps')) {
                    linkText.textContent = 'üìç Abrir en Google My Maps';
                } else {
                    linkText.textContent = url.length > 40 ? url.substring(0, 40) + '...' : url;
                }
            } else {
                linkElement.href = '#';
                linkElement.classList.remove('has-link');
                linkText.textContent = 'Click para agregar enlace de Google My Maps';
            }
        }

        function editMapLink() {
            const currentLink = TEMPLATE_CONFIG.mapa_enlace_google || '';
            const newLink = prompt('üó∫Ô∏è Ingresa el enlace de Google My Maps:\n\nEnlace actual:', currentLink);
    
            if (newLink !== null) {
                TEMPLATE_CONFIG.mapa_enlace_google = newLink.trim();
                updateMapLink(TEMPLATE_CONFIG);
                if (newLink.trim() !== '') {
                    showToast('üó∫Ô∏è Enlace de mapa actualizado');
                } else {
                    showToast('üóëÔ∏è Enlace de mapa eliminado');
                }
            }
        }

        function handleMapLinkClick(element) {
            if (!element.classList.contains('has-link')) {
                editMapLink();
                return false;
            }
            return true;
        }
        
        function setupMapUpload() {
            const uploadBtn = document.getElementById('uploadMapBtn');
            if (uploadBtn) {
                uploadBtn.style.display = 'inline-flex';
                uploadBtn.onclick = uploadMapImage;
            }
        }
        
        function uploadMapImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const mapContainer = document.querySelector('.map-container');
                        const existingPins = Array.from(mapContainer.querySelectorAll('.map-pin'));
                        mapContainer.innerHTML = '';
                        
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.style.cssText = 'width: 100%; height: 100%; object-fit: contain; object-position: center;';
                        img.alt = 'Mapa personalizado';
                        
                        img.onload = function() {
                            const aspectRatio = this.naturalHeight / this.naturalWidth;
                            const containerWidth = mapContainer.offsetWidth;
                            const newHeight = containerWidth * aspectRatio;
                            mapContainer.style.height = Math.min(newHeight, 200) + 'px';
                        };
                        
                        mapContainer.appendChild(img);
                        mapContainer.classList.add('has-custom-map');
                        
                        setTimeout(function() {
                            existingPins.forEach(function(pin) {
                                mapContainer.appendChild(pin);
                            });
                        }, 100);
                        
                        TEMPLATE_CONFIG.mapa_url = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        function regenerateMapPins(count, config) {
            const mapContainer = document.querySelector('.map-container');
            mapContainer.querySelectorAll('.map-pin').forEach(function(pin) { pin.remove(); });
            
            const positions = [
                {top: '25%', left: '70%'},
                {top: '40%', left: '65%'},
                {top: '45%', left: '60%'},
                {top: '30%', left: '55%'},
                {top: '50%', left: '75%'},
            ];
            
            for (let i = 1; i <= count; i++) {
                const pin = document.createElement('div');
                pin.className = 'map-pin component';
                pin.setAttribute('data-component', 'MAP_PIN');
                pin.setAttribute('data-pin', i.toString());
                pin.textContent = i.toString();
                
                const position = positions[i-1] || {
                    top: (Math.random() * 60 + 20) + '%',
                    left: (Math.random() * 60 + 20) + '%'
                };
                
                pin.style.top = position.top;
                pin.style.left = position.left;
                
                mapContainer.appendChild(pin);
                setupMapPinSingle(pin);
            }
        }
        
        function autoPlacePins() {
            const pins = document.querySelectorAll('.map-pin');
            if (pins.length === 0) return;
            
            const positions = [
                {top: '25%', left: '70%'},
                {top: '40%', left: '65%'},
                {top: '45%', left: '60%'},
                {top: '30%', left: '55%'},
                {top: '50%', left: '75%'},
            ];
            
            pins.forEach(function(pin, index) {
                setTimeout(function() {
                    const pos = positions[index] || {
                        top: (Math.random() * 60 + 20) + '%',
                        left: (Math.random() * 60 + 20) + '%'
                    };
                    pin.style.top = pos.top;
                    pin.style.left = pos.left;
                    pin.style.transform = 'scale(1.3)';
                    setTimeout(function() { pin.style.transform = 'scale(1)'; }, 300);
                }, index * 200);
            });
        }
        
        function resetMapPins() {
            document.querySelectorAll('.map-pin').forEach(function(pin) { pin.remove(); });
            setTimeout(function() {
                regenerateMapPins(counters.cities, TEMPLATE_CONFIG);
            }, 300);
        }

        function setupMapPins() {
            document.querySelectorAll('.map-pin').forEach(function(pin) {
                setupMapPinSingle(pin);
            });
        }
        
        function setupMapPinSingle(pin) {
            let isDragging = false;
            let startX, startY, startLeft, startTop;

            pin.addEventListener('mousedown', function(e) {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                
                const rect = this.getBoundingClientRect();
                const containerRect = this.parentElement.getBoundingClientRect();
                startLeft = ((rect.left - containerRect.left) / containerRect.width) * 100;
                startTop = ((rect.top - containerRect.top) / containerRect.height) * 100;
                
                this.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                const containerRect = pin.parentElement.getBoundingClientRect();
                
                const newLeft = startLeft + (deltaX / containerRect.width) * 100;
                const newTop = startTop + (deltaY / containerRect.height) * 100;
                
                pin.style.left = Math.max(2, Math.min(98, newLeft)) + '%';
                pin.style.top = Math.max(2, Math.min(98, newTop)) + '%';
            });

            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    pin.style.cursor = 'move';
                }
            });
        }
        
        function setupStaticMap() {}
        
        // ===== FUNCIONES DE EDICI√ìN =====
        function setupEditableElement(element) {
            const limit = parseInt(element.dataset.limit) || 100;
            
            element.addEventListener('click', function() {
                saveState();
                this.contentEditable = true;
                this.focus();
                this.style.background = 'rgba(255, 107, 97, 0.3)';
            });

            element.addEventListener('input', function() {
                enforceLimit(this, limit);
                debounce(function() { expandPageToFit(); }, 500)();
            });

            element.addEventListener('blur', function() {
                this.contentEditable = false;
                this.style.background = 'rgba(255, 107, 97, 0.1)';
            });

            element.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.blur();
                }
            });
        }

        function enforceLimit(element, limit) { return; }
        
        // ===== FUNCIONES DE GUARDADO =====
        function autosaveJSON() {
            try {
                const templateData = serializeTemplate();
                localStorage.setItem('travel_guide_session', JSON.stringify(templateData));
                showToast('üíæ Sesi√≥n guardada localmente');
                
                const statusDot = document.getElementById('saveStatus');
                const statusText = document.getElementById('saveText');
                if (statusDot && statusText) {
                    statusDot.className = 'status-dot';
                    statusText.textContent = 'Guardado';
                }
            } catch (error) {
                console.error('Error al guardar:', error);
                showToast('‚ùå Error al guardar', 'error');
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('travel_guide_session');
                if (saved) {
                    if (confirm('¬øRestaurar sesi√≥n anterior?')) {
                        const templateData = JSON.parse(saved);
                        restoreTemplate(templateData);
                        showToast('üìÇ Sesi√≥n restaurada');
                    } else {
                        localStorage.removeItem('travel_guide_session');
                        showToast('‚ú® Usando variables de TEMPLATE_CONFIG');
                    }
                }
            } catch (error) {
                console.error('Error al cargar:', error);
            }
        }

        function serializeTemplate() {
            const data = {
                version: '5.2',
                timestamp: new Date().toISOString(),
                counters: { ...counters },
                autoExtendEnabled: autoExtendEnabled,
                editableContent: {},
                images: {},
                components: {},
                mapData: {
                    type: TEMPLATE_CONFIG.mapa_tipo,
                    url: TEMPLATE_CONFIG.mapa_url,
                    enlace_google: TEMPLATE_CONFIG.mapa_enlace_google
                },
                colors: {
                    primario: TEMPLATE_CONFIG.color_primario,
                    secundario: TEMPLATE_CONFIG.color_secundario,
                    acento: TEMPLATE_CONFIG.color_acento,
                    fondo: TEMPLATE_CONFIG.color_fondo
                }
            };
            
            document.querySelectorAll('.editable').forEach(function(el) {
                const varName = el.dataset.var;
                if (varName) {
                    data.editableContent[varName] = el.textContent.trim();
                }
            });
            
            document.querySelectorAll('.photo-frame').forEach(function(frame) {
                const frameId = frame.dataset.frame;
                if (frameId) {
                    data.images[frameId] = {
                        backgroundImage: frame.style.backgroundImage || '',
                        backgroundSize: frame.style.backgroundSize || '',
                        backgroundPosition: frame.style.backgroundPosition || '',
                        cropPosition: frame.dataset.cropPosition || '',
                        imageUrl: frame.dataset.imageUrl || '',
                        hasImage: frame.classList.contains('has-image'),
                        isHero: frame.classList.contains('hero'),
                        ratio: frame.classList.contains('hero') ? '2.5:1' : '1:1'
                    };
                }
            });
            
            const logoImg = document.querySelector('.logo-slot img');
            if (logoImg && logoImg.src && logoImg.src !== window.location.href && logoImg.style.display !== 'none') {
                data.logo = logoImg.src;
            }
            
            const flagImg = document.querySelector('.flag-container img');
            if (flagImg && flagImg.src && flagImg.src !== window.location.href && flagImg.style.display !== 'none') {
                data.flag = flagImg.src;
            }
            
            const filledCircles = document.querySelectorAll('.cost-circle:not(.empty)');
            data.components.costRating = filledCircles.length;
            
            const mapPins = document.querySelectorAll('.map-pin');
            data.components.mapPins = Array.from(mapPins).map(function(pin) {
                return {
                    number: pin.textContent,
                    top: pin.style.top,
                    left: pin.style.left
                };
            });
            
            const placeBadges = document.querySelectorAll('.place-badge');
            data.components.placeCategories = Array.from(placeBadges).map(function(badge, index) {
                const classes = Array.from(badge.classList);
                const categoryClass = classes.find(function(c) { return c !== 'place-badge'; }) || 'must';
                return { index: index + 1, category: categoryClass };
            });
            
            return data;
        }

        function restoreTemplate(data) {
            if (!data || !data.version) {
                console.warn('Datos incompatibles');
                return;
            }
            
            counters = { ...data.counters };
            
            if (data.colors) {
                if (data.colors.primario) {
                    TEMPLATE_CONFIG.color_primario = data.colors.primario;
                    document.documentElement.style.setProperty('--teal-primary', data.colors.primario);
                }
                if (data.colors.secundario) {
                    TEMPLATE_CONFIG.color_secundario = data.colors.secundario;
                    document.documentElement.style.setProperty('--teal-light', data.colors.secundario);
                }
                if (data.colors.acento) {
                    TEMPLATE_CONFIG.color_acento = data.colors.acento;
                    document.documentElement.style.setProperty('--coral', data.colors.acento);
                }
                if (data.colors.fondo) {
                    TEMPLATE_CONFIG.color_fondo = data.colors.fondo;
                    document.documentElement.style.setProperty('--sand', data.colors.fondo);
                }
                updateColorInputs(TEMPLATE_CONFIG);
            }
            
            Object.entries(data.editableContent || {}).forEach(function(entry) {
                const varName = entry[0];
                const content = entry[1];
                const element = document.querySelector('[data-var="' + varName + '"]');
                if (element) {
                    element.textContent = content;
                }
            });
            
            Object.entries(data.images || {}).forEach(function(entry) {
                const frameId = entry[0];
                const imageData = entry[1];
                const frame = document.querySelector('[data-frame="' + frameId + '"]');
                if (frame) {
                    if (imageData.backgroundImage && imageData.hasImage) {
                        frame.style.backgroundImage = imageData.backgroundImage;
                        frame.classList.add('has-image');
                        const placeholder = frame.querySelector('.photo-placeholder');
                        if (placeholder) placeholder.style.display = 'none';
                        
                        // Restaurar posici√≥n de recorte
                        if (imageData.backgroundSize) {
                            frame.style.backgroundSize = imageData.backgroundSize;
                        }
                        if (imageData.backgroundPosition) {
                            frame.style.backgroundPosition = imageData.backgroundPosition;
                        }
                        if (imageData.cropPosition) {
                            frame.dataset.cropPosition = imageData.cropPosition;
                        }
                        if (imageData.imageUrl) {
                            frame.dataset.imageUrl = imageData.imageUrl;
                        }
                    }
                    
                    if (imageData.isHero) {
                        frame.classList.remove('mini');
                        frame.classList.add('hero');
                        frame.style.aspectRatio = '2.5/1';
                        frame.style.gridColumn = 'span 2';
                        const badge = frame.querySelector('.dimension-badge');
                        if (badge) badge.textContent = '2.5:1';
                    } else {
                        frame.classList.remove('hero');
                        frame.classList.add('mini');
                        frame.style.aspectRatio = '1/1';
                        frame.style.gridColumn = 'span 1';
                        const badge = frame.querySelector('.dimension-badge');
                        if (badge) badge.textContent = '1:1';
                    }
                }
            });
            
            if (data.logo) {
                const logoSlot = document.querySelector('.logo-slot');
                const img = logoSlot.querySelector('img');
                const placeholder = logoSlot.querySelector('.logo-placeholder');
                img.src = data.logo;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                logoSlot.classList.add('has-logo');
            }
            
            if (data.flag) {
                const flagContainer = document.querySelector('.flag-container');
                const img = flagContainer.querySelector('img');
                const placeholder = flagContainer.querySelector('.flag-placeholder');
                img.src = data.flag;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                flagContainer.classList.add('has-flag');
            }
            
            if (data.components && data.components.costRating) {
                const circles = document.querySelectorAll('.cost-circle');
                const labels = ['Muy barato', 'Barato', 'Moderado', 'Caro', 'Muy caro'];
                circles.forEach(function(circle, index) {
                    if (index < data.components.costRating) {
                        circle.classList.remove('empty');
                    } else {
                        circle.classList.add('empty');
                    }
                });
                const costText = document.querySelector('.cost-text');
                if (costText) {
                    costText.textContent = data.components.costRating + '/5 ‚Äî ' + labels[data.components.costRating-1];
                }
                TEMPLATE_CONFIG.coste_nivel = data.components.costRating;
            }
            
            if (data.mapData && data.mapData.enlace_google) {
                TEMPLATE_CONFIG.mapa_enlace_google = data.mapData.enlace_google;
                updateMapLink(TEMPLATE_CONFIG);
            }

            if (data.mapData && data.mapData.url) {
                const mapContainer = document.querySelector('.map-container');
                const img = document.createElement('img');
                img.src = data.mapData.url;
                img.style.cssText = 'width: 100%; height: 100%; object-fit: contain;';
                mapContainer.innerHTML = '';
                mapContainer.appendChild(img);
                mapContainer.classList.add('has-custom-map');
                TEMPLATE_CONFIG.mapa_url = data.mapData.url;
            }
            
            // CORREGIDO: Restaurar pins del mapa
            if (data.components && data.components.mapPins && data.components.mapPins.length > 0) {
                setTimeout(function() {
                    const mapContainer = document.querySelector('.map-container');
                    mapContainer.querySelectorAll('.map-pin').forEach(function(pin) { pin.remove(); });
                    
                    data.components.mapPins.forEach(function(pinData) {
                        const pin = document.createElement('div');
                        pin.className = 'map-pin component';
                        pin.setAttribute('data-component', 'MAP_PIN');
                        pin.setAttribute('data-pin', pinData.number);
                        pin.textContent = pinData.number;
                        pin.style.top = pinData.top;
                        pin.style.left = pinData.left;
                        
                        mapContainer.appendChild(pin);
                        setupMapPinSingle(pin);
                    });
                    
                    console.log('üìç Pins del mapa restaurados:', data.components.mapPins.length);
                }, 200);
            }
            
            if (data.components && data.components.placeCategories) {
                setTimeout(function() {
                    const badges = document.querySelectorAll('.place-badge');
                    data.components.placeCategories.forEach(function(catData) {
                        const badge = badges[catData.index - 1];
                        if (badge && PLACE_CATEGORIES[catData.category]) {
                            const cat = PLACE_CATEGORIES[catData.category];
                            badge.className = 'place-badge ' + catData.category;
                            badge.innerHTML = cat.emoji + ' ' + cat.label;
                            badge.style.background = cat.color;
                        }
                    });
                }, 200);
            }
            
            updateAllCounters();
            document.querySelectorAll('.editable').forEach(setupEditableElement);
            
            console.log('‚úÖ Template restaurado correctamente');
        }
        
        function showToast(message, type) {
            type = type || 'success';
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'rgba(255, 0, 0, 0.9)' : 'rgba(0, 0, 0, 0.8)';
            toast.style.cssText = 'position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: ' + bgColor + '; color: white; padding: 12px 24px; border-radius: 8px; font-size: 14px; z-index: 10001; animation: fadeIn 0.3s ease;';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(function() {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(function() { toast.remove(); }, 300);
            }, 2000);
        }
        
        function debounce(func, wait) {
            let timeout;
            return function() {
                const args = arguments;
                const later = function() {
                    clearTimeout(timeout);
                    func.apply(null, args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function expandPageToFit() {
            const page = document.querySelector('.page');
            page.style.height = 'auto';
            page.style.minHeight = '297mm';
        }

        function applyCustomColors(config) {
            const root = document.documentElement;
            if (config.color_fondo) root.style.setProperty('--sand', config.color_fondo);
            if (config.color_primario) root.style.setProperty('--teal-primary', config.color_primario);
            if (config.color_secundario) root.style.setProperty('--teal-light', config.color_secundario);
            if (config.color_acento) root.style.setProperty('--coral', config.color_acento);
            if (config.color_texto) root.style.setProperty('--text-dark', config.color_texto);
            if (config.color_fondo_logo) root.style.setProperty('--logo-bg', config.color_fondo_logo);
            updateColorInputs(config);
            console.log('üé® Colores personalizados aplicados');
        }

        function updateColor(cssVar, value) {
            document.documentElement.style.setProperty(cssVar, value);
            
            const codeSpan = event.target.nextElementSibling;
            if (codeSpan) codeSpan.textContent = value.toUpperCase();
            
            const configMap = {
                '--teal-primary': 'color_primario',
                '--teal-light': 'color_secundario',
                '--coral': 'color_acento',
                '--sand': 'color_fondo'
            };
            
            if (configMap[cssVar]) {
                TEMPLATE_CONFIG[configMap[cssVar]] = value;
            }
            
            showToast('üé® Color actualizado: ' + value);
        }

        function updateColorInputs(config) {
            const inputs = {
                'colorPrimario': config.color_primario || '#0F7A78',
                'colorSecundario': config.color_secundario || '#5FB4B2',
                'colorAcento': config.color_acento || '#FF6B61',
                'colorFondo': config.color_fondo || '#F6EFE6'
            };
            
            Object.entries(inputs).forEach(function(entry) {
                const id = entry[0];
                const value = entry[1];
                const input = document.getElementById(id);
                const code = document.getElementById(id + 'Code');
                if (input) input.value = value;
                if (code) code.textContent = value.toUpperCase();
            });
        }

        function reinitializeJS() {
            document.querySelectorAll('.editable').forEach(setupEditableElement);
            setupPhotoDragDrop();
            setupMapPins();
            setupCostRating();
            updateAllCounters();
            setTimeout(function() { expandPageToFit(); }, 100);
        }

        // ===== FUNCIONES DE COMPONENTES =====
        function duplicateComponent(button) {
            saveState();
            
            const component = button.closest('.component');
            const componentType = component.dataset.component;
            
            const sectionLimits = {
                'ITINERARY_CARD': 'days',
                'PLACE_ITEM': 'places',
                'TIP_ITEM': 'tips',
                'CITY_ITEM': 'cities',
                'PHOTO_FRAME': 'photos'
            };
            
            const limitKey = sectionLimits[componentType];
            if (limitKey && counters[limitKey] >= limits[limitKey]) {
                alert('M√°ximo ' + limits[limitKey] + ' elementos permitidos');
                return;
            }
            
            const clone = component.cloneNode(true);
            clearIDs(clone);
            updateClonedComponent(clone, componentType);
            component.parentElement.insertBefore(clone, component.nextSibling);
            
            if (limitKey) {
                counters[limitKey]++;
                updateCounterDisplay(limitKey);
            }
            
            clone.querySelectorAll('.editable').forEach(setupEditableElement);
            clone.classList.add('fade-in');
            setTimeout(function() { expandPageToFit(); }, 100);
        }

        function deleteComponent(button) {
            saveState();
            
            const component = button.closest('.component');
            const componentType = component.dataset.component;
            
            const siblings = component.parentElement.querySelectorAll('[data-component="' + componentType + '"]');
            if (siblings.length <= 1) {
                alert('Debe mantener al menos un elemento');
                return;
            }
            
            component.style.transition = 'all 0.3s ease';
            component.style.opacity = '0';
            component.style.transform = 'translateX(-20px)';
            
            setTimeout(function() {
                component.remove();
                
                const sectionLimits = {
                    'ITINERARY_CARD': 'days',
                    'PLACE_ITEM': 'places',
                    'TIP_ITEM': 'tips',
                    'CITY_ITEM': 'cities',
                    'PHOTO_FRAME': 'photos'
                };
                
                const limitKey = sectionLimits[componentType];
                if (limitKey) {
                    counters[limitKey]--;
                    updateCounterDisplay(limitKey);
                }
                
                reindexCounters();
                expandPageToFit();
            }, 300);
        }

        function updateClonedComponent(clone, componentType) {
            if (componentType === 'CITY_ITEM') {
                const number = clone.querySelector('div[style*="background: var(--teal-primary)"]');
                if (number) number.textContent = counters.cities + 1;
            }
            
            if (componentType === 'ITINERARY_CARD') {
                const dayTitle = clone.querySelector('.day-title .editable');
                if (dayTitle) dayTitle.textContent = 'D√≠a ' + (counters.days + 1) + ': Ciudad';
            }
            
            clone.querySelectorAll('.editable').forEach(function(el) {
                const placeholder = el.dataset.var || 'Nuevo elemento';
                el.textContent = '{{' + placeholder + '}}';
            });
        }

        function clearIDs(clone) {
            clone.querySelectorAll('[id]').forEach(function(el) {
                el.removeAttribute('id');
            });
            if (clone.dataset.component) {
                clone.dataset.cloned = 'true';
            }
        }

        function reindexCounters() {
            const dayCards = document.querySelectorAll('[data-component="ITINERARY_CARD"]');
            dayCards.forEach(function(card, index) {
                const dayTitle = card.querySelector('.day-title .editable');
                if (dayTitle) {
                    const currentText = dayTitle.textContent.replace(/D√≠a \d+/, 'D√≠a ' + (index + 1));
                    dayTitle.textContent = currentText;
                }
            });
            
            const cityItems = document.querySelectorAll('[data-component="CITY_ITEM"]');
            cityItems.forEach(function(item, index) {
                const numberEl = item.querySelector('div[style*="background: var(--teal-primary)"]');
                if (numberEl) numberEl.textContent = index + 1;
            });
            
            const mapPins = document.querySelectorAll('[data-component="MAP_PIN"]');
            mapPins.forEach(function(pin, index) {
                pin.textContent = index + 1;
                pin.dataset.pin = index + 1;
            });
        }

        function updateCounterDisplay(type) {
            const counterMappings = {
                'days': 'dayCounter',
                'places': 'placeCounter',
                'tips': 'tipCounter',
                'cities': 'cityCounter',
                'photos': 'photoCounter'
            };
            
            const counterId = counterMappings[type];
            const counterEl = document.getElementById(counterId);
            
            if (counterEl) {
                const maxLimit = limits[type];
                counterEl.textContent = counters[type] + '/' + maxLimit + ' ' + getTypeLabel(type);
                
                const addBtnId = 'add' + type.charAt(0).toUpperCase() + type.slice(1, -1) + 'Btn';
                const addBtn = document.getElementById(addBtnId);
                if (addBtn) {
                    addBtn.disabled = counters[type] >= maxLimit;
                }
            }
        }

        function getTypeLabel(type) {
            const labels = { 'days': 'd√≠as', 'places': 'lugares', 'tips': 'consejos', 'cities': 'ciudades', 'photos': 'fotos' };
            return labels[type] || type;
        }

        function updateAllCounters() {
            Object.keys(counters).forEach(function(type) {
                if (type !== 'pages') {
                    updateCounterDisplay(type);
                }
            });
        }

        // ===== FUNCIONES DE AGREGAR ELEMENTOS =====
        function addItineraryDay() {
            if (counters.days >= limits.days) {
                alert('M√°ximo ' + limits.days + ' d√≠as permitidos');
                return;
            }
            saveState();
            const container = document.querySelector('#itineraryList');
            const dayElement = createDayElement(counters.days + 1, 'D√≠a ' + (counters.days + 1) + ': Ciudad', '');
            container.appendChild(dayElement);
            counters.days++;
            updateCounterDisplay('days');
            dayElement.querySelectorAll('.editable').forEach(setupEditableElement);
            setTimeout(function() { expandPageToFit(); }, 100);
        }

        function addPlace() {
            if (counters.places >= limits.places) {
                alert('M√°ximo ' + limits.places + ' lugares permitidos');
                return;
            }
            saveState();
            const container = document.querySelector('#placesList');
            const config = {};
            config['lugar' + (counters.places + 1)] = 'Lugar ' + (counters.places + 1);
            config['ciudad_lugar' + (counters.places + 1)] = 'Ciudad';
            config['desc_lugar' + (counters.places + 1)] = 'Descripci√≥n';
            config['tipo_lugar' + (counters.places + 1)] = 'must';
            const placeElement = createPlaceElement(counters.places + 1, config);
            container.appendChild(placeElement);
            counters.places++;
            updateCounterDisplay('places');
            placeElement.querySelectorAll('.editable').forEach(setupEditableElement);
            setTimeout(function() { expandPageToFit(); }, 100);
        }

        function addTip() {
            if (counters.tips >= limits.tips) {
                alert('M√°ximo ' + limits.tips + ' consejos permitidos');
                return;
            }
            saveState();
            const container = document.querySelector('#tipsList');
            const iconos = ['üí∞', 'üöå', 'üîí', 'üì±', 'üçΩÔ∏è', '‚ö°', 'üéØ', 'üìç', 'üó∫Ô∏è', '‚è∞', 'üéå', 'üçú'];
            const tipElement = createTipElement(counters.tips + 1, 'Consejo ' + (counters.tips + 1), iconos[counters.tips] || 'üí°');
            container.appendChild(tipElement);
            counters.tips++;
            updateCounterDisplay('tips');
            tipElement.querySelectorAll('.editable').forEach(setupEditableElement);
            setTimeout(function() { expandPageToFit(); }, 100);
        }

        function addCity() {
            if (counters.cities >= limits.cities) {
                alert('M√°ximo ' + limits.cities + ' ciudades permitidas');
                return;
            }
            saveState();
            const container = document.querySelector('#citiesList');
            const cityElement = createCityElement(counters.cities + 1, 'Ciudad ' + (counters.cities + 1) + ' ‚Äî descripci√≥n');
            container.appendChild(cityElement);
            counters.cities++;
            updateCounterDisplay('cities');
            addMapPin(counters.cities);
            cityElement.querySelectorAll('.editable').forEach(setupEditableElement);
            setTimeout(function() { expandPageToFit(); }, 100);
        }

        // ===== FUNCIONES DE QUITAR ELEMENTOS =====
        function removeLastCity() {
            const container = document.querySelector('#citiesList');
            const items = container.querySelectorAll('[data-component="CITY_ITEM"]');
            if (items.length <= 1) {
                showToast('‚ö†Ô∏è Debe mantener al menos 1 ciudad', 'error');
                return;
            }
            saveState();
            items[items.length - 1].remove();
            const pins = document.querySelectorAll('.map-pin');
            if (pins.length > 0) pins[pins.length - 1].remove();
            counters.cities--;
            updateCounterDisplay('cities');
            showToast('üóëÔ∏è Ciudad eliminada');
        }

        function removeLastPhoto() {
            const container = document.querySelector('#photoGrid');
            const items = container.querySelectorAll('[data-component="PHOTO_FRAME"]');
            if (items.length <= 1) {
                showToast('‚ö†Ô∏è Debe mantener al menos 1 foto', 'error');
                return;
            }
            saveState();
            items[items.length - 1].remove();
            counters.photos--;
            updateCounterDisplay('photos');
            showToast('üóëÔ∏è Foto eliminada');
        }

        function removeLastDay() {
            const container = document.querySelector('#itineraryList');
            const items = container.querySelectorAll('[data-component="ITINERARY_CARD"]');
            if (items.length <= 1) {
                showToast('‚ö†Ô∏è Debe mantener al menos 1 d√≠a', 'error');
                return;
            }
            saveState();
            items[items.length - 1].remove();
            counters.days--;
            updateCounterDisplay('days');
            showToast('üóëÔ∏è D√≠a eliminado');
        }

        function removeLastPlace() {
            const container = document.querySelector('#placesList');
            const items = container.querySelectorAll('[data-component="PLACE_ITEM"]');
            if (items.length <= 1) {
                showToast('‚ö†Ô∏è Debe mantener al menos 1 lugar', 'error');
                return;
            }
            saveState();
            items[items.length - 1].remove();
            counters.places--;
            updateCounterDisplay('places');
            showToast('üóëÔ∏è Lugar eliminado');
        }

        function removeLastTip() {
            const container = document.querySelector('#tipsList');
            const items = container.querySelectorAll('[data-component="TIP_ITEM"]');
            if (items.length <= 1) {
                showToast('‚ö†Ô∏è Debe mantener al menos 1 consejo', 'error');
                return;
            }
            saveState();
            items[items.length - 1].remove();
            counters.tips--;
            updateCounterDisplay('tips');
            showToast('üóëÔ∏è Consejo eliminado');
        }

        function addMapPin(number) {
            const mapContainer = document.querySelector('.map-container');
            const pin = document.createElement('div');
            pin.className = 'map-pin component';
            pin.dataset.component = 'MAP_PIN';
            pin.dataset.pin = number;
            pin.textContent = number;
            pin.style.top = (Math.random() * 60 + 20) + '%';
            pin.style.left = (Math.random() * 60 + 20) + '%';
            mapContainer.appendChild(pin);
            setupMapPinSingle(pin);
        }

        // ===== FUNCIONES DE FOTOS =====
        function addPhoto() {
            if (counters.photos >= limits.photos) {
                alert('M√°ximo ' + limits.photos + ' fotos permitidas');
                return;
            }
            saveState();
            const container = document.querySelector('#photoGrid');
            const photoFrame = document.createElement('div');
            photoFrame.className = 'photo-frame mini component';
            photoFrame.setAttribute('data-component', 'PHOTO_FRAME');
            photoFrame.setAttribute('data-frame', 'IMG_' + counters.photos);
            photoFrame.innerHTML = '<div class="dimension-badge" style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px; cursor: pointer;" onclick="togglePhotoRatio(this.parentElement)">1:1</div><div class="photo-placeholder">üì∑ IMG_' + counters.photos + '<br><small>Click para subir</small></div><div class="photo-controls"><button class="photo-btn" onclick="changePhoto(this)">Cambiar</button><button class="photo-btn" onclick="removePhoto(this)">√ó</button></div><div class="component-controls"><button class="control-btn duplicate-btn" onclick="duplicateComponent(this)">‚ßâ</button><button class="control-btn delete-btn" onclick="deleteComponent(this)">√ó</button></div>';
            container.appendChild(photoFrame);
            counters.photos++;
            updateCounterDisplay('photos');
            setupPhotoDragDropSingle(photoFrame);
            setTimeout(function() { expandPageToFit(); }, 100);
        }

        function uploadMultipleImages() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                const emptyFrames = Array.from(document.querySelectorAll('.photo-frame:not(.has-image)'));
                let loaded = 0;
                files.forEach(function(file, index) {
                    if (index < emptyFrames.length) {
                        loadImageToFrame(emptyFrames[index], file);
                        loaded++;
                    } else if (counters.photos < limits.photos) {
                        addPhoto();
                        setTimeout(function() {
                            const newFrame = document.querySelector('.photo-frame:not(.has-image)');
                            if (newFrame) {
                                loadImageToFrame(newFrame, file);
                                loaded++;
                            }
                        }, 100);
                    }
                });
                setTimeout(function() {
                    showToast('üì∏ ' + loaded + ' imagen' + (loaded > 1 ? 'es' : '') + ' cargada' + (loaded > 1 ? 's' : ''));
                }, 500);
            };
            input.click();
        }

        function setupPhotoDragDrop() {
            document.querySelectorAll('.photo-frame').forEach(setupPhotoDragDropSingle);
        }

        function setupPhotoDragDropSingle(frame) {
            const newFrame = frame.cloneNode(true);
            frame.parentNode.replaceChild(newFrame, frame);
            frame = newFrame;

            frame.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = 'var(--teal-primary)';
                this.style.background = '#f0f9f9';
            });

            frame.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#ccc';
                this.style.background = '#f8f9fa';
            });

            frame.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#ccc';
                this.style.background = '#f8f9fa';
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    loadImageToFrame(this, files[0]);
                }
            });

            frame.addEventListener('click', function(e) {
                if (e.target.classList.contains('photo-btn') || e.target.classList.contains('control-btn') || e.target.classList.contains('dimension-badge')) {
                    return;
                }
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                const self = this;
                input.onchange = function(ev) {
                    if (ev.target.files[0]) {
                        loadImageToFrame(self, ev.target.files[0]);
                    }
                };
                input.click();
            });
        }

        // Variables globales para el crop
        let currentCropFrame = null;
        let currentCropImageUrl = null;
        let cropPositions = { hero: { x: 50, y: 50 }, square: { x: 50, y: 50 } };
        let cropZoom = 100;
        let isDraggingCrop = false;
        let dragStartX, dragStartY, dragStartPosX, dragStartPosY;
        let activeCropPreview = null;

        function loadImageToFrame(frame, file, url) {
            const processImage = function(imageUrl) {
                // Si ya tiene posici√≥n guardada o es carga desde URL (import), aplicar directamente
                const savedPos = frame.dataset.cropPosition;
                if (savedPos || url) {
                    applyImageDirectly(frame, imageUrl, savedPos);
                } else {
                    // Abrir editor de recorte
                    openCropModal(frame, imageUrl);
                }
            };

            if (url) {
                processImage(url);
                return;
            }
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processImage(e.target.result);
                };
                reader.onerror = function() {
                    showToast('‚ùå Error al cargar imagen', 'error');
                };
                reader.readAsDataURL(file);
            }
        }

        function applyImageDirectly(frame, imageUrl, position) {
            let posX = 50, posY = 50, zoom = 100;
            if (position) {
                try {
                    const pos = JSON.parse(position);
                    posX = pos.x || 50;
                    posY = pos.y || 50;
                    zoom = pos.zoom || 100;
                } catch(e) {}
            }
            
            frame.style.backgroundImage = 'url(' + imageUrl + ')';
            frame.style.backgroundSize = (zoom * 1.2) + '%';
            frame.style.backgroundPosition = posX + '% ' + posY + '%';
            frame.classList.add('has-image');
            frame.dataset.imageUrl = imageUrl;
            
            const placeholder = frame.querySelector('.photo-placeholder');
            if (placeholder) placeholder.style.display = 'none';
            
            showToast('üì∏ Imagen aplicada');
            setTimeout(function() { expandPageToFit(); }, 100);
        }

        function openCropModal(frame, imageUrl) {
            currentCropFrame = frame;
            currentCropImageUrl = imageUrl;
            cropZoom = 100;
            cropPositions = { hero: { x: 50, y: 50 }, square: { x: 50, y: 50 } };
            
            const modal = document.getElementById('cropModal');
            const imgHero = document.getElementById('cropImgHero');
            const imgSquare = document.getElementById('cropImgSquare');
            const zoomSlider = document.getElementById('cropZoomSlider');
            
            imgHero.src = imageUrl;
            imgSquare.src = imageUrl;
            zoomSlider.value = 100;
            document.getElementById('cropZoomValue').textContent = '100%';
            
            // Configurar tama√±o inicial
            imgHero.onload = function() {
                updateCropImageSize(imgHero, cropZoom);
                updateCropImageSize(imgSquare, cropZoom);
                centerCropImages();
            };
            
            modal.classList.add('active');
            setupCropDragging();
        }

        function closeCropModal() {
            document.getElementById('cropModal').classList.remove('active');
            currentCropFrame = null;
            currentCropImageUrl = null;
        }

        function updateCropZoom(value) {
            cropZoom = parseInt(value);
            document.getElementById('cropZoomValue').textContent = value + '%';
            
            const imgHero = document.getElementById('cropImgHero');
            const imgSquare = document.getElementById('cropImgSquare');
            
            updateCropImageSize(imgHero, cropZoom);
            updateCropImageSize(imgSquare, cropZoom);
        }

        function updateCropImageSize(img, zoom) {
            const container = img.parentElement;
            const containerRect = container.getBoundingClientRect();
            const imgRatio = img.naturalWidth / img.naturalHeight;
            const containerRatio = containerRect.width / containerRect.height;
            
            let baseWidth, baseHeight;
            if (imgRatio > containerRatio) {
                baseHeight = containerRect.height;
                baseWidth = baseHeight * imgRatio;
            } else {
                baseWidth = containerRect.width;
                baseHeight = baseWidth / imgRatio;
            }
            
            const scaledWidth = baseWidth * (zoom / 100);
            const scaledHeight = baseHeight * (zoom / 100);
            
            img.style.width = scaledWidth + 'px';
            img.style.height = scaledHeight + 'px';
        }

        function centerCropImages() {
            const imgHero = document.getElementById('cropImgHero');
            const imgSquare = document.getElementById('cropImgSquare');
            
            centerSingleCropImage(imgHero);
            centerSingleCropImage(imgSquare);
        }

        function centerSingleCropImage(img) {
            const container = img.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            const left = (containerRect.width - img.offsetWidth) / 2;
            const top = (containerRect.height - img.offsetHeight) / 2;
            
            img.style.left = left + 'px';
            img.style.top = top + 'px';
        }

        function resetCropPosition() {
            cropZoom = 100;
            document.getElementById('cropZoomSlider').value = 100;
            document.getElementById('cropZoomValue').textContent = '100%';
            updateCropZoom(100);
            centerCropImages();
            cropPositions = { hero: { x: 50, y: 50 }, square: { x: 50, y: 50 } };
        }

        function setupCropDragging() {
            const previewHero = document.getElementById('cropPreviewHero');
            const previewSquare = document.getElementById('cropPreviewSquare');
            const imgHero = document.getElementById('cropImgHero');
            const imgSquare = document.getElementById('cropImgSquare');
            
            setupSingleCropDrag(previewHero, imgHero, 'hero');
            setupSingleCropDrag(previewSquare, imgSquare, 'square');
        }

        function setupSingleCropDrag(container, img, type) {
            container.onmousedown = function(e) {
                if (e.target !== img) return;
                e.preventDefault();
                isDraggingCrop = true;
                activeCropPreview = type;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                dragStartPosX = parseInt(img.style.left) || 0;
                dragStartPosY = parseInt(img.style.top) || 0;
                img.style.cursor = 'grabbing';
            };
            
            document.addEventListener('mousemove', function(e) {
                if (!isDraggingCrop || activeCropPreview !== type) return;
                
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                
                let newLeft = dragStartPosX + deltaX;
                let newTop = dragStartPosY + deltaY;
                
                // Limitar para que no salga del contenedor
                const containerRect = container.getBoundingClientRect();
                const maxLeft = 0;
                const minLeft = containerRect.width - img.offsetWidth;
                const maxTop = 0;
                const minTop = containerRect.height - img.offsetHeight;
                
                newLeft = Math.min(maxLeft, Math.max(minLeft, newLeft));
                newTop = Math.min(maxTop, Math.max(minTop, newTop));
                
                img.style.left = newLeft + 'px';
                img.style.top = newTop + 'px';
                
                // Calcular posici√≥n en porcentaje
                const rangeX = Math.abs(minLeft);
                const rangeY = Math.abs(minTop);
                cropPositions[type].x = rangeX > 0 ? Math.round(((maxLeft - newLeft) / rangeX) * 100) : 50;
                cropPositions[type].y = rangeY > 0 ? Math.round(((maxTop - newTop) / rangeY) * 100) : 50;
            });
            
            document.addEventListener('mouseup', function() {
                if (isDraggingCrop && activeCropPreview === type) {
                    isDraggingCrop = false;
                    img.style.cursor = 'move';
                    activeCropPreview = null;
                }
            });
        }

        function applyCrop() {
            if (!currentCropFrame || !currentCropImageUrl) return;
            
            // Determinar qu√© tipo de frame es
            const isHero = currentCropFrame.classList.contains('hero');
            const position = isHero ? cropPositions.hero : cropPositions.square;
            
            // Guardar posici√≥n en el frame
            const posData = JSON.stringify({ x: position.x, y: position.y, zoom: cropZoom });
            currentCropFrame.dataset.cropPosition = posData;
            
            // Aplicar imagen
            currentCropFrame.style.backgroundImage = 'url(' + currentCropImageUrl + ')';
            currentCropFrame.style.backgroundSize = (cropZoom * 1.2) + '%';
            currentCropFrame.style.backgroundPosition = position.x + '% ' + position.y + '%';
            currentCropFrame.classList.add('has-image');
            currentCropFrame.dataset.imageUrl = currentCropImageUrl;
            
            const placeholder = currentCropFrame.querySelector('.photo-placeholder');
            if (placeholder) placeholder.style.display = 'none';
            
            showToast('‚úÇÔ∏è Recorte aplicado correctamente');
            closeCropModal();
            setTimeout(function() { expandPageToFit(); }, 100);
        }

        function changePhoto(button) {
            const frame = button.closest('.photo-frame');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                if (e.target.files[0]) {
                    // Limpiar posici√≥n de recorte anterior para que se abra el modal
                    delete frame.dataset.cropPosition;
                    delete frame.dataset.imageUrl;
                    loadImageToFrame(frame, e.target.files[0]);
                }
            };
            input.click();
        }

        function removePhoto(button) {
            const frame = button.closest('.photo-frame');
            frame.style.backgroundImage = '';
            frame.style.backgroundSize = '';
            frame.style.backgroundPosition = '';
            delete frame.dataset.cropPosition;
            delete frame.dataset.imageUrl;
            frame.classList.remove('has-image');
            const placeholder = frame.querySelector('.photo-placeholder');
            if (placeholder) placeholder.style.display = 'block';
        }

        function togglePhotoRatio(frame) {
            event.stopPropagation();
            const badge = frame.querySelector('.dimension-badge');
            const isHero = frame.classList.contains('hero');
            
            if (isHero) {
                frame.classList.remove('hero');
                frame.classList.add('mini');
                frame.style.aspectRatio = '1/1';
                frame.style.gridColumn = 'span 1';
                if (badge) badge.textContent = '1:1';
            } else {
                frame.classList.remove('mini');
                frame.classList.add('hero');
                frame.style.aspectRatio = '2.5/1';
                frame.style.gridColumn = 'span 2';
                if (badge) badge.textContent = '2.5:1';
            }
            showToast('üìê Cambiado a ' + (isHero ? '1:1' : '2.5:1'));
        }

        function uploadFlag(flagContainer) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = flagContainer.querySelector('img');
                        const placeholder = flagContainer.querySelector('.flag-placeholder');
                        img.src = event.target.result;
                        img.style.display = 'block';
                        placeholder.style.display = 'none';
                        flagContainer.classList.add('has-flag');
                        TEMPLATE_CONFIG.bandera_imagen = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function uploadLogo(logoSlot) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = logoSlot.querySelector('img');
                        const placeholder = logoSlot.querySelector('.logo-placeholder');
                        img.src = event.target.result;
                        img.style.display = 'block';
                        placeholder.style.display = 'none';
                        logoSlot.classList.add('has-logo');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // ===== FUNCIONES DE UTILIDAD =====
        function setupCostRating() {
            const costCircles = document.querySelectorAll('.cost-circle');
            costCircles.forEach(function(circle) {
                const value = parseInt(circle.getAttribute('data-value'));
                circle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    saveState();
                    const allCircles = document.querySelectorAll('.cost-circle');
                    allCircles.forEach(function(c) {
                        const circleValue = parseInt(c.getAttribute('data-value'));
                        if (circleValue <= value) {
                            c.classList.remove('empty');
                        } else {
                            c.classList.add('empty');
                        }
                    });
                    const costText = document.querySelector('.cost-text');
                    const labels = ['Muy barato', 'Barato', 'Moderado', 'Caro', 'Muy caro'];
                    if (costText) {
                        costText.textContent = value + '/5 ‚Äî ' + labels[value-1];
                    }
                    TEMPLATE_CONFIG.coste_nivel = value;
                    showToast('üí∞ Nivel de coste: ' + value + '/5 - ' + labels[value-1]);
                });
            });
        }

        const PLACE_CATEGORIES = {
            'must': { emoji: '‚≠ê', label: 'MUST', color: '#FF6B61' },
            'skip': { emoji: '‚õî', label: 'SKIP', color: '#999' },
            'museo': { emoji: 'üèõÔ∏è', label: 'MUSEO', color: '#9C27B0' },
            'comida': { emoji: 'üçΩÔ∏è', label: 'COMIDA', color: '#FF9800' },
            'templo': { emoji: '‚õ©Ô∏è', label: 'TEMPLO', color: '#E91E63' },
            'monumento': { emoji: 'üóø', label: 'MONUMENTO', color: '#607D8B' },
            'hike': { emoji: 'ü•æ', label: 'HIKE', color: '#4CAF50' },
            'naturaleza': { emoji: 'üå≤', label: 'NATURA', color: '#2E7D32' },
            'playa': { emoji: 'üèñÔ∏è', label: 'PLAYA', color: '#00BCD4' },
            'bar': { emoji: 'üç∫', label: 'BAR', color: '#795548' },
            'cafe': { emoji: '‚òï', label: 'CAF√â', color: '#6D4C41' },
            'compras': { emoji: 'üõçÔ∏è', label: 'COMPRAS', color: '#E91E63' },
            'deporte': { emoji: '‚öΩ', label: 'DEPORTE', color: '#4CAF50' },
            'mirador': { emoji: 'üåÑ', label: 'MIRADOR', color: '#3F51B5' },
            'mistico': { emoji: 'üîÆ', label: 'M√çSTICO', color: '#7B1FA2' },
            'sagrado': { emoji: 'üôè', label: 'SAGRADO', color: '#C62828' },
            'secreto': { emoji: 'ü§´', label: 'SECRETO', color: '#37474F' },
            'raro': { emoji: 'üëΩ', label: 'RARO', color: '#00695C' },
            'privado': { emoji: 'üîí', label: 'PRIVADO', color: '#455A64' },
            'desagradable': { emoji: 'üò¨', label: 'EVITAR', color: '#BF360C' },
            'sucio': { emoji: 'üö´', label: 'SUCIO', color: '#8D6E63' },
            'cementerio': { emoji: '‚ö∞Ô∏è', label: 'PANTE√ìN', color: '#424242' },
            'bailar': { emoji: 'üíÉ', label: 'BAILAR', color: '#D81B60' },
            'gobierno': { emoji: 'üèõÔ∏è', label: 'GOB.', color: '#1565C0' },
            'social': { emoji: 'ü§ù', label: 'SOCIAL', color: '#00897B' },
            'animales': { emoji: 'ü¶Å', label: 'ANIMAL', color: '#FF8F00' },
            'discoteca': { emoji: 'ü™©', label: 'DISCO', color: '#AA00FF' },
            'vecindario': { emoji: 'üèòÔ∏è', label: 'BARRIO', color: '#5D4037' },
            'pueblo': { emoji: 'üèòÔ∏è', label: 'PUEBLO', color: '#8D6E63' },
            'rio': { emoji: 'üèûÔ∏è', label: 'R√çO', color: '#0288D1' },
            'lago': { emoji: 'üåä', label: 'LAGO', color: '#0277BD' },
            'mar': { emoji: 'üåä', label: 'MAR', color: '#01579B' },
            'festival': { emoji: 'üéâ', label: 'FESTIV.', color: '#F50057' },
            'rancho': { emoji: 'ü§†', label: 'RANCHO', color: '#A1887F' },
            'granja': { emoji: 'üöú', label: 'GRANJA', color: '#689F38' },
            'mercado': { emoji: 'üõí', label: 'MERCADO', color: '#F57C00' },
            'panaderia': { emoji: 'ü•ê', label: 'PANAD.', color: '#FFB300' },
            'parque': { emoji: 'üå≥', label: 'PARQUE', color: '#43A047' },
            'masaje': { emoji: 'üíÜ', label: 'MASAJE', color: '#CE93D8' },
            'libreria': { emoji: 'üìö', label: 'LIBRER.', color: '#5C6BC0' },
            'palacio': { emoji: 'üè∞', label: 'PALACIO', color: '#FFC107' },
            'peligro': { emoji: '‚ö†Ô∏è', label: 'PELIGRO', color: '#D32F2F' },
            'bucket': { emoji: 'üìù', label: 'BUCKET', color: '#546E7A' },
            'eco': { emoji: 'üåø', label: 'ECO', color: '#4CAF50' },
            'family': { emoji: 'üë®‚Äçüë©‚Äçüëß', label: 'FAMILY', color: '#FF9800' }
        };

        function cyclePlaceBadge(badge) {
            showCategoryModal(badge);
        }

        function showCategoryModal(badge) {
            const existingModal = document.getElementById('categoryModal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'categoryModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10002;';

            let buttonsHTML = '';
            Object.keys(PLACE_CATEGORIES).forEach(function(key) {
                const cat = PLACE_CATEGORIES[key];
                buttonsHTML += '<button onclick="selectCategory(\'' + key + '\', this)" style="background: ' + cat.color + '; color: white; border: none; padding: 8px 4px; border-radius: 6px; cursor: pointer; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 2px; transition: transform 0.2s;" onmouseover="this.style.transform=\'scale(1.05)\'" onmouseout="this.style.transform=\'scale(1)\'"><span style="font-size: 16px;">' + cat.emoji + '</span><span>' + cat.label + '</span></button>';
            });

            const content = document.createElement('div');
            content.style.cssText = 'background: white; border-radius: 12px; padding: 20px; max-width: 400px; max-height: 70vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';
            content.innerHTML = '<h3 style="margin: 0 0 15px 0; color: var(--teal-primary); font-size: 16px;">Seleccionar Categor√≠a</h3><div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">' + buttonsHTML + '</div><button onclick="closeCategoryModal()" style="width: 100%; margin-top: 15px; padding: 10px; background: #eee; border: none; border-radius: 6px; cursor: pointer;">Cancelar</button>';

            modal.appendChild(content);
            document.body.appendChild(modal);
            window.currentCategoryBadge = badge;

            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeCategoryModal();
            });
        }

        function selectCategory(categoryKey, button) {
            const badge = window.currentCategoryBadge;
            const cat = PLACE_CATEGORIES[categoryKey];
            if (badge && cat) {
                saveState();
                badge.className = 'place-badge ' + categoryKey;
                badge.innerHTML = cat.emoji + ' ' + cat.label;
                badge.style.background = cat.color;
                badge.style.color = 'white';
            }
            closeCategoryModal();
        }

        function closeCategoryModal() {
            const modal = document.getElementById('categoryModal');
            if (modal) modal.remove();
            window.currentCategoryBadge = null;
        }

        // ===== SISTEMA DE DESHACER =====
        let undoStack = [];
        const MAX_UNDO = 10;

        function saveState() {
            const state = serializeTemplate();
            undoStack.push(JSON.stringify(state));
            if (undoStack.length > MAX_UNDO) {
                undoStack.shift();
            }
            const undoBtn = document.getElementById('undoBtn');
            if (undoBtn) undoBtn.disabled = false;
        }

        function undo() {
            if (undoStack.length === 0) return;
            const previousState = undoStack.pop();
            if (previousState) {
                restoreTemplate(JSON.parse(previousState));
                showToast('‚Ü∂ Cambios deshechos');
                const undoBtn = document.getElementById('undoBtn');
                if (undoBtn && undoStack.length === 0) {
                    undoBtn.disabled = true;
                }
            }
        }

        // ===== EXPORTAR/IMPORTAR ARCHIVO =====
        function exportToFile() {
            try {
                const templateData = serializeTemplate();
                const pais = document.querySelector('[data-var="PAIS"]');
                const paisName = pais ? pais.textContent : 'guia';
                const fecha = new Date().toISOString().split('T')[0];
                const filename = paisName.replace(/[^a-zA-Z0-9]/g, '_') + '_' + fecha + '.json';
                
                const blob = new Blob([JSON.stringify(templateData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('üì• Exportado: ' + filename);
            } catch (error) {
                console.error('Error al exportar:', error);
                showToast('‚ùå Error al exportar', 'error');
            }
        }
        
        function importFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (!data.version) {
                            showToast('‚ùå Archivo no v√°lido', 'error');
                            return;
                        }
                        
                        clearAllSections();
                        
                        if (data.counters) {
                            for (let i = 1; i <= data.counters.cities; i++) {
                                const container = document.querySelector('#citiesList');
                                const cityText = data.editableContent['CIUDAD_' + i] || 'Ciudad ' + i;
                                const cityElement = createCityElement(i, cityText);
                                container.appendChild(cityElement);
                            }
                            
                            for (let i = 1; i <= data.counters.days; i++) {
                                const container = document.querySelector('#itineraryList');
                                const dayText = data.editableContent['DIA_' + i] || 'D√≠a ' + i;
                                const actText = data.editableContent['ACTIVIDAD_' + i] || '';
                                const dayElement = createDayElement(i, dayText, actText);
                                container.appendChild(dayElement);
                            }
                            
                            for (let i = 1; i <= data.counters.places; i++) {
                                const container = document.querySelector('#placesList');
                                const config = {};
                                config['lugar' + i] = data.editableContent['LUGAR_' + i] || 'Lugar ' + i;
                                config['ciudad_lugar' + i] = data.editableContent['CIUDAD_LUGAR_' + i] || 'Ciudad';
                                config['desc_lugar' + i] = data.editableContent['DESC_LUGAR_' + i] || 'Descripci√≥n';
                                config['tipo_lugar' + i] = 'must';
                                const placeElement = createPlaceElement(i, config);
                                container.appendChild(placeElement);
                            }
                            
                            const iconos = ['üí∞', 'üöå', 'üîí', 'üì±', 'üçΩÔ∏è', '‚ö°', 'üéØ', 'üìç', 'üó∫Ô∏è', '‚è∞', 'üéå', 'üçú'];
                            for (let i = 1; i <= data.counters.tips; i++) {
                                const container = document.querySelector('#tipsList');
                                const tipText = data.editableContent['TIP_' + i] || 'Consejo ' + i;
                                const tipElement = createTipElement(i, tipText, iconos[i-1] || 'üí°');
                                container.appendChild(tipElement);
                            }
                            
                            // CORREGIDO: Regenerar pins del mapa con posiciones guardadas
                            setTimeout(function() {
                                const mapContainer = document.querySelector('.map-container');
                                
                                if (data.components && data.components.mapPins && data.components.mapPins.length > 0) {
                                    mapContainer.querySelectorAll('.map-pin').forEach(function(pin) { pin.remove(); });
                                    
                                    data.components.mapPins.forEach(function(pinData) {
                                        const pin = document.createElement('div');
                                        pin.className = 'map-pin component';
                                        pin.setAttribute('data-component', 'MAP_PIN');
                                        pin.setAttribute('data-pin', pinData.number);
                                        pin.textContent = pinData.number;
                                        pin.style.top = pinData.top;
                                        pin.style.left = pinData.left;
                                        
                                        mapContainer.appendChild(pin);
                                        setupMapPinSingle(pin);
                                    });
                                    
                                    console.log('üìç Pins restaurados desde archivo:', data.components.mapPins.length);
                                } else {
                                    regenerateMapPins(data.counters.cities, TEMPLATE_CONFIG);
                                    console.log('üìç Pins regenerados para ciudades:', data.counters.cities);
                                }
                            }, 300);
                        }
                        
                        restoreTemplate(data);
                        reinitializeJS();
                        
                        showToast('üìÇ Importado: ' + file.name);
                        
                    } catch (error) {
                        console.error('Error al importar:', error);
                        showToast('‚ùå Error al leer archivo', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // ===== EXPORTACI√ìN PDF =====
        function exportTemplate(format) {
            document.querySelectorAll('.component-controls, .add-btn, .control-panel, .map-controls, .section-controls, .photo-controls, .item-counter, .dimension-badge').forEach(function(el) {
                el.style.display = 'none';
            });
            
            document.querySelectorAll('.editable').forEach(function(el) {
                el.style.border = 'none';
                el.style.background = 'transparent';
                el.style.padding = '0';
            });
            
            window.print();
            
            setTimeout(function() {
                document.querySelectorAll('.component-controls, .add-btn, .control-panel, .map-controls, .section-controls, .photo-controls, .item-counter, .dimension-badge').forEach(function(el) {
                    el.style.display = '';
                });
                document.querySelectorAll('.editable').forEach(function(el) {
                    el.style.border = '';
                    el.style.background = '';
                    el.style.padding = '';
                });
            }, 1000);
        }

        function toggleControlPanel() {
            const panel = document.getElementById('controlPanel');
            const toggle = panel.querySelector('.panel-toggle');
            panel.classList.toggle('collapsed');
            toggle.textContent = panel.classList.contains('collapsed') ? '‚öôÔ∏è' : '‚úï';
            toggle.title = panel.classList.contains('collapsed') ? 'Expandir Panel' : 'Colapsar Panel';
        }

        function togglePreview() {
            const isPreview = document.body.classList.toggle('preview-mode');
            
            document.querySelectorAll('.component-controls, .add-btn, .map-controls, .control-panel').forEach(function(el) {
                el.style.display = isPreview ? 'none' : '';
            });
            
            document.querySelectorAll('.editable').forEach(function(el) {
                if (isPreview) {
                    el.style.border = 'none';
                    el.style.background = 'transparent';
                } else {
                    el.style.border = '';
                    el.style.background = '';
                }
            });
            
            let exitBtn = document.getElementById('exitPreviewBtn');
            
            if (isPreview) {
                if (!exitBtn) {
                    exitBtn = document.createElement('button');
                    exitBtn.id = 'exitPreviewBtn';
                    exitBtn.innerHTML = '‚úèÔ∏è Volver a Editar';
                    exitBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: var(--teal-primary); color: white; border: none; padding: 12px 20px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 10000; transition: all 0.2s;';
                    exitBtn.onmouseover = function() { exitBtn.style.transform = 'scale(1.05)'; };
                    exitBtn.onmouseout = function() { exitBtn.style.transform = 'scale(1)'; };
                    exitBtn.onclick = togglePreview;
                    document.body.appendChild(exitBtn);
                }
                exitBtn.style.display = 'block';
            } else {
                if (exitBtn) exitBtn.style.display = 'none';
            }
            
            const btn = document.querySelector('.preview-btn');
            if (btn) {
                btn.textContent = isPreview ? '‚úèÔ∏è Editar' : 'üëÅÔ∏è Vista previa';
            }
        }

        function toggleHelp() {
            alert('üéØ GU√çA DE VIAJE V5.2 - CORREGIDO\n\nüìã FUNCIONALIDADES:\n\nüñºÔ∏è FOTOS: Click en badge para cambiar ratio\nüìç CATEGOR√çAS: 40+ categor√≠as con emojis\nüé® COLORES: Edita desde el panel lateral\nüì± RESPONSIVE: Funciona en m√≥vil\nüíæ GUARDAR: Ctrl+S guarda sesi√≥n\n‚Ü∂ DESHACER: Ctrl+Z deshace cambios\nüëÅÔ∏è PREVIEW: Escape para salir\n\n‚úÖ CORREGIDO: Pins del mapa se mantienen al importar');
        }

        // ===== VARIABLES GLOBALES =====
        let counters = { photos: 0, cities: 0, days: 0, places: 0, tips: 0, pages: 1 };
        const limits = { photos: 20, cities: 30, days: 60, places: 20, tips: 15 };
        let autoExtendEnabled = true;

        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeFromConfig();
            loadFromLocalStorage();
            setupEventListeners();
            setupKeyboardShortcuts();
            console.log('‚úÖ V5.2 CORREGIDO cargado');
        });

        function setupEventListeners() {
            window.addEventListener('resize', debounce(function() { expandPageToFit(); }, 300));
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    autosaveJSON();
                }
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    undo();
                }
                if (e.key === 'Escape') {
                    const isPreview = document.body.classList.contains('preview-mode');
                    if (isPreview) togglePreview();
                }
            });
            setupMobilePanel();
        }

        function setupMobilePanel() {
            const panel = document.querySelector('.control-panel');
            if (!panel) return;
            panel.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    const rect = panel.getBoundingClientRect();
                    if (e.clientY < rect.top + 30) {
                        panel.classList.toggle('expanded');
                    }
                }
            });
        }
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --teal-primary: #337653;
            --teal-light: #1DAA2D;
            --sand: #000000;
            --coral: #EE3344;
            --white: #ffffff;
            --text-dark: #2F3A3A;
            --text-light: #666;
            --safe-margin: 20mm;
            --gap: 16px;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--sand); color: var(--text-dark); line-height: 1.4; overflow-x: hidden; }
        .document-container { width: 100%; min-height: 100vh; background: var(--sand); }
        .page { width: 210mm; min-height: 297mm; height: auto; margin: 0 auto 20px; background: var(--sand); position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.1); page-break-inside: avoid; overflow: visible; }
        .page-content { padding: var(--safe-margin); height: auto; display: flex; flex-direction: column; gap: var(--gap); }
        .master-header { height: 80px; background: linear-gradient(135deg, var(--teal-primary), var(--teal-light)); border-radius: 12px; position: relative; overflow: hidden; display: flex; align-items: center; padding: 0 20px; flex-shrink: 0; }
        .logo-slot { width: 100px; height: 65px; margin-right: 12px; display: flex; align-items: center; justify-content: center; border-radius: 6px; background: var(--logo-bg, rgba(255,255,255,0.95)); border: 2px dashed rgba(15, 122, 120, 0.3); cursor: pointer; transition: all 0.2s; padding: 2px; }
        .logo-slot:hover { border-color: var(--teal-primary); background: var(--white); transform: scale(1.05); }
        .logo-slot.has-logo { border-style: solid; border-color: var(--white); background: var(--white); }
        .logo-slot img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .logo-placeholder { font-size: 9px; color: var(--teal-primary); text-align: center; line-height: 1.2; font-weight: 600; }
        .flag-container { width: 48px; height: 36px; background: var(--white); border-radius: 4px; border: 2px dashed rgba(15, 122, 120, 0.4); margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 8px; color: var(--teal-primary); font-weight: 600; cursor: pointer; transition: all 0.2s; overflow: hidden; }
        .flag-container:hover { border-color: var(--teal-primary); background: rgba(255,255,255,0.9); transform: scale(1.05); }
        .flag-container.has-flag { border-style: solid; border-color: var(--white); }
        .flag-container img { max-width: 100%; max-height: 100%; object-fit: cover; }
        .flag-placeholder { text-align: center; line-height: 1.1; color: rgba(15, 122, 120, 0.7); }
        .country-title { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 32px; color: var(--white); flex: 1; }
        .page-indicator { position: absolute; top: 8px; right: 16px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 6px; font-size: 8px; color: var(--teal-primary); font-weight: 500; }
        .master-footer { margin-top: auto; padding-top: 12px; border-top: 1px solid #E5E5E5; font-size: 8px; color: #999; text-align: center; flex-shrink: 0; }
        .content-area { flex: 1; display: grid; grid-template-columns: 38% 62%; gap: var(--gap); overflow: visible; }
        .full-width-section { grid-column: 1 / -1; width: 100%; }
        .places-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .left-column, .right-column { display: flex; flex-direction: column; gap: var(--gap); overflow: visible; }
        .flow-container { display: flex; flex-direction: column; gap: 8px; overflow: visible; }
        .flow-item { flex-shrink: 0; break-inside: avoid; }
        .component { position: relative; transition: all 0.2s ease; }
        .component:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(15, 122, 120, 0.15); }
        .component:hover .component-controls { opacity: 1; }
        .component-controls { position: absolute; top: -8px; right: -8px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; z-index: 10; }
        .control-btn { width: 20px; height: 20px; border-radius: 50%; border: none; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.1s; }
        .control-btn:hover { transform: scale(1.1); }
        .duplicate-btn { background: var(--teal-light); color: var(--white); }
        .delete-btn { background: var(--coral); color: var(--white); }
        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #E5E5E5; }
        .section-title { font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 16px; color: var(--teal-primary); }
        .section-controls { display: flex; align-items: center; gap: 8px; }
        .item-counter { font-size: 10px; color: var(--text-light); background: #f0f0f0; padding: 2px 6px; border-radius: 8px; }
        .add-btn { background: var(--teal-primary); color: var(--white); border: none; padding: 6px 10px; border-radius: 6px; font-size: 10px; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: background 0.2s; }
        .add-btn:hover { background: #0d6866; }
        .add-btn:disabled { background: #ccc; cursor: not-allowed; }
        .add-btn.remove-btn { background: var(--coral); padding: 6px 8px; }
        .add-btn.remove-btn:hover { background: #e55a50; }
        .summary-card { background: var(--white); border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1); flex-shrink: 0; }
        .summary-title { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 20px; color: var(--teal-primary); margin-bottom: 12px; }
        .summary-item { margin-bottom: 8px; font-size: 12px; }
        .summary-label { font-weight: 600; color: var(--teal-primary); }
        .budget-section { background: #f8fffe; border-left: 3px solid var(--teal-primary); padding: 12px; margin-top: 12px; border-radius: 0 6px 6px 0; }
        .budget-title { font-weight: 600; color: var(--teal-primary); font-size: 11px; margin-bottom: 8px; }
        .budget-item { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 4px; }
        .budget-label { color: var(--text-light); }
        .budget-value { font-weight: 600; color: var(--text-dark); }
        .cost-rating { display: flex; align-items: center; gap: 8px; margin: 8px 0; }
        .cost-circles { display: flex; gap: 3px; }
        .cost-circle { width: 14px; height: 14px; border-radius: 50%; background: var(--coral); cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .cost-circle.empty { background: #E5E5E5; }
        .cost-circle:hover { transform: scale(1.2); border-color: var(--teal-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .cost-text { font-size: 10px; color: var(--text-light); }
        .photo-section { background: var(--white); border-radius: 12px; padding: 16px; box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1); }
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .photo-frame { background: #f8f9fa; border: 2px dashed #ccc; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; min-height: 60px; }
        .photo-frame.hero { grid-column: span 2; aspect-ratio: 2.5/1; min-height: 80px; }
        .photo-frame.mini { aspect-ratio: 1/1; }
        .photo-frame:hover { border-color: var(--teal-primary); background: #f0f9f9; }
        .photo-frame.has-image { border-style: solid; border-color: var(--teal-primary); }
        .photo-placeholder { text-align: center; color: var(--text-light); font-size: 9px; padding: 8px; }
        .photo-controls { position: absolute; bottom: 4px; right: 4px; display: flex; gap: 2px; opacity: 0; transition: opacity 0.2s; }
        .photo-frame:hover .photo-controls { opacity: 1; }
        .photo-btn { background: rgba(0,0,0,0.7); color: var(--white); border: none; padding: 2px 4px; border-radius: 3px; font-size: 8px; cursor: pointer; }
        .map-section { background: var(--white); border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1); }
        .map-controls { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
        .map-btn { background: var(--teal-light); color: var(--white); border: none; padding: 6px 10px; border-radius: 6px; font-size: 10px; cursor: pointer; transition: all 0.2s; display: inline-flex; }
        .map-btn:hover { background: var(--teal-primary); transform: translateY(-1px); }
        .map-link-container { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: linear-gradient(135deg, #e8f5e9, #e3f2fd); border-radius: 8px; margin-bottom: 12px; border: 1px solid rgba(15, 122, 120, 0.2); }
        .map-link-icon { font-size: 16px; }
        .map-link-label { font-size: 10px; color: var(--text-dark); font-weight: 600; white-space: nowrap; }
        .map-link { flex: 1; font-size: 10px; color: var(--teal-primary); text-decoration: none; padding: 4px 8px; background: rgba(255,255,255,0.7); border-radius: 4px; border: 1px dashed rgba(15, 122, 120, 0.3); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; transition: all 0.2s; }
        .map-link:hover { background: rgba(255,255,255,0.9); border-color: var(--teal-primary); }
        .map-link.has-link { border-style: solid; color: #1a73e8; font-weight: 500; }
        .map-link.has-link:hover { text-decoration: underline; background: #e8f0fe; }
        .edit-link-btn { background: var(--teal-light); color: white; border: none; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .edit-link-btn:hover { background: var(--teal-primary); transform: scale(1.1); }
        .map-container { width: 100%; height: 140px; background: linear-gradient(135deg, #f0f9f9, #e6f7f7); border-radius: 8px; position: relative; overflow: hidden; margin-bottom: 12px; transition: height 0.3s ease; }
        .map-container.has-custom-map { border: 2px solid var(--teal-primary); background: #f8f9fa; height: auto; }
        .map-route { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .map-pin { position: absolute; width: 20px; height: 20px; background: var(--coral); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--white); font-size: 10px; font-weight: 600; border: 2px solid var(--white); box-shadow: 0 2px 6px rgba(0,0,0,0.2); cursor: move; transition: transform 0.2s; z-index: 5; }
        .map-pin:hover { transform: scale(1.1); }
        .itinerary-section { background: var(--white); border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1); }
        .itinerary-card { background: #f8fffe; border-left: 4px solid var(--teal-light); padding: 12px; border-radius: 0 8px 8px 0; margin-bottom: 8px; position: relative; break-inside: avoid; }
        .day-title { font-weight: 600; color: var(--teal-primary); font-size: 12px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .day-activity { font-size: 10px; color: var(--text-light); line-height: 1.3; }
        .top-places { background: var(--white); border-radius: 12px; padding: 16px; box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1); }
        .place-item { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; background: #f8fffe; margin-bottom: 8px; position: relative; break-inside: avoid; }
        .place-badge { padding: 2px 6px; border-radius: 8px; font-size: 8px; font-weight: 600; cursor: pointer; flex-shrink: 0; background: var(--coral); color: var(--white); min-width: 50px; text-align: center; transition: all 0.2s; }
        .place-badge:hover { transform: scale(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .place-text { font-size: 10px; flex: 1; }
        .place-name { font-weight: 600; color: var(--teal-primary); }
        .quick-tips { background: var(--white); border-radius: 12px; padding: 16px; box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1); }
        .tips-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .tip-item { display: flex; align-items: center; gap: 6px; font-size: 9px; padding: 8px; background: #f8fffe; border-radius: 6px; position: relative; break-inside: avoid; }
        .tip-icon { width: 16px; height: 16px; background: var(--coral); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--white); font-size: 8px; flex-shrink: 0; }
        .editable { background: rgba(255, 107, 97, 0.1); padding: 2px 4px; border-radius: 3px; border: 1px dashed var(--coral); cursor: text; position: relative; min-height: 1.2em; word-wrap: break-word; }
        .editable:hover { background: rgba(255, 107, 97, 0.2); }
        .editable:focus { background: rgba(255, 107, 97, 0.3); outline: none; }
        .control-panel { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; background: var(--white); padding: 12px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); transition: all 0.3s ease; max-height: 90vh; overflow-y: auto; }
        .control-panel.collapsed { padding: 0; background: transparent; box-shadow: none; gap: 0; }
        .control-panel.collapsed > *:not(.panel-toggle) { display: none !important; }
        .panel-toggle { background: var(--teal-primary); color: white; border: none; width: 44px; height: 44px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .panel-toggle:hover { transform: scale(1.1); background: var(--teal-light); }
        .control-panel.collapsed .panel-toggle { background: var(--coral); }
        .control-btn-main { padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 500; transition: all 0.2s; position: relative; }
        .control-btn-main:hover { transform: translateY(-1px); }
        .upload-images-btn { background: #2196F3; color: var(--white); }
        .help-btn { background: var(--teal-primary); color: var(--white); }
        .save-btn { background: #4CAF50; color: var(--white); }
        .undo-btn { background: #666; color: var(--white); }
        .undo-btn:disabled { background: #ccc; cursor: not-allowed; }
        .export-btn { background: var(--coral); color: var(--white); }
        .preview-btn { background: var(--teal-light); color: var(--white); }
        .export-file-btn { background: #FF9800; color: var(--white); }
        .import-file-btn { background: #795548; color: var(--white); }
        .status-bar { display: flex; align-items: center; gap: 8px; font-size: 10px; color: var(--text-light); padding: 4px 0; border-top: 1px solid #eee; margin-top: 8px; }
        .status-indicator { display: flex; align-items: center; gap: 4px; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #4CAF50; }
        .preview-mode .editable { border: none !important; background: transparent !important; }
        @media screen and (max-width: 1200px) { .page { transform: scale(0.8); transform-origin: top center; } }
        @media screen and (max-width: 900px) { .page { transform: scale(0.6); transform-origin: top center; } }
        @media screen and (max-width: 600px) { .page { transform: scale(0.45); transform-origin: top center; } }
        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body { margin: 0; background: var(--sand) !important; }
            .page { box-shadow: none; margin: 0; width: 210mm; min-height: 297mm; }
            .control-panel, .component-controls, .add-btn, .map-controls, .photo-controls, .item-counter, .section-controls, .dimension-badge { display: none !important; }
            .editable { border: none !important; background: transparent !important; }
            .master-header { background: linear-gradient(135deg, var(--teal-primary), var(--teal-light)) !important; }
            .cost-circle { background: var(--coral) !important; }
            .cost-circle.empty { background: #E5E5E5 !important; }
            .tip-icon, .map-pin { background: var(--coral) !important; }
            .itinerary-card { border-left: 4px solid var(--teal-light) !important; background: #f8fffe !important; }
            .budget-section { border-left: 3px solid var(--teal-primary) !important; }
            .edit-link-btn { display: none !important; }
            .map-link:not(.has-link), .map-link-container:has(.map-link:not(.has-link)) { display: none !important; }
        }
        .crop-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .crop-modal.active { display: flex; }
        .crop-container { background: white; border-radius: 12px; padding: 20px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .crop-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .crop-header h3 { margin: 0; color: var(--teal-primary); font-family: 'Montserrat', sans-serif; }
        .crop-close { background: var(--coral); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 18px; cursor: pointer; }
        .crop-previews { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .crop-preview-box { background: #f5f5f5; border-radius: 8px; padding: 12px; }
        .crop-preview-box h4 { margin: 0 0 8px 0; font-size: 12px; color: #666; text-align: center; }
        .crop-preview-frame { position: relative; overflow: hidden; border: 2px solid var(--teal-primary); border-radius: 6px; cursor: move; }
        .crop-preview-frame.ratio-hero { aspect-ratio: 2.5/1; }
        .crop-preview-frame.ratio-square { aspect-ratio: 1/1; }
        .crop-preview-frame img { position: absolute; cursor: move; user-select: none; -webkit-user-drag: none; }
        .crop-controls { display: flex; gap: 12px; align-items: center; justify-content: center; margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px; flex-wrap: wrap; }
        .crop-zoom-slider { width: 150px; }
        .crop-zoom-label { font-size: 11px; color: #666; }
        .crop-actions { display: flex; gap: 12px; justify-content: center; }
        .crop-btn { padding: 10px 24px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .crop-btn.confirm { background: var(--teal-primary); color: white; }
        .crop-btn.confirm:hover { background: var(--teal-light); }
        .crop-btn.cancel { background: #e0e0e0; color: #333; }
        .crop-btn.cancel:hover { background: #ccc; }
        .crop-info { text-align: center; font-size: 11px; color: #888; margin-top: 12px; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="control-panel" id="controlPanel">
        <button class="panel-toggle" onclick="toggleControlPanel()" title="Mostrar/Ocultar Panel">‚öôÔ∏è</button>
        <button class="control-btn-main upload-images-btn" onclick="uploadMultipleImages()">üì∑ Subir Im√°genes</button>
        <button class="control-btn-main help-btn" onclick="toggleHelp()">‚ùì Ayuda</button>
        <button class="control-btn-main save-btn" onclick="autosaveJSON()">üíæ Guardar Sesi√≥n</button>
        <button class="control-btn-main export-file-btn" onclick="exportToFile()">üì• Exportar Archivo</button>
        <button class="control-btn-main import-file-btn" onclick="importFromFile()">üì§ Importar Archivo</button>
        <button class="control-btn-main undo-btn" onclick="undo()" id="undoBtn" disabled>‚Ü∂ Deshacer</button>
        <button class="control-btn-main export-btn" onclick="exportTemplate('A4')">üìÑ PDF A4</button>
        <button class="control-btn-main preview-btn" onclick="togglePreview()">üëÅÔ∏è Vista previa</button>
        <div class="color-editor" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
            <div style="font-size: 10px; font-weight: 600; color: #666; margin-bottom: 8px;">üé® Colores</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                <div><label style="font-size: 9px; color: #888;">Primario</label><div style="display: flex; gap: 4px; align-items: center;"><input type="color" id="colorPrimario" value="#337653" onchange="updateColor('--teal-primary', this.value)" style="width: 24px; height: 24px; border: none; cursor: pointer;"><span id="colorPrimarioCode" style="font-size: 8px; color: #666;">#337653</span></div></div>
                <div><label style="font-size: 9px; color: #888;">Secundario</label><div style="display: flex; gap: 4px; align-items: center;"><input type="color" id="colorSecundario" value="#1DAA2D" onchange="updateColor('--teal-light', this.value)" style="width: 24px; height: 24px; border: none; cursor: pointer;"><span id="colorSecundarioCode" style="font-size: 8px; color: #666;">#1DAA2D</span></div></div>
                <div><label style="font-size: 9px; color: #888;">Acento</label><div style="display: flex; gap: 4px; align-items: center;"><input type="color" id="colorAcento" value="#EE3344" onchange="updateColor('--coral', this.value)" style="width: 24px; height: 24px; border: none; cursor: pointer;"><span id="colorAcentoCode" style="font-size: 8px; color: #666;">#EE3344</span></div></div>
                <div><label style="font-size: 9px; color: #888;">Fondo</label><div style="display: flex; gap: 4px; align-items: center;"><input type="color" id="colorFondo" value="#000000" onchange="updateColor('--sand', this.value)" style="width: 24px; height: 24px; border: none; cursor: pointer;"><span id="colorFondoCode" style="font-size: 8px; color: #666;">#000000</span></div></div>
            </div>
        </div>
        <div class="status-bar"><div class="status-indicator"><div class="status-dot" id="saveStatus"></div><span id="saveText">V5.2 CORREGIDO</span></div></div>
    </div>

    <div class="document-container">
        <div class="page" id="page-1" data-page="1">
            <div class="page-content">
                <div class="master-header">
                    <div class="logo-slot" onclick="uploadLogo(this)"><img src="" alt="Logo" style="display: none;" /><div class="logo-placeholder">LOGO<br><small>Click aqu√≠</small></div></div>
                    <div class="flag-container" onclick="uploadFlag(this)"><img src="" alt="Bandera" style="display: none;" /><div class="flag-placeholder">üè≥Ô∏è<br><small>Click</small></div></div>
                    <div class="country-title editable" data-limit="500" data-var="PAIS">{{PA√çS}}</div>
                    <div class="page-indicator">P√°gina 1 de 1</div>
                </div>

                <div class="content-area">
                    <div class="left-column">
                        <div class="summary-card component flow-item">
                            <div class="summary-title editable" data-limit="500" data-var="NOMBRE_PAIS">{{NOMBRE DEL PA√çS}}</div>
                            <div class="summary-item"><span class="summary-label">Fechas:</span> <span class="editable" data-limit="500" data-var="FECHAS">{{Fechas}}</span></div>
                            <div class="summary-item"><span class="summary-label">Duraci√≥n:</span> <span class="editable" data-limit="500" data-var="DURACION">{{Duraci√≥n}}</span></div>
                            <div class="cost-rating component" data-component="COST_RATING">
                                <span class="summary-label">Coste:</span>
                                <div class="cost-circles">
                                    <div class="cost-circle" data-value="1"></div>
                                    <div class="cost-circle" data-value="2"></div>
                                    <div class="cost-circle" data-value="3"></div>
                                    <div class="cost-circle empty" data-value="4"></div>
                                    <div class="cost-circle empty" data-value="5"></div>
                                </div>
                                <span class="cost-text">3/5 ‚Äî Moderado</span>
                            </div>
                            <div class="budget-section">
                                <div class="budget-title">üí∞ Presupuesto</div>
                                <div class="budget-item"><span class="budget-label">Por d√≠a:</span><span class="budget-value editable" data-limit="500" data-var="PRESUPUESTO_DIA">{{Presupuesto/d√≠a}}</span></div>
                                <div class="budget-item"><span class="budget-label">Total gastado:</span><span class="budget-value editable" data-limit="500" data-var="TOTAL_GASTADO">{{Total}}</span></div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;"><div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üí∞</div><span class="editable" data-limit="500" data-var="MONEDA">{{Moneda}}</span></div>
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;"><div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üè®</div><span class="editable" data-limit="500" data-var="COSTO_HOSPEDAJE">{{Hospedaje}}</span></div>
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;"><div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üçΩÔ∏è</div><span class="editable" data-limit="500" data-var="COSTO_COMIDA">{{Comida}}</span></div>
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;"><div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üó£Ô∏è</div><span class="editable" data-limit="500" data-var="IDIOMA">{{Idioma}}</span></div>
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;"><div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üç∫</div><span class="editable" data-limit="500" data-var="COSTO_BEBIDA">{{Bebida}}</span></div>
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;"><div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üõê</div><span class="editable" data-limit="500" data-var="RELIGIONES">{{Religiones}}</span></div>
                            </div>
                        </div>
                        <div class="photo-section flow-item">
                            <div class="section-header">
                                <div class="section-title">Fotos del Viaje</div>
                                <div class="section-controls"><span class="item-counter" id="photoCounter">0/7 fotos</span><button class="add-btn remove-btn" onclick="removeLastPhoto()">‚àí</button><button class="add-btn" onclick="addPhoto()" id="addPhotoBtn">+</button></div>
                            </div>
                            <div class="photo-frame hero component" data-component="PHOTO_FRAME" data-frame="IMG_HERO">
                                <div class="dimension-badge" style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px; cursor: pointer;" onclick="togglePhotoRatio(this.parentElement)">2.5:1</div>
                                <div class="photo-placeholder">üì∏ Imagen Principal<br><small>Click o arrastra (2.5:1)</small></div>
                                <div class="photo-controls"><button class="photo-btn" onclick="changePhoto(this)">Cambiar</button><button class="photo-btn" onclick="removePhoto(this)">√ó</button></div>
                            </div>
                            <div class="photo-grid" id="photoGrid">
                                <div class="photo-frame mini component" data-component="PHOTO_FRAME" data-frame="IMG_1"><div class="dimension-badge" style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px; cursor: pointer;" onclick="togglePhotoRatio(this.parentElement)">1:1</div><div class="photo-placeholder">üì∑ IMG_1<br><small>Click para subir</small></div><div class="photo-controls"><button class="photo-btn" onclick="changePhoto(this)">Cambiar</button><button class="photo-btn" onclick="removePhoto(this)">√ó</button></div></div>
                                <div class="photo-frame mini component" data-component="PHOTO_FRAME" data-frame="IMG_2"><div class="dimension-badge" style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px; cursor: pointer;" onclick="togglePhotoRatio(this.parentElement)">1:1</div><div class="photo-placeholder">üì∑ IMG_2<br><small>Click para subir</small></div><div class="photo-controls"><button class="photo-btn" onclick="changePhoto(this)">Cambiar</button><button class="photo-btn" onclick="removePhoto(this)">√ó</button></div></div>
                                <div class="photo-frame mini component" data-component="PHOTO_FRAME" data-frame="IMG_3"><div class="dimension-badge" style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px; cursor: pointer;" onclick="togglePhotoRatio(this.parentElement)">1:1</div><div class="photo-placeholder">üì∑ IMG_3<br><small>Click para subir</small></div><div class="photo-controls"><button class="photo-btn" onclick="changePhoto(this)">Cambiar</button><button class="photo-btn" onclick="removePhoto(this)">√ó</button></div></div>
                                <div class="photo-frame mini component" data-component="PHOTO_FRAME" data-frame="IMG_4"><div class="dimension-badge" style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px; cursor: pointer;" onclick="togglePhotoRatio(this.parentElement)">1:1</div><div class="photo-placeholder">üì∑ IMG_4<br><small>Click para subir</small></div><div class="photo-controls"><button class="photo-btn" onclick="changePhoto(this)">Cambiar</button><button class="photo-btn" onclick="removePhoto(this)">√ó</button></div></div>
                                <div class="photo-frame mini component" data-component="PHOTO_FRAME" data-frame="IMG_5"><div class="dimension-badge" style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px; cursor: pointer;" onclick="togglePhotoRatio(this.parentElement)">1:1</div><div class="photo-placeholder">üì∑ IMG_5<br><small>Click para subir</small></div><div class="photo-controls"><button class="photo-btn" onclick="changePhoto(this)">Cambiar</button><button class="photo-btn" onclick="removePhoto(this)">√ó</button></div></div>
                                <div class="photo-frame mini component" data-component="PHOTO_FRAME" data-frame="IMG_6"><div class="dimension-badge" style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px; cursor: pointer;" onclick="togglePhotoRatio(this.parentElement)">1:1</div><div class="photo-placeholder">üì∑ IMG_6<br><small>Click para subir</small></div><div class="photo-controls"><button class="photo-btn" onclick="changePhoto(this)">Cambiar</button><button class="photo-btn" onclick="removePhoto(this)">√ó</button></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="right-column">
                        <div class="map-section flow-item">
                            <div class="section-header">
                                <div class="section-title">Ruta del Viaje</div>
                                <div class="section-controls"><span class="item-counter" id="cityCounter">0/20 ciudades</span><button class="add-btn remove-btn" onclick="removeLastCity()">‚àí</button><button class="add-btn" onclick="addCity()" id="addCityBtn">+</button></div>
                            </div>
                            <div class="map-link-container">
                                <span class="map-link-icon">üó∫Ô∏è</span>
                                <span class="map-link-label">Ver ruta interactiva:</span>
                                <a href="#" class="map-link" id="googleMapsLink" target="_blank" onclick="return handleMapLinkClick(this)"><span class="link-text">Click para agregar enlace</span></a>
                                <button class="edit-link-btn" onclick="editMapLink()">‚úèÔ∏è</button>
                            </div>
                            <div class="map-controls">
                                <button class="map-btn" id="uploadMapBtn" onclick="uploadMapImage()">üì§ Subir Mapa</button>
                                <button class="map-btn" onclick="autoPlacePins()">üéØ Auto-ubicar</button>
                                <button class="map-btn" onclick="resetMapPins()">üîÑ Reset Pins</button>
                            </div>
                            <div class="map-container">
                                <svg class="map-route" viewBox="0 0 100 100"><path d="M 20 30 Q 40 20 60 40 T 80 70" stroke="var(--teal-primary)" stroke-width="2" fill="none" stroke-dasharray="5,5"/></svg>
                            </div>
                            <div class="flow-container" id="citiesList"></div>
                        </div>
                        <div class="itinerary-section flow-item">
                            <div class="section-header">
                                <div class="section-title">Itinerario</div>
                                <div class="section-controls"><span class="item-counter" id="dayCounter">0/30 d√≠as</span><button class="add-btn remove-btn" onclick="removeLastDay()">‚àí</button><button class="add-btn" onclick="addItineraryDay()" id="addDayBtn">+</button></div>
                            </div>
                            <div class="flow-container" id="itineraryList"></div>
                        </div>
                    </div>
                    <div class="top-places flow-item full-width-section">
                        <div class="section-header">
                            <div class="section-title">Top Lugares</div>
                            <div class="section-controls"><span class="item-counter" id="placeCounter">0/12 lugares</span><button class="add-btn remove-btn" onclick="removeLastPlace()">‚àí</button><button class="add-btn" onclick="addPlace()" id="addPlaceBtn">+</button></div>
                        </div>
                        <div class="flow-container places-grid" id="placesList"></div>
                    </div>
                    <div class="quick-tips flow-item full-width-section">
                        <div class="section-header">
                            <div class="section-title">Consejos R√°pidos</div>
                            <div class="section-controls"><span class="item-counter" id="tipCounter">0/12 consejos</span><button class="add-btn remove-btn" onclick="removeLastTip()">‚àí</button><button class="add-btn" onclick="addTip()" id="addTipBtn">+</button></div>
                        </div>
                        <div class="tips-grid" id="tipsList"></div>
                    </div>
                </div>
                <div class="master-footer">
                    <div><strong>Creado:</strong> <span class="editable" data-limit="500" data-var="FECHA_CREACION">{{Fecha}}</span> | <strong>Cr√©ditos:</strong> <span class="editable" data-limit="500" data-var="CREDITOS">{{Cr√©ditos}}</span></div>
                    <div style="margin-top: 4px;">‚ö†Ô∏è Informaci√≥n aproximada ‚Äî verificar requisitos oficiales</div>
                </div>
            </div>
        </div>
    </div>
<!-- Modal de Recorte de Imagen -->
    <div class="crop-modal" id="cropModal">
        <div class="crop-container">
            <div class="crop-header">
                <h3>‚úÇÔ∏è Ajustar Imagen</h3>
                <button class="crop-close" onclick="closeCropModal()">√ó</button>
            </div>
            <p style="font-size: 12px; color: #666; margin-bottom: 16px; text-align: center;">
                Arrastra la imagen en cada cuadro para ajustar qu√© parte se mostrar√°. Usa el zoom para acercar/alejar.
            </p>
            <div class="crop-previews">
                <div class="crop-preview-box">
                    <h4>üìê Vista Hero (2.5:1)</h4>
                    <div class="crop-preview-frame ratio-hero" id="cropPreviewHero">
                        <img id="cropImgHero" src="" alt="Preview Hero">
                    </div>
                </div>
                <div class="crop-preview-box">
                    <h4>üì∑ Vista Cuadrada (1:1)</h4>
                    <div class="crop-preview-frame ratio-square" id="cropPreviewSquare">
                        <img id="cropImgSquare" src="" alt="Preview Square">
                    </div>
                </div>
            </div>
            <div class="crop-controls">
                <span class="crop-zoom-label">üîç Zoom:</span>
                <input type="range" class="crop-zoom-slider" id="cropZoomSlider" min="100" max="300" value="100" oninput="updateCropZoom(this.value)">
                <span id="cropZoomValue" style="font-size: 11px; color: #666; min-width: 40px;">100%</span>
                <button class="crop-btn cancel" onclick="resetCropPosition()" style="padding: 6px 12px; font-size: 11px;">‚Ü∫ Reset</button>
            </div>
            <div class="crop-actions">
                <button class="crop-btn cancel" onclick="closeCropModal()">Cancelar</button>
                <button class="crop-btn confirm" onclick="applyCrop()">‚úì Aplicar</button>
            </div>
            <p class="crop-info">üí° La posici√≥n que elijas se aplicar√° a la imagen en el formato correspondiente</p>
        </div>
    </div>

</body>
</html>
