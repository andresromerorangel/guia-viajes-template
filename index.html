<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plantilla Cartilla de Viaje - V5.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- ===== SECCI√ìN DE CONFIGURACI√ìN DE VARIABLES ===== -->
    <script>
        // üéØ CONFIGURACI√ìN PRINCIPAL DE LA PLANTILLA
        const TEMPLATE_CONFIG = {
            // === INFORMACI√ìN B√ÅSICA ===
            pais: "Jap√≥n",
            nombre_pais: "Jap√≥n - Tierra del Sol Naciente",
            fechas: "Marzo - Mayo 2024",
            duracion: "14 d√≠as",
            coste_nivel: 3, // 1-5 (1=muy barato, 5=muy caro)
            moneda: "Yen (JPY)",
            enchufe: "Tipo A/B",
            emergencia: "110/119",
            idioma: "Japon√©s",
            fecha_creacion: "Enero 2024",
            creditos: "Fotos: @viajero_digital, Unsplash",
            
            // === INFORMACI√ìN R√ÅPIDA (NUEVA) ===
            info_adicional: "Mejor √©poca: Primavera (sakura) y oto√±o",
            
            // === CONFIGURACI√ìN DE MAPA ===
            mapa_tipo: "upload", // upload, auto, interactive, static
            mapa_url: "", // URL de imagen personalizada
            mapa_centro: [36.2048, 138.2529], // Centro del pa√≠s [lat, lng]
            
            // === CIUDADES/UBICACIONES ===
            ciudad1: "Tokio ‚Äî Capital moderna y tradicional",
            ciudad1_coords: [35.6762, 139.6503], // [lat, lng]
            ciudad2: "Kioto ‚Äî Templos y cultura ancestral",
            ciudad2_coords: [35.0116, 135.7681],
            ciudad3: "Osaka ‚Äî Gastronom√≠a y entretenimiento",
            ciudad3_coords: [34.6937, 135.5023],
            //ciudad4: "Hiroshima ‚Äî Historia y memoria",
            //ciudad4_coords: [34.3853, 132.4553],
            // A√±ade m√°s ciudades: ciudad5, ciudad6, etc.
            
            // === ITINERARIO POR D√çAS ===
            dia1: "Tokio - Shibuya",
            actividad1: "Explorar el famoso cruce de Shibuya, visitar el santuario Meiji y caminar por Harajuku. Cena en Ginza.",
            
            dia2: "Tokio - Asakusa",
            actividad2: "Templo Sensoji, mercado Nakamise, crucero por el r√≠o Sumida y subida a Tokyo Skytree al atardecer.",
            
            dia3: "Tokio - Akihabara",
            actividad3: "Distrito electr√≥nico, tiendas de anime y manga, caf√©s de criadas. Tarde en jardines del Palacio Imperial.",
            
            dia4: "Viaje a Kioto",
            actividad4: "Viaje en Shinkansen a Kioto. Check-in y paseo nocturno por Gion, distrito de las geishas.",
            
            dia5: "Kioto - Templos",
            actividad5: "Templo Kiyomizu-dera, bosque de bamb√∫ Arashiyama y Templo Dorado (Kinkaku-ji).",
            
            // === TOP LUGARES ===
            lugar1: "Templo Sensoji",
            ciudad_lugar1: "Tokio",
            desc_lugar1: "Templo budista m√°s antiguo de Tokio",
            tipo_lugar1: "must", // must, skip, eco, family
            
            lugar2: "Bosque de Bamb√∫",
            ciudad_lugar2: "Kioto", 
            desc_lugar2: "Sendero m√°gico entre bamb√∫es gigantes",
            tipo_lugar2: "eco",
            
            lugar3: "Shibuya Crossing",
            ciudad_lugar3: "Tokio",
            desc_lugar3: "El cruce peatonal m√°s famoso del mundo",
            tipo_lugar3: "must",
            
            lugar4: "Parque de Nara",
            ciudad_lugar4: "Nara",
            desc_lugar4: "Ciervos sagrados en libertad",
            tipo_lugar4: "family",
            
            // === CONSEJOS R√ÅPIDOS ===
            tip1: "Compra JR Pass antes de llegar - ahorro significativo en transporte",
            tip2: "Aprende frases b√°sicas: arigatou gozaimasu (gracias), sumimasen (perd√≥n)",
            tip3: "Siempre lleva efectivo - muchos lugares no aceptan tarjetas",
            tip4: "Descarga Google Translate con c√°mara para carteles en japon√©s",
            tip5: "Qu√≠tate los zapatos al entrar en casas, templos y ryokans",
            tip6: "No comas caminando - se considera de mala educaci√≥n",
            tip7: "Los trenes son extremadamente puntuales - llega 5 min antes",
            tip8: "Respeta las colas y no hables en el tel√©fono en el tren",
            
            // === IM√ÅGENES (URLs o rutas) ===
            img_hero: "", // Imagen principal 3:1
            img1: "", // 1:1
            img2: "", // 1:1  
            img3: "", // 1:1
            img4: "", // 1:1
            img5: "", // 1:1
            img6: "", // 1:1
            
            // === LOGO ===
            logo: "", // URL del logo del canal
        };
        
        // üîß FUNCI√ìN DE DETECCI√ìN AUTOM√ÅTICA DE CANTIDADES
        function detectConfigCounts(config) {
            const counts = {
                ciudades: 0,
                dias: 0, 
                lugares: 0,
                tips: 0,
                fotos: 0
            };
            
            for (let key in config) {
                if (key.startsWith('ciudad') && /\d+$/.test(key) && !key.includes('_')) {
                    const num = parseInt(key.replace('ciudad', ''));
                    counts.ciudades = Math.max(counts.ciudades, num);
                }
                if (key.startsWith('dia') && /\d+$/.test(key)) {
                    const num = parseInt(key.replace('dia', ''));
                    counts.dias = Math.max(counts.dias, num);
                }
                if (key.startsWith('lugar') && /\d+$/.test(key)) {
                    const num = parseInt(key.replace('lugar', ''));
                    counts.lugares = Math.max(counts.lugares, num);
                }
                if (key.startsWith('tip') && /\d+$/.test(key)) {
                    const num = parseInt(key.replace('tip', ''));
                    counts.tips = Math.max(counts.tips, num);
                }
                if (key.startsWith('img') && /\d+$/.test(key)) {
                    const num = parseInt(key.replace('img', ''));
                    counts.fotos = Math.max(counts.fotos, num);
                }
            }
            
            return counts;
        }
        
        // üéØ FUNCI√ìN PRINCIPAL DE INICIALIZACI√ìN
        function initializeFromConfig() {
            const config = TEMPLATE_CONFIG;
            const counts = detectConfigCounts(config);
            
            console.log('üéØ Inicializando plantilla con configuraci√≥n:', counts);
            
            // IMPORTANTE: Limpiar contenedores antes de regenerar
            clearAllContainers();
            
            updateBasicInfo(config);
            generateCities(config, counts.ciudades);
            generateDays(config, counts.dias);  
            generatePlaces(config, counts.lugares);
            generateTips(config, counts.tips);
            generatePhotoGrid(counts.fotos);
            loadImages(config, counts.fotos);
            loadLogo(config);
            
            // Inicializar mapa
            initializeMap(config);
            
            counters.cities = counts.ciudades;
            counters.days = counts.dias;
            counters.places = counts.lugares; 
            counters.tips = counts.tips;
            counters.photos = counts.fotos + 1; // +1 por la hero
            
            reinitializeJS();
            
            // Validar configuraci√≥n
            validateConfig();
            updateCompletionProgress();
            
            console.log('‚úÖ Plantilla inicializada correctamente');
        }
        
        // üßπ LIMPIAR CONTENEDORES ANTES DE REGENERAR
        function clearAllContainers() {
            document.querySelector('#citiesList').innerHTML = '';
            document.querySelector('#itineraryList').innerHTML = '';
            document.querySelector('#placesList').innerHTML = '';
            document.querySelector('#tipsList').innerHTML = '';
            document.querySelector('#photoGrid').innerHTML = '';
            
            // Limpiar pins del mapa
            const mapContainer = document.querySelector('.map-container');
            mapContainer.querySelectorAll('.map-pin').forEach(pin => pin.remove());
        }
        
        // üìù FUNCIONES DE ACTUALIZACI√ìN
        function updateBasicInfo(config) {
            document.querySelector('[data-var="PAIS"]').innerHTML = config.pais + '<span class="char-counter">0/30</span>';
            document.querySelector('[data-var="NOMBRE_PAIS"]').innerHTML = config.nombre_pais + '<span class="char-counter">0/25</span>';
            document.querySelector('[data-var="FECHAS"]').innerHTML = config.fechas + '<span class="char-counter">0/20</span>';
            document.querySelector('[data-var="DURACION"]').innerHTML = config.duracion + '<span class="char-counter">0/15</span>';
            document.querySelector('[data-var="MONEDA"]').innerHTML = config.moneda + '<span class="char-counter">0/15</span>';
            document.querySelector('[data-var="ENCHUFE"]').innerHTML = config.enchufe + '<span class="char-counter">0/15</span>';
            document.querySelector('[data-var="EMERGENCIA"]').innerHTML = config.emergencia + '<span class="char-counter">0/15</span>';
            document.querySelector('[data-var="IDIOMA"]').innerHTML = config.idioma + '<span class="char-counter">0/20</span>';
            document.querySelector('[data-var="INFO_ADICIONAL"]').innerHTML = config.info_adicional + '<span class="char-counter">0/50</span>';
            document.querySelector('[data-var="FECHA_CREACION"]').textContent = config.fecha_creacion;
            document.querySelector('[data-var="CREDITOS"]').textContent = config.creditos;
            
            if (config.coste_nivel) {
                const circles = document.querySelectorAll('.cost-circle');
                const labels = ['Muy barato', 'Barato', 'Moderado', 'Caro', 'Muy caro'];
                circles.forEach((circle, index) => {
                    if (index < config.coste_nivel) {
                        circle.classList.remove('empty');
                    } else {
                        circle.classList.add('empty'); 
                    }
                });
                document.querySelector('.cost-text').textContent = `${config.coste_nivel}/5 ‚Äî ${labels[config.coste_nivel-1]}`;
            }
        }
        
        function generateCities(config, count) {
            const container = document.querySelector('#citiesList');
            container.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const cityKey = `ciudad${i}`;
                if (config[cityKey]) {
                    const cityElement = createCityElement(i, config[cityKey]);
                    container.appendChild(cityElement);
                }
            }
            
            document.querySelector('#cityCounter').textContent = `${count}/12 ciudades`;
            regenerateMapPins(count, config);
        }
        
        function createCityElement(number, text) {
            const div = document.createElement('div');
            div.className = 'component flow-item';
            div.setAttribute('data-component', 'CITY_ITEM');
            div.style.cssText = 'display: flex; align-items: center; gap: 8px; font-size: 9px;';
            
            div.innerHTML = `
                <div style="width: 16px; height: 16px; background: var(--teal-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 600;">${number}</div>
                <span class="editable" data-limit="25" data-var="CIUDAD_${number}">${text}</span>
                <div class="component-controls">
                    <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)" title="Duplicar ciudad">‚ßâ</button>
                    <button class="control-btn delete-btn" onclick="deleteComponent(this)" title="Eliminar ciudad">√ó</button>
                </div>
            `;
            
            return div;
        }
        
        function generateDays(config, count) {
            const container = document.querySelector('#itineraryList');
            container.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const dayKey = `dia${i}`;
                const activityKey = `actividad${i}`;
                if (config[dayKey]) {
                    const dayElement = createDayElement(i, config[dayKey], config[activityKey] || '');
                    container.appendChild(dayElement);
                }
            }
            
            document.querySelector('#dayCounter').textContent = `${count}/10 d√≠as`;
        }
        
        function createDayElement(number, dayText, activityText) {
            const div = document.createElement('div');
            div.className = 'itinerary-card component flow-item';
            div.setAttribute('data-component', 'ITINERARY_CARD');
            
            div.innerHTML = `
                <div class="day-title">
                    üïê <span class="editable" data-limit="20" data-var="DIA_${number}">${dayText}</span>
                </div>
                <div class="day-activity editable" data-limit="120" data-var="ACTIVIDAD_${number}">${activityText}<span class="char-counter">0/120</span></div>
                <div class="component-controls">
                    <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)" title="Duplicar d√≠a">‚ßâ</button>
                    <button class="control-btn delete-btn" onclick="deleteComponent(this)" title="Eliminar d√≠a">√ó</button>
                </div>
            `;
            
            return div;
        }
        
        function generatePlaces(config, count) {
            const container = document.querySelector('#placesList');
            container.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const lugarKey = `lugar${i}`;
                if (config[lugarKey]) {
                    const placeElement = createPlaceElement(i, config);
                    container.appendChild(placeElement);
                }
            }
            
            document.querySelector('#placeCounter').textContent = `${count}/12 lugares`;
        }
        
        function createPlaceElement(number, config) {
            const lugar = config[`lugar${number}`] || '';
            const ciudad = config[`ciudad_lugar${number}`] || '';
            const desc = config[`desc_lugar${number}`] || '';
            const tipo = config[`tipo_lugar${number}`] || 'must';
            
            const badges = {
                'must': 'MUST',
                'skip': 'SKIP', 
                'eco': 'ECO',
                'family': 'FAMILY'
            };
            
            const div = document.createElement('div');
            div.className = 'place-item component flow-item';
            div.setAttribute('data-component', 'PLACE_ITEM');
            
            div.innerHTML = `
                <span class="place-badge ${tipo}" onclick="cyclePlaceBadge(this)">${badges[tipo]}</span>
                <div class="place-text">
                    <div class="place-name editable" data-limit="20" data-var="LUGAR_${number}">${lugar}</div>
                    <div style="font-size: 9px; color: var(--text-light);">
                        <span class="editable" data-limit="15" data-var="CIUDAD_LUGAR_${number}">${ciudad}</span> ‚Äî 
                        <span class="editable" data-limit="30" data-var="DESC_LUGAR_${number}">${desc}</span>
                    </div>
                </div>
                <div class="component-controls">
                    <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)" title="Duplicar lugar">‚ßâ</button>
                    <button class="control-btn delete-btn" onclick="deleteComponent(this)" title="Eliminar lugar">√ó</button>
                </div>
            `;
            
            return div;
        }
        
        function generateTips(config, count) {
            const container = document.querySelector('#tipsList');
            container.innerHTML = '';
            
            const iconos = ['üí∞', 'üöå', 'üîí', 'üì±', 'üçΩÔ∏è', '‚ö°', 'üéØ', 'üìç', 'üó∫Ô∏è', '‚è∞', 'üéå', 'üçú'];
            
            for (let i = 1; i <= count; i++) {
                const tipKey = `tip${i}`;
                if (config[tipKey]) {
                    const tipElement = createTipElement(i, config[tipKey], iconos[(i-1) % iconos.length] || 'üí°');
                    container.appendChild(tipElement);
                }
            }
            
            document.querySelector('#tipCounter').textContent = `${count}/12 consejos`;
        }
        
        function createTipElement(number, text, icon) {
            const div = document.createElement('div');
            div.className = 'tip-item component flow-item';
            div.setAttribute('data-component', 'TIP_ITEM');
            
            div.innerHTML = `
                <div class="tip-icon">${icon}</div>
                <span class="editable" data-limit="80" data-var="TIP_${number}">${text}<span class="char-counter">0/80</span></span>
                <div class="component-controls">
                    <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)" title="Duplicar consejo">‚ßâ</button>
                    <button class="control-btn delete-btn" onclick="deleteComponent(this)" title="Eliminar consejo">√ó</button>
                </div>
            `;
            
            return div;
        }
        
        function generatePhotoGrid(count) {
            const container = document.querySelector('#photoGrid');
            container.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const photoFrame = document.createElement('div');
                photoFrame.className = 'photo-frame mini component';
                photoFrame.setAttribute('data-component', 'PHOTO_FRAME');
                photoFrame.setAttribute('data-frame', `IMG_${i}`);
                
                photoFrame.innerHTML = `
                    <div style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px;">1:1</div>
                    <div class="photo-placeholder">
                        üì∑ IMG_${i}<br>
                        <small>Drag & Drop</small>
                    </div>
                    <div class="photo-controls">
                        <button class="photo-btn" onclick="changePhoto(this)">Cambiar</button>
                        <button class="photo-btn" onclick="removePhoto(this)">√ó</button>
                    </div>
                    <div class="component-controls">
                        <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)" title="Duplicar foto">‚ßâ</button>
                        <button class="control-btn delete-btn" onclick="deleteComponent(this)" title="Eliminar foto">√ó</button>
                    </div>
                `;
                
                container.appendChild(photoFrame);
            }
        }
        
        function loadImages(config, count) {
            if (config.img_hero) {
                loadImageToFrame(document.querySelector('[data-frame="IMG_HERO"]'), null, config.img_hero);
            }
            
            for (let i = 1; i <= count; i++) {
                const imgKey = `img${i}`;
                if (config[imgKey]) {
                    const frame = document.querySelector(`[data-frame="IMG_${i}"]`);
                    if (frame) {
                        loadImageToFrame(frame, null, config[imgKey]);
                    }
                }
            }
        }
        
        function loadLogo(config) {
            if (config.logo) {
                const logoSlot = document.querySelector('.logo-slot');
                const img = logoSlot.querySelector('img');
                const placeholder = logoSlot.querySelector('.logo-placeholder');
                
                img.src = config.logo;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                logoSlot.classList.add('has-logo');
            }
        }
        
        // ===== VALIDACI√ìN Y PROGRESO =====
        function validateConfig() {
            const requiredFields = ['pais', 'nombre_pais', 'fechas', 'duracion', 'moneda', 'idioma'];
            const missing = [];
            
            requiredFields.forEach(field => {
                if (!TEMPLATE_CONFIG[field] || TEMPLATE_CONFIG[field] === '') {
                    missing.push(field);
                }
            });
            
            if (missing.length > 0) {
                showValidationWarning(missing);
            }
        }
        
        function showValidationWarning(missingFields) {
            const warningEl = document.getElementById('validationWarning');
            if (warningEl) {
                warningEl.innerHTML = `‚ö†Ô∏è Campos incompletos: ${missingFields.join(', ')}`;
                warningEl.style.display = 'block';
            }
        }
        
        function updateCompletionProgress() {
            const totalFields = Object.keys(TEMPLATE_CONFIG).length;
            const filledFields = Object.values(TEMPLATE_CONFIG).filter(val => val !== '' && val !== null && val !== undefined).length;
            
            const percentage = Math.round((filledFields / totalFields) * 100);
            
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            if (progressBar && progressText) {
                progressBar.style.width = percentage + '%';
                progressText.textContent = `Completitud: ${percentage}%`;
                
                // Cambiar color seg√∫n porcentaje
                if (percentage >= 80) {
                    progressBar.style.background = '#4CAF50'; // Verde
                } else if (percentage >= 50) {
                    progressBar.style.background = '#FF9800'; // Amarillo
                } else {
                    progressBar.style.background = '#FF6B61'; // Rojo
                }
            }
        }
        
        // ===== FUNCIONES DE MAPA INTEGRADAS =====
        function initializeMap(config) {
            const mapType = config.mapa_tipo || 'static';
            
            switch(mapType) {
                case 'upload':
                    setupMapUpload();
                    break;
                case 'auto':
                    generateCountryMap(config.pais);
                    break;
                default:
                    setupStaticMap();
                    break;
            }
        }
        
        function setupMapUpload() {
            const uploadBtn = document.getElementById('uploadMapBtn');
            if (uploadBtn) {
                uploadBtn.style.display = 'inline-flex';
                uploadBtn.onclick = uploadMapImage;
            }
            
            showMapMessage('Haz clic en "üì§ Subir Mapa" para cargar una imagen del pa√≠s', 'info');
        }
        
        function uploadMapImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const mapContainer = document.querySelector('.map-container');
                        
                        // Limpiar contenido anterior (excepto pins)
                        const existingPins = Array.from(mapContainer.querySelectorAll('.map-pin'));
                        mapContainer.innerHTML = '';
                        
                        // Crear imagen de fondo
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.style.cssText = `
                            width: 100%;
                            height: 100%;
                            object-fit: contain;
                            object-position: center;
                        `;
                        img.alt = 'Mapa personalizado';
                        
                        mapContainer.appendChild(img);
                        mapContainer.classList.add('has-custom-map');
                        
                        // Restaurar pins existentes
                        existingPins.forEach(pin => {
                            mapContainer.appendChild(pin);
                        });
                        
                        showMapMessage('Mapa cargado correctamente. Arrastra los pins a las ubicaciones correctas.', 'success');
                        
                        // Actualizar variable en config para persistencia
                        TEMPLATE_CONFIG.mapa_url = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        function generateCountryMap(pais) {
            showMapMessage(`Generando mapa de ${pais}... (En implementaci√≥n real usar√≠a OpenStreetMap API)`, 'info');
            
            setTimeout(() => {
                const mapContainer = document.querySelector('.map-container');
                const existingPins = Array.from(mapContainer.querySelectorAll('.map-pin'));
                
                mapContainer.innerHTML = `
                    <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #e8f5e8, #d4e8d4); position: relative; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                        <div style="text-align: center; color: #666;">
                            <h4>üóæ ${pais}</h4>
                            <p style="font-size: 11px; margin-top: 8px;">Mapa auto-generado</p>
                            <div style="margin-top: 15px; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 4px; font-size: 9px;">
                                Implementaci√≥n: OpenStreetMap API
                            </div>
                        </div>
                    </div>
                `;
                
                existingPins.forEach(pin => {
                    mapContainer.appendChild(pin);
                });
                
                showMapMessage('Mapa generado autom√°ticamente', 'success');
            }, 1000);
        }
        
        function setupStaticMap() {
            showMapMessage('Usando mapa decorativo por defecto', 'info');
        }
        
        function regenerateMapPins(count, config) {
            const mapContainer = document.querySelector('.map-container');
            
            // Limpiar pins existentes
            mapContainer.querySelectorAll('.map-pin').forEach(pin => pin.remove());
            
            // Crear nuevos pins con posicionamiento inteligente
            for (let i = 1; i <= count; i++) {
                const pin = document.createElement('div');
                pin.className = 'map-pin component';
                pin.setAttribute('data-component', 'MAP_PIN');
                pin.setAttribute('data-pin', i.toString());
                pin.textContent = i.toString();
                
                // Usar coordenadas si est√°n disponibles o posici√≥n predeterminada
                const coordsKey = `ciudad${i}_coords`;
                let position;
                
                if (config[coordsKey]) {
                    // Posiciones predefinidas para Jap√≥n
                    const positions = [
                        {top: '25%', left: '70%'}, // Ciudad 1
                        {top: '40%', left: '65%'}, // Ciudad 2
                        {top: '45%', left: '60%'}, // Ciudad 3
                        {top: '30%', left: '55%'}, // Ciudad 4
                        {top: '50%', left: '75%'}, // Ciudad 5
                        {top: '35%', left: '68%'}, // Ciudad 6
                        {top: '42%', left: '72%'}, // Ciudad 7
                    ];
                    position = positions[i-1] || {top: '50%', left: '50%'};
                } else {
                    // Posici√≥n aleatoria como fallback
                    position = {
                        top: (Math.random() * 60 + 20) + '%',
                        left: (Math.random() * 60 + 20) + '%'
                    };
                }
                
                pin.style.top = position.top;
                pin.style.left = position.left;
                
                mapContainer.appendChild(pin);
                setupMapPinSingle(pin);
            }
        }
        
        function autoPlacePins() {
            const config = TEMPLATE_CONFIG;
            const pins = document.querySelectorAll('.map-pin');
            
            if (pins.length === 0) {
                showMapMessage('Primero carga ciudades para auto-ubicar', 'error');
                return;
            }
            
            showMapMessage('Auto-ubicando ciudades...', 'info');
            
            // Posiciones predeterminadas mejoradas
            const positions = [
                {top: '25%', left: '70%'}, // Tokio
                {top: '40%', left: '65%'}, // Kioto
                {top: '45%', left: '60%'}, // Osaka
                {top: '30%', left: '55%'}, // Hiroshima
                {top: '50%', left: '75%'}, // Nara
                {top: '35%', left: '68%'}, // Ciudad 6
                {top: '42%', left: '72%'}, // Ciudad 7
            ];
            
            pins.forEach((pin, index) => {
                setTimeout(() => {
                    const pos = positions[index] || {
                        top: (Math.random() * 60 + 20) + '%',
                        left: (Math.random() * 60 + 20) + '%'
                    };
                    
                    pin.style.top = pos.top;
                    pin.style.left = pos.left;
                    
                    // Animaci√≥n de confirmaci√≥n
                    pin.style.transform = 'scale(1.3)';
                    setTimeout(() => {
                        pin.style.transform = 'scale(1)';
                    }, 300);
                }, index * 200);
            });
        }
        
        function resetMapPins() {
            const pins = document.querySelectorAll('.map-pin');
            pins.forEach(pin => pin.remove());
            
            showMapMessage('Pins eliminados', 'success');
            
            // Regenerar pins b√°sicos si hay ciudades
            const citiesCount = counters.cities;
            if (citiesCount > 0) {
                setTimeout(() => {
                    regenerateMapPins(citiesCount, TEMPLATE_CONFIG);
                }, 500);
            }
        }
        
        function showMapMessage(message, type = 'info') {
            let messageEl = document.getElementById('mapMessage');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'mapMessage';
                messageEl.style.cssText = `
                    margin: 8px 0;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 11px;
                    text-align: center;
                `;
                document.querySelector('.map-section').insertBefore(messageEl, document.querySelector('.map-container'));
            }
            
            const colors = {
                info: 'background: #e6f3ff; color: #0066cc; border-left: 3px solid #0066cc;',
                success: 'background: #e6f7e6; color: #28a745; border-left: 3px solid #28a745;',
                error: 'background: #ffe6e6; color: #d63384; border-left: 3px solid #d63384;'
            };
            
            messageEl.style.cssText += colors[type] || colors.info;
            messageEl.textContent = message;
            messageEl.style.display = 'block';
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 4000);
            }
        }
        
        function reinitializeJS() {
            document.querySelectorAll('.editable').forEach(setupEditableElement);
            setupPhotoDragDrop();
            setupMapPins();
            setupCostRating();
            updateAllCounters();
            
            setTimeout(() => {
                expandPageToFit();
                checkOverflow();
            }, 100);
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --teal-primary: #0F7A78;
            --teal-light: #5FB4B2;
            --sand: #F6EFE6;
            --coral: #FF6B61;
            --white: #ffffff;
            --text-dark: #2F3A3A;
            --text-light: #666;
            --safe-margin: 20mm;
            --bleed: 3mm;
            --gap: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--sand);
            color: var(--text-dark);
            line-height: 1.4;
            overflow-x: hidden;
        }

        .document-container {
            width: 100%;
            min-height: 100vh;
            background: var(--sand);
        }

        .page {
            width: 210mm;
            min-height: 297mm;
            height: auto;
            margin: 0 auto 20px;
            background: var(--sand);
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            page-break-inside: avoid;
            overflow: visible;
        }

        .page-content {
            padding: var(--safe-margin);
            height: auto;
            display: flex;
            flex-direction: column;
            gap: var(--gap);
        }

        .master-header {
            height: 80px;
            background: linear-gradient(135deg, var(--teal-primary), var(--teal-light));
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            padding: 0 20px;
            flex-shrink: 0;
        }

        .logo-slot {
            width: 56px;
            height: 36px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background: transparent;
            border: 2px dashed rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 8px;
            color: rgba(255,255,255,0.7);
            text-align: center;
            line-height: 1.1;
            overflow: hidden;
        }

        .logo-slot:hover {
            border-color: rgba(255,255,255,0.6);
            background: rgba(255,255,255,0.1);
        }

        .logo-slot.has-logo {
            border-style: solid;
            border-color: var(--white);
        }

        .logo-slot img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .flag-container {
            width: 48px;
            height: 36px;
            background: var(--white);
            border-radius: 4px;
            border: 2px solid var(--teal-primary);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--teal-primary);
            font-weight: 600;
        }

        .country-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 32px;
            color: var(--white);
            flex: 1;
        }

        .page-indicator {
            position: absolute;
            top: 8px;
            right: 16px;
            background: rgba(255,255,255,0.9);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 8px;
            color: var(--teal-primary);
            font-weight: 500;
        }

        .master-footer {
            margin-top: auto;
            padding-top: 12px;
            border-top: 1px solid #E5E5E5;
            font-size: 8px;
            color: #999;
            text-align: center;
            flex-shrink: 0;
        }

        .content-area {
            flex: 1;
            display: grid;
            grid-template-columns: 38% 62%;
            gap: var(--gap);
            overflow: visible;
        }

        .left-column, .right-column {
            display: flex;
            flex-direction: column;
            gap: var(--gap);
            overflow: visible;
        }

        .flow-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: visible;
        }

        .flow-item {
            flex-shrink: 0;
            break-inside: avoid;
        }

        .component {
            position: relative;
            transition: all 0.2s ease;
        }

        .component:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(15, 122, 120, 0.15);
        }

        .component:hover .component-controls {
            opacity: 1;
        }

        .component-controls {
            position: absolute;
            top: -8px;
            right: -8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .control-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .duplicate-btn {
            background: var(--teal-light);
            color: var(--white);
        }

        .delete-btn {
            background: var(--coral);
            color: var(--white);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #E5E5E5;
        }

        .section-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 16px;
            color: var(--teal-primary);
        }

        .section-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item-counter {
            font-size: 10px;
            color: var(--text-light);
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 8px;
        }

        .add-btn {
            background: var(--teal-primary);
            color: var(--white);
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }

        .add-btn:hover {
            background: #0d6866;
        }

        .add-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .summary-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);
            flex-shrink: 0;
        }

        .summary-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 20px;
            color: var(--teal-primary);
            margin-bottom: 12px;
        }

        .summary-item {
            margin-bottom: 8px;
            font-size: 12px;
        }

        .summary-label {
            font-weight: 600;
            color: var(--teal-primary);
        }

        .cost-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }

        .cost-circles {
            display: flex;
            gap: 3px;
        }

        .cost-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--coral);
            cursor: pointer;
            transition: all 0.2s;
        }

        .cost-circle.empty {
            background: #E5E5E5;
        }

        .cost-circle:hover {
            transform: scale(1.1);
        }

        .cost-text {
            font-size: 10px;
            color: var(--text-light);
        }

        .photo-section {
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .photo-frame {
            background: #f8f9fa;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 60px;
        }

        .photo-frame.hero {
            grid-column: span 2;
            aspect-ratio: 3/1;
            min-height: 80px;
        }

        .photo-frame.mini {
            aspect-ratio: 1/1;
        }

        .photo-frame:hover {
            border-color: var(--teal-primary);
            background: #f0f9f9;
        }

        .photo-frame.has-image {
            border-style: solid;
            border-color: var(--teal-primary);
        }

        .photo-placeholder {
            text-align: center;
            color: var(--text-light);
            font-size: 9px;
            padding: 8px;
        }

        .photo-controls {
            position: absolute;
            bottom: 4px;
            right: 4px;
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .photo-frame:hover .photo-controls {
            opacity: 1;
        }

        .photo-btn {
            background: rgba(0,0,0,0.7);
            color: var(--white);
            border: none;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 8px;
            cursor: pointer;
        }

        .map-section {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);
        }

        .map-controls {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .map-btn {
            background: var(--teal-light);
            color: var(--white);
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: none;
        }

        .map-btn:hover {
            background: var(--teal-primary);
            transform: translateY(-1px);
        }

        .map-container {
            width: 100%;
            height: 140px;
            background: linear-gradient(135deg, #f0f9f9, #e6f7f7);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .map-container.has-custom-map {
            border: 2px solid var(--teal-primary);
            background: #f8f9fa;
        }

        .map-route {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .map-pin {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--coral);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 10px;
            font-weight: 600;
            border: 2px solid var(--white);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            cursor: move;
            transition: transform 0.2s;
            z-index: 5;
        }

        .map-pin:hover {
            transform: scale(1.1);
        }

        .itinerary-section {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);
        }

        .itinerary-card {
            background: #f8fffe;
            border-left: 4px solid var(--teal-light);
            padding: 12px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 8px;
            position: relative;
            break-inside: avoid;
        }

        .day-title {
            font-weight: 600;
            color: var(--teal-primary);
            font-size: 12px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .day-activity {
            font-size: 10px;
            color: var(--text-light);
            line-height: 1.3;
        }

        .top-places {
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);
        }

        .place-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            background: #f8fffe;
            margin-bottom: 8px;
            position: relative;
            break-inside: avoid;
        }

        .place-badge {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 8px;
            font-weight: 600;
            cursor: pointer;
            flex-shrink: 0;
        }

        .place-badge.must { background: var(--coral); color: var(--white); }
        .place-badge.skip { background: #E5E5E5; color: var(--text-light); }
        .place-badge.eco { background: #4CAF50; color: var(--white); }
        .place-badge.family { background: #FF9800; color: var(--white); }

        .place-text {
            font-size: 10px;
            flex: 1;
        }

        .place-name {
            font-weight: 600;
            color: var(--teal-primary);
        }

        .quick-tips {
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);
        }

        .tips-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .tip-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 9px;
            padding: 8px;
            background: #f8fffe;
            border-radius: 6px;
            position: relative;
            break-inside: avoid;
        }

        .tip-icon {
            width: 16px;
            height: 16px;
            background: var(--coral);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 8px;
            flex-shrink: 0;
        }

        .editable {
            background: rgba(255, 107, 97, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px dashed var(--coral);
            cursor: text;
            position: relative;
            min-height: 1.2em;
            word-wrap: break-word;
        }

        .editable:hover {
            background: rgba(255, 107, 97, 0.2);
        }

        .editable:focus {
            background: rgba(255, 107, 97, 0.3);
            outline: none;
        }

        .char-counter {
            font-size: 8px;
            color: var(--text-light);
            margin-left: 4px;
        }

        .char-counter.warning {
            color: var(--coral);
            font-weight: 600;
        }

        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: var(--white);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 200px;
        }

        .control-btn-main {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            position: relative;
        }

        .control-btn-main:hover {
            transform: translateY(-1px);
        }

        /* Tooltips */
        .control-btn-main::after {
            content: attr(data-tooltip);
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-right: 8px;
            padding: 4px 8px;
            background: rgba(0,0,0,0.8);
            color: white;
            font-size: 10px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .control-btn-main:hover::after {
            opacity: 1;
        }

        .help-btn { background: var(--teal-primary); color: var(--white); }
        .export-btn { background: var(--coral); color: var(--white); }
        .preview-btn { background: var(--teal-light); color: var(--white); }
        .undo-btn { background: #666; color: var(--white); }
        .save-btn { background: #4CAF50; color: var(--white); }
        .autoextend-btn { background: var(--teal-light); color: var(--white); }
        .autoextend-btn.active { background: var(--teal-primary); }
        .compact-btn { background: #FF9800; color: var(--white); }
        .reload-config-btn { background: #9C27B0; color: var(--white); }
        .upload-multiple-btn { background: #2196F3; color: var(--white); }

        .status-bar {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 10px;
            color: var(--text-light);
            padding: 8px 0;
            border-top: 1px solid #eee;
            margin-top: 8px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4CAF50;
        }

        .status-dot.warning { background: #FF9800; }
        .status-dot.error { background: var(--coral); }

        .progress-container {
            margin-top: 8px;
        }

        .progress-bar-bg {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 9px;
            margin-top: 4px;
            text-align: center;
        }

        .validation-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 8px;
            margin: 8px 0;
            font-size: 10px;
            border-radius: 4px;
            display: none;
        }

        @media screen and (max-width: 1200px) {
            .page {
                transform: scale(0.8);
                transform-origin: top center;
            }
        }

        @media screen and (max-width: 900px) {
            .page {
                transform: scale(0.6);
            }
            
            .content-area {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            body { margin: 0; background: var(--white); }
            .page { 
                box-shadow: none; 
                margin: 0;
                width: 210mm;
                min-height: 297mm;
                page-break-inside: avoid;
            }
            .control-panel, .validation-warning, #mapMessage {
                display: none !important;
            }
            .component-controls, .photo-controls, .map-controls {
                display: none !important;
            }
            .editable {
                background: transparent !important;
                border: none !important;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .config-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #9C27B0, #673AB7);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
        }

        /* Tutorial Modal */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .tutorial-modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            text-align: center;
        }

        .tutorial-step {
            margin: 20px 0;
        }

        .tutorial-step h3 {
            color: var(--teal-primary);
            margin-bottom: 10px;
        }

        .tutorial-btn {
            background: var(--teal-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }
    </style>
</head>
<body>
    <!-- Indicador de sistema de configuraci√≥n -->
    <div class="config-indicator">
        üéØ V5.1 - MEJORADO
    </div>

    <!-- Panel de control -->
    <div class="control-panel">
        <button class="control-btn-main reload-config-btn" onclick="initializeFromConfig()" data-tooltip="Cargar desde TEMPLATE_CONFIG">üîÑ Recargar Config</button>
        <button class="control-btn-main upload-multiple-btn" onclick="uploadMultipleImages()" data-tooltip="Cargar varias im√°genes a la vez">üì∏ Cargar Fotos</button>
        <button class="control-btn-main help-btn" onclick="toggleHelp()" data-tooltip="Ver gu√≠a de uso">‚ùì Ayuda</button>
        <button class="control-btn-main save-btn" onclick="autosaveJSON()" data-tooltip="Guardar progreso manualmente">üíæ Guardar</button>
        <button class="control-btn-main undo-btn" onclick="undo()" id="undoBtn" disabled data-tooltip="Deshacer √∫ltima acci√≥n">‚Ü∂ Deshacer</button>
        <button class="control-btn-main autoextend-btn active" onclick="toggleAutoExtend()" id="autoExtendBtn" data-tooltip="Auto-ajustar altura de p√°gina">üìè Auto ON</button>
        <button class="control-btn-main export-btn" onclick="exportTemplate('A4')" data-tooltip="Exportar a PDF para imprimir">üìÑ PDF A4</button>
        <button class="control-btn-main preview-btn" onclick="togglePreview()" data-tooltip="Ver sin controles de edici√≥n">üëÅÔ∏è Preview</button>
        
        <div class="validation-warning" id="validationWarning"></div>
        
        <div class="progress-container">
            <div class="progress-bar-bg">
                <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
            </div>
            <div class="progress-text" id="progressText">Completitud: 0%</div>
        </div>
        
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="saveStatus"></div>
                <span id="saveText">Listo</span>
            </div>
            <div class="status-indicator">
                <span id="pageCount">P√°gina 1 de 1</span>
            </div>
        </div>
    </div>

    <!-- Tutorial de primer uso -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-modal">
            <h2>¬°Bienvenido! üéâ</h2>
            <p style="margin: 15px 0;">Te guiar√© en 3 pasos simples para crear tu gu√≠a:</p>
            
            <div class="tutorial-step">
                <h3>üéØ Paso 1: Configura tu pa√≠s</h3>
                <p>Modifica <code>TEMPLATE_CONFIG</code> al inicio del c√≥digo HTML con los datos de tu destino</p>
            </div>
            
            <div class="tutorial-step">
                <h3>üó∫Ô∏è Paso 2: Sube tu mapa</h3>
                <p>Haz clic en "üì§ Subir Mapa" y selecciona la imagen del pa√≠s</p>
            </div>
            
            <div class="tutorial-step">
                <h3>üìÑ Paso 3: Exporta a PDF</h3>
                <p>Cuando termines, haz clic en "üìÑ PDF A4" para descargar</p>
            </div>
            
            <button class="tutorial-btn" onclick="closeTutorial()">¬°Entendido, empecemos!</button>
            <button class="tutorial-btn" onclick="closeTutorial(true)" style="background: #666;">No mostrar de nuevo</button>
        </div>
    </div>

    <!-- Documento principal -->
    <div class="document-container">
        <div class="page" id="page-1" data-page="1">
            <div class="page-content">
                <!-- Header -->
                <div class="master-header">
                    <div class="logo-slot" onclick="uploadLogo(this)">
                        <img src="" alt="Logo" style="display: none;" />
                        <div class="logo-placeholder">LOGO<br><small>Click</small></div>
                    </div>
                    <div class="flag-container">üè≥Ô∏è</div>
                    <div class="country-title editable" data-limit="30" data-var="PAIS">{{PA√çS}}<span class="char-counter">0/30</span></div>
                    <div class="page-indicator">P√°gina <span class="page-number">1</span> de <span class="total-pages">1</span></div>
                </div>

                <!-- √Årea de contenido principal (2 COLUMNAS) -->
                <div class="content-area">
                    <!-- Columna izquierda -->
                    <div class="left-column">
                        <!-- Tarjeta resumen -->
                        <div class="summary-card component flow-item">
                            <div class="summary-title editable" data-limit="25" data-var="NOMBRE_PAIS">{{NOMBRE DEL PA√çS}}<span class="char-counter">0/25</span></div>
                            <div class="summary-item">
                                <span class="summary-label">Fechas:</span> 
                                <span class="editable" data-limit="20" data-var="FECHAS">{{Fechas de visita}}<span class="char-counter">0/20</span></span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Duraci√≥n:</span> 
                                <span class="editable" data-limit="15" data-var="DURACION">{{Duraci√≥n (d√≠as)}}<span class="char-counter">0/15</span></span>
                            </div>
                            
                            <!-- Componente de calificaci√≥n de coste -->
                            <div class="cost-rating component" data-component="COST_RATING">
                                <span class="summary-label">Coste:</span>
                                <div class="cost-circles">
                                    <div class="cost-circle" data-value="1"></div>
                                    <div class="cost-circle" data-value="2"></div>
                                    <div class="cost-circle" data-value="3"></div>
                                    <div class="cost-circle empty" data-value="4"></div>
                                    <div class="cost-circle empty" data-value="5"></div>
                                </div>
                                <span class="cost-text">3/5 ‚Äî Moderado</span>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;">
                                    <div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üí∞</div>
                                    <span class="editable" data-limit="15" data-var="MONEDA">{{Moneda}}<span class="char-counter">0/15</span></span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;">
                                    <div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üîå</div>
                                    <span class="editable" data-limit="15" data-var="ENCHUFE">{{Enchufe}}<span class="char-counter">0/15</span></span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;">
                                    <div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üÜò</div>
                                    <span class="editable" data-limit="15" data-var="EMERGENCIA">{{Tel. emergencia}}<span class="char-counter">0/15</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Secci√≥n de fotos -->
                        <div class="photo-section flow-item">
                            <div class="section-header">
                                <div class="section-title">Fotos del Viaje</div>
                                <div class="section-controls">
                                    <span class="item-counter" id="photoCounter">0/7 fotos</span>
                                    <button class="add-btn" onclick="addPhoto()" id="addPhotoBtn" title="A√±adir nueva foto">+ Foto</button>
                                </div>
                            </div>
                            
                            <div class="photo-frame hero component" data-component="PHOTO_FRAME" data-frame="IMG_HERO">
                                <div style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px;">3:1 Hero</div>
                                <div class="photo-placeholder">
                                    üì∏ Imagen Principal<br>
                                    <small>Arrastra imagen aqu√≠ (ratio 3:1)</small>
                                </div>
                                <div class="photo-controls">
                                    <button class="photo-btn" onclick="changePhoto(this)">Cambiar</button>
                                    <button class="photo-btn" onclick="removePhoto(this)">Eliminar</button>
                                </div>
                            </div>

                            <div class="photo-grid" id="photoGrid">
                                <!-- Las fotos se generar√°n din√°micamente -->
                            </div>
                        </div>

                        <!-- Informaci√≥n r√°pida -->
                        <div style="background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 12px rgba(15, 122, 120, 0.1);" class="flow-item">
                            <div style="font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 14px; color: var(--teal-primary); margin-bottom: 12px;">Informaci√≥n R√°pida</div>
                            <div style="display: flex; align-items: center; gap: 6px; font-size: 10px; margin-bottom: 8px;">
                                <div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üó£Ô∏è</div>
                                <span class="editable" data-limit="20" data-var="IDIOMA">{{Idioma principal}}<span class="char-counter">0/20</span></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px; font-size: 10px;">
                                <div style="width: 16px; height: 16px; background: var(--teal-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">‚ÑπÔ∏è</div>
                                <span class="editable" data-limit="50" data-var="INFO_ADICIONAL">{{Info adicional}}<span class="char-counter">0/50</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Columna derecha -->
                    <div class="right-column">
                        <!-- SECCI√ìN DEL MAPA MEJORADA -->
                        <div class="map-section flow-item">
                            <div class="section-header">
                                <div class="section-title">Ruta del Viaje</div>
                                <div class="section-controls">
                                    <span class="item-counter" id="cityCounter">0/12 ciudades</span>
                                    <button class="add-btn" onclick="addCity()" id="addCityBtn" title="A√±adir nueva ciudad">+ Ciudad</button>
                                </div>
                            </div>
                            
                            <!-- Controles de mapa integrados -->
                            <div class="map-controls">
                                <button class="map-btn" id="uploadMapBtn" onclick="uploadMapImage()">üì§ Subir Mapa</button>
                                <button class="map-btn" onclick="autoPlacePins()" style="display: inline-flex;">üéØ Auto-ubicar</button>
                                <button class="map-btn" onclick="resetMapPins()" style="display: inline-flex;">üîÑ Reset Pins</button>
                            </div>
                            
                            <div class="map-container">
                                <svg class="map-route" viewBox="0 0 100 100">
                                    <path d="M 20 30 Q 40 20 60 40 T 80 70" stroke="var(--teal-primary)" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
                                </svg>
                                <div style="position: absolute; bottom: 8px; right: 8px; width: 40px; height: 40px; background: var(--teal-primary); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px; text-align: center; line-height: 1.1;">QR<br>Map</div>
                            </div>
                            
                            <div class="flow-container" id="citiesList">
                                <!-- Las ciudades se generar√°n din√°micamente -->
                            </div>
                        </div>

                        <!-- Itinerario -->
                        <div class="itinerary-section flow-item">
                            <div class="section-header">
                                <div class="section-title">Itinerario</div>
                                <div class="section-controls">
                                    <span class="item-counter" id="dayCounter">0/10 d√≠as</span>
                                    <button class="add-btn" onclick="addItineraryDay()" id="addDayBtn" title="A√±adir nuevo d√≠a">+ D√≠a</button>
                                </div>
                            </div>
                            
                            <div class="flow-container" id="itineraryList">
                                <!-- Los d√≠as se generar√°n din√°micamente -->
                            </div>
                        </div>

                        <!-- Top lugares -->
                        <div class="top-places flow-item">
                            <div class="section-header">
                                <div class="section-title">Top Lugares</div>
                                <div class="section-controls">
                                    <span class="item-counter" id="placeCounter">0/12 lugares</span>
                                    <button class="add-btn" onclick="addPlace()" id="addPlaceBtn" title="A√±adir nuevo lugar">+ Lugar</button>
                                </div>
                            </div>
                            
                            <div class="flow-container" id="placesList">
                                <!-- Los lugares se generar√°n din√°micamente -->
                            </div>
                        </div>

                        <!-- Consejos r√°pidos -->
                        <div class="quick-tips flow-item">
                            <div class="section-header">
                                <div class="section-title">Consejos R√°pidos</div>
                                <div class="section-controls">
                                    <span class="item-counter" id="tipCounter">0/12 consejos</span>
                                    <button class="add-btn" onclick="addTip()" id="addTipBtn" title="A√±adir nuevo consejo">+ Consejo</button>
                                </div>
                            </div>
                            
                            <div class="tips-grid" id="tipsList">
                                <!-- Los consejos se generar√°n din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="master-footer">
                    <div>
                        <strong>Fecha de creaci√≥n:</strong> <span class="editable" data-limit="15" data-var="FECHA_CREACION">{{Fecha de creaci√≥n}}</span> | 
                        <strong>Cr√©ditos fotos:</strong> <span class="editable" data-limit="50" data-var="CREDITOS">{{Autores}}</span>
                    </div>
                    <div style="margin-top: 4px;">‚ö†Ô∏è Informaci√≥n aproximada ‚Äî verificar requisitos oficiales antes del viaje</div>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT COMPLETO (Parte 2 - Funciones operativas) -->
    <script>
        // ===== VARIABLES GLOBALES =====
        let counters = {
            photos: 0,
            cities: 0,
            days: 0,
            places: 0,
            tips: 0,
            pages: 1
        };

        const limits = {
            photos: 7,
            cities: 12,
            days: 10,
            places: 12,
            tips: 12
        };

        let undoStack = [];
        const MAX_UNDO = 10;
        let autoExtendEnabled = true;

        // ===== INICIALIZACI√ìN AL CARGAR LA P√ÅGINA =====
        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar tutorial solo la primera vez
            if (!localStorage.getItem('tutorial_completed')) {
                document.getElementById('tutorialOverlay').style.display = 'flex';
            }
            
            initializeFromConfig();
            loadFromLocalStorage();
            setupEventListeners();
            setupKeyboardShortcuts();
            console.log('üéØ Sistema V5.1 cargado correctamente');
        });

        // ===== TUTORIAL =====
        function closeTutorial(dontShowAgain = false) {
            document.getElementById('tutorialOverlay').style.display = 'none';
            if (dontShowAgain) {
                localStorage.setItem('tutorial_completed', 'true');
            }
        }

        // ===== ATAJOS DE TECLADO =====
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+S o Cmd+S para guardar
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    autosaveJSON();
                    showToast('Guardado manualmente');
                }
                
                // Ctrl+Z o Cmd+Z para deshacer
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault();
                    undo();
                }
                
                // Escape para salir de vista previa
                if (e.key === 'Escape') {
                    const isPreview = document.body.classList.contains('preview-mode');
                    if (isPreview) {
                        togglePreview();
                    }
                }
                
                // Ctrl+P o Cmd+P para vista previa (override print dialog)
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    togglePreview();
                }
            });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 3000;
                font-size: 12px;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 2000);
        }

        // ===== CARGA M√öLTIPLE DE IM√ÅGENES =====
        function uploadMultipleImages() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                const availableFrames = document.querySelectorAll('.photo-frame:not(.has-image)');
                
                if (files.length > availableFrames.length) {
                    alert(`Solo puedes cargar ${availableFrames.length} im√°genes m√°s`);
                    return;
                }
                
                files.forEach((file, index) => {
                    if (availableFrames[index]) {
                        loadImageToFrame(availableFrames[index], file);
                    }
                });
                
                showToast(`${files.length} im√°genes cargadas`);
            };
            input.click();
        }

        // ===== FUNCIONES B√ÅSICAS =====
        function mmToPx(mm) {
            return mm * (96 / 25.4);
        }

        function elementFitsInPage(el) {
            const page = document.querySelector('.page');
            const pageContent = page.querySelector('.page-content');
            
            const used = Array.from(pageContent.children).reduce((h, child) => {
                return h + child.offsetHeight + parseFloat(getComputedStyle(child).marginBottom || 0);
            }, 0);
            
            const safePx = mmToPx(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-margin')));
            const available = Math.max(pageContent.clientHeight, mmToPx(297) - safePx * 2);
            
            return used <= available;
        }

        function expandPageToFit() {
            const page = document.querySelector('.page');
            page.style.height = 'auto';
            page.style.minHeight = '297mm';
            counters.pages = 1;
            updatePageCounters();
        }

        function clearIDs(clone) {
            clone.querySelectorAll('[id]').forEach(el => {
                el.removeAttribute('id');
            });
            
            if (clone.dataset.component) {
                clone.dataset.cloned = 'true';
            }
        }

        function toggleAutoExtend() {
            autoExtendEnabled = !autoExtendEnabled;
            const btn = document.getElementById('autoExtendBtn');
            
            if (autoExtendEnabled) {
                btn.textContent = 'üìè Auto ON';
                btn.classList.add('active');
                setTimeout(() => {
                    expandPageToFit();
                    checkOverflow();
                }, 100);
            } else {
                btn.textContent = 'üìè Auto OFF';
                btn.classList.remove('active');
            }
        }

        function uploadLogo(logoSlot) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = logoSlot.querySelector('img');
                        const placeholder = logoSlot.querySelector('.logo-placeholder');
                        
                        img.src = event.target.result;
                        img.style.display = 'block';
                        placeholder.style.display = 'none';
                        logoSlot.classList.add('has-logo');
                        
                        // Guardar en config
                        TEMPLATE_CONFIG.logo = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function setupEventListeners() {
            setInterval(autosaveJSON, 30000);
            window.addEventListener('resize', debounce(() => {
                expandPageToFit();
                checkOverflow();
            }, 300));
        }

        function setupEditableElement(element) {
            const limit = parseInt(element.dataset.limit) || 100;
            
            element.addEventListener('click', function() {
                saveState();
                this.contentEditable = true;
                this.focus();
                this.style.background = 'rgba(255, 107, 97, 0.3)';
                updateCharCounter(this);
            });

            element.addEventListener('input', function() {
                updateCharCounter(this);
                enforceLimit(this, limit);
                debounce(() => {
                    expandPageToFit();
                    checkOverflow();
                    updateCompletionProgress();
                }, 500)();
            });

            element.addEventListener('blur', function() {
                this.contentEditable = false;
                this.style.background = 'rgba(255, 107, 97, 0.1)';
                autosaveJSON();
            });

            element.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.blur();
                }
            });

            updateCharCounter(element);
        }

        function updateCharCounter(element) {
            const counter = element.querySelector('.char-counter');
            if (counter) {
                const limit = parseInt(element.dataset.limit) || 100;
                const current = element.textContent.replace(/\d+\/\d+/, '').trim().length;
                counter.textContent = `${current}/${limit}`;
                counter.className = current > limit ? 'char-counter warning' : 'char-counter';
                
                if (current > limit) {
                    element.classList.add('overflow-warning');
                } else {
                    element.classList.remove('overflow-warning');
                }
            }
        }

        function enforceLimit(element, limit) {
            const counter = element.querySelector('.char-counter');
            let text = element.textContent;
            
            if (counter) {
                text = text.replace(/\d+\/\d+/, '').trim();
            }
            
            if (text.length > limit) {
                const truncated = text.substring(0, limit);
                if (counter) {
                    element.innerHTML = truncated + counter.outerHTML;
                } else {
                    element.textContent = truncated;
                }
                showToast('L√≠mite de caracteres alcanzado');
            }
        }

        // ===== COMPONENTES =====
        function duplicateComponent(button) {
            saveState();
            
            const component = button.closest('.component');
            const componentType = component.dataset.component;
            
            const sectionLimits = {
                'ITINERARY_CARD': 'days',
                'PLACE_ITEM': 'places',
                'TIP_ITEM': 'tips',
                'CITY_ITEM': 'cities',
                'PHOTO_FRAME': 'photos'
            };
            
            const limitKey = sectionLimits[componentType];
            if (limitKey && counters[limitKey] >= limits[limitKey]) {
                alert(`M√°ximo ${limits[limitKey]} elementos permitidos`);
                return;
            }
            
            const clone = component.cloneNode(true);
            clearIDs(clone);
            updateClonedComponent(clone, componentType);
            component.parentElement.insertBefore(clone, component.nextSibling);
            
            if (limitKey) {
                counters[limitKey]++;
                updateCounterDisplay(limitKey);
            }
            
            clone.querySelectorAll('.editable').forEach(setupEditableElement);
            clone.classList.add('fade-in');
            
            setTimeout(() => {
                expandPageToFit();
                checkOverflow();
            }, 100);
        }

        function deleteComponent(button) {
            saveState();
            
            const component = button.closest('.component');
            const componentType = component.dataset.component;
            
            const siblings = component.parentElement.querySelectorAll(`[data-component="${componentType}"]`);
            if (siblings.length <= 1) {
                alert('Debe mantener al menos un elemento');
                return;
            }
            
            component.style.transition = 'all 0.3s ease';
            component.style.opacity = '0';
            component.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                component.remove();
                
                const sectionLimits = {
                    'ITINERARY_CARD': 'days',
                    'PLACE_ITEM': 'places',
                    'TIP_ITEM': 'tips',
                    'CITY_ITEM': 'cities',
                    'PHOTO_FRAME': 'photos'
                };
                
                const limitKey = sectionLimits[componentType];
                if (limitKey) {
                    counters[limitKey]--;
                    updateCounterDisplay(limitKey);
                }
                
                reindexCounters();
                expandPageToFit();
                checkOverflow();
            }, 300);
        }

        function updateClonedComponent(clone, componentType) {
            if (componentType === 'CITY_ITEM') {
                const number = clone.querySelector('div[style*="background: var(--teal-primary)"]');
                if (number) {
                    number.textContent = counters.cities + 1;
                }
            }
            
            if (componentType === 'ITINERARY_CARD') {
                const dayTitle = clone.querySelector('.day-title .editable');
                if (dayTitle) {
                    dayTitle.innerHTML = `D√≠a ${counters.days + 1}: Ciudad<span class="char-counter">0/20</span>`;
                }
            }
            
            clone.querySelectorAll('.editable').forEach(el => {
                const placeholder = el.dataset.var || 'Nuevo elemento';
                const counter = el.querySelector('.char-counter');
                el.innerHTML = `{{${placeholder}}}` + (counter ? counter.outerHTML : '');
            });
        }

        function updateCounterDisplay(type) {
            const counterMappings = {
                'days': 'dayCounter',
                'places': 'placeCounter',
                'tips': 'tipCounter',
                'cities': 'cityCounter',
                'photos': 'photoCounter'
            };
            
            const counterId = counterMappings[type];
            const counterEl = document.getElementById(counterId);
            
            if (counterEl) {
                const maxLimit = limits[type];
                counterEl.textContent = `${counters[type]}/${maxLimit} ${getTypeLabel(type)}`;
                
                const addBtnId = `add${type.charAt(0).toUpperCase() + type.slice(1, -1)}Btn`;
                const addBtn = document.getElementById(addBtnId);
                if (addBtn) {
                    addBtn.disabled = counters[type] >= maxLimit;
                }
            }
        }

        function getTypeLabel(type) {
            const labels = {
                'days': 'd√≠as',
                'places': 'lugares',
                'tips': 'consejos',
                'cities': 'ciudades',
                'photos': 'fotos'
            };
            return labels[type] || type;
        }

        function updateAllCounters() {
            Object.keys(counters).forEach(type => {
                if (type !== 'pages') {
                    updateCounterDisplay(type);
                }
            });
            updatePageCounters();
        }

        function updatePageCounters() {
            document.querySelectorAll('.total-pages').forEach(el => {
                el.textContent = '1';
            });
            
            document.querySelectorAll('.page-number').forEach(el => {
                el.textContent = '1';
            });
            
            const pageCountEl = document.getElementById('pageCount');
            if (pageCountEl) {
                pageCountEl.textContent = 'P√°gina 1 de 1';
            }
            
            counters.pages = 1;
        }

        // ===== A√ëADIR ELEMENTOS =====
        function addItineraryDay() {
            if (counters.days >= limits.days) {
                alert(`M√°ximo ${limits.days} d√≠as permitidos`);
                return;
            }
            
            saveState();
            
            const container = document.querySelector('#itineraryList');
            const dayElement = createDayElement(counters.days + 1, `D√≠a ${counters.days + 1}: Ciudad`, '');
            container.appendChild(dayElement);
            
            counters.days++;
            updateCounterDisplay('days');
            
            dayElement.querySelectorAll('.editable').forEach(setupEditableElement);
            dayElement.classList.add('fade-in');
            
            setTimeout(() => {
                expandPageToFit();
                checkOverflow();
            }, 100);
        }

        function addPlace() {
            if (counters.places >= limits.places) {
                alert(`M√°ximo ${limits.places} lugares permitidos`);
                return;
            }
            
            saveState();
            
            const container = document.querySelector('#placesList');
            const config = {
                [`lugar${counters.places + 1}`]: `Lugar ${counters.places + 1}`,
                [`ciudad_lugar${counters.places + 1}`]: 'Ciudad',
                [`desc_lugar${counters.places + 1}`]: 'Descripci√≥n',
                [`tipo_lugar${counters.places + 1}`]: 'must'
            };
            const placeElement = createPlaceElement(counters.places + 1, config);
            container.appendChild(placeElement);
            
            counters.places++;
            updateCounterDisplay('places');
            
            placeElement.querySelectorAll('.editable').forEach(setupEditableElement);
            placeElement.classList.add('fade-in');
            
            setTimeout(() => {
                expandPageToFit();
                checkOverflow();
            }, 100);
        }

        function addTip() {
            if (counters.tips >= limits.tips) {
                alert(`M√°ximo ${limits.tips} consejos permitidos`);
                return;
            }
            
            saveState();
            
            const container = document.querySelector('#tipsList');
            const iconos = ['üí∞', 'üöå', 'üîí', 'üì±', 'üçΩÔ∏è', '‚ö°', 'üéØ', 'üìç', 'üó∫Ô∏è', '‚è∞', 'üéå', 'üçú'];
            const tipElement = createTipElement(counters.tips + 1, `Consejo ${counters.tips + 1}`, iconos[counters.tips % iconos.length] || 'üí°');
            container.appendChild(tipElement);
            
            counters.tips++;
            updateCounterDisplay('tips');
            
            tipElement.querySelectorAll('.editable').forEach(setupEditableElement);
            tipElement.classList.add('fade-in');
            
            setTimeout(() => {
                expandPageToFit();
                checkOverflow();
            }, 100);
        }

        function addCity() {
            if (counters.cities >= limits.cities) {
                alert(`M√°ximo ${limits.cities} ciudades permitidas`);
                return;
            }
            
            saveState();
            
            const container = document.querySelector('#citiesList');
            const cityElement = createCityElement(counters.cities + 1, `Ciudad ${counters.cities + 1} ‚Äî descripci√≥n`);
            container.appendChild(cityElement);
            
            counters.cities++;
            updateCounterDisplay('cities');
            addMapPin(counters.cities);
            
            cityElement.querySelectorAll('.editable').forEach(setupEditableElement);
            cityElement.classList.add('fade-in');
            
            setTimeout(() => {
                expandPageToFit();
                checkOverflow();
            }, 100);
        }

        function addPhoto() {
            if (counters.photos >= limits.photos) {
                alert(`M√°ximo ${limits.photos} fotos permitidas`);
                return;
            }
            
            saveState();
            
            const container = document.querySelector('#photoGrid');
            const photoFrame = document.createElement('div');
            photoFrame.className = 'photo-frame mini component';
            photoFrame.setAttribute('data-component', 'PHOTO_FRAME');
            photoFrame.setAttribute('data-frame', `IMG_${counters.photos + 1}`);
            
            photoFrame.innerHTML = `
                <div style="position: absolute; top: 4px; left: 4px; background: var(--teal-primary); color: white; padding: 1px 3px; border-radius: 2px; font-size: 7px;">1:1</div>
                <div class="photo-placeholder">
                    üì∑ IMG_${counters.photos + 1}<br>
                    <small>Drag & Drop</small>
                </div>
                <div class="photo-controls">
                    <button class="photo-btn" onclick="changePhoto(this)">Cambiar</button>
                    <button class="photo-btn" onclick="removePhoto(this)">√ó</button>
                </div>
                <div class="component-controls">
                    <button class="control-btn duplicate-btn" onclick="duplicateComponent(this)" title="Duplicar foto">‚ßâ</button>
                    <button class="control-btn delete-btn" onclick="deleteComponent(this)" title="Eliminar foto">√ó</button>
                </div>
            `;
            
            container.appendChild(photoFrame);
            counters.photos++;
            updateCounterDisplay('photos');
            
            setupPhotoDragDropSingle(photoFrame);
            photoFrame.classList.add('fade-in');
            
            setTimeout(() => {
                expandPageToFit();
            }, 100);
        }

        function addMapPin(number) {
            const mapContainer = document.querySelector('.map-container');
            const pin = document.createElement('div');
            pin.className = 'map-pin component';
            pin.dataset.component = 'MAP_PIN';
            pin.dataset.pin = number;
            pin.textContent = number;
            
            const randomTop = Math.random() * 60 + 20;
            const randomLeft = Math.random() * 60 + 20;
            pin.style.top = randomTop + '%';
            pin.style.left = randomLeft + '%';
            
            mapContainer.appendChild(pin);
            setupMapPinSingle(pin);
        }

        // ===== FOTOS =====
        function setupPhotoDragDrop() {
            document.querySelectorAll('.photo-frame').forEach(setupPhotoDragDropSingle);
        }

        function setupPhotoDragDropSingle(frame) {
            frame.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--teal-primary)';
            });

            frame.addEventListener('dragleave', function(e) {
                this.style.borderColor = '#ccc';
            });

            frame.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ccc';
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    loadImageToFrame(this, files[0]);
                }
            });

            frame.addEventListener('click', function() {
                if (!this.classList.contains('has-image')) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (e) => {
                        if (e.target.files[0]) {
                            loadImageToFrame(this, e.target.files[0]);
                        }
                    };
                    input.click();
                }
            });
        }

        function loadImageToFrame(frame, file, url = null) {
            if (url) {
                frame.style.backgroundImage = `url(${url})`;
                frame.style.backgroundSize = 'cover';
                frame.style.backgroundPosition = 'center';
                frame.classList.add('has-image');
                
                const placeholder = frame.querySelector('.photo-placeholder');
                if (placeholder) placeholder.style.display = 'none';
                
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                frame.style.backgroundImage = `url(${e.target.result})`;
                frame.style.backgroundSize = 'cover';
                frame.style.backgroundPosition = 'center';
                frame.classList.add('has-image');
                
                const placeholder = frame.querySelector('.photo-placeholder');
                if (placeholder) placeholder.style.display = 'none';
                
                setTimeout(() => {
                    expandPageToFit();
                }, 100);
            };
            reader.readAsDataURL(file);
        }

        function changePhoto(button) {
            const frame = button.closest('.photo-frame');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    loadImageToFrame(frame, file);
                }
            };
            input.click();
        }

        function removePhoto(button) {
            const frame = button.closest('.photo-frame');
            frame.style.backgroundImage = '';
            frame.classList.remove('has-image');
            
            const placeholder = frame.querySelector('.photo-placeholder');
            if (placeholder) placeholder.style.display = 'block';
        }

        // ===== MAPA =====
        function setupMapPins() {
            document.querySelectorAll('.map-pin').forEach(setupMapPinSingle);
        }

        function setupMapPinSingle(pin) {
            let isDragging = false;
            let startX, startY, startLeft, startTop;

            pin.addEventListener('mousedown', function(e) {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                
                const rect = this.getBoundingClientRect();
                const containerRect = this.parentElement.getBoundingClientRect();
                startLeft = ((rect.left - containerRect.left) / containerRect.width) * 100;
                startTop = ((rect.top - containerRect.top) / containerRect.height) * 100;
                
                this.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                const containerRect = pin.parentElement.getBoundingClientRect();
                
                const newLeft = startLeft + (deltaX / containerRect.width) * 100;
                const newTop = startTop + (deltaY / containerRect.height) * 100;
                
                const constrainedLeft = Math.max(2, Math.min(98, newLeft));
                const constrainedTop = Math.max(2, Math.min(98, newTop));
                
                pin.style.left = constrainedLeft + '%';
                pin.style.top = constrainedTop + '%';
            });

            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    pin.style.cursor = 'move';
                }
            });
        }

        function setupCostRating() {
            document.querySelectorAll('.cost-circle').forEach((circle, index) => {
                circle.addEventListener('click', function() {
                    saveState();
                    
                    const circles = this.parentElement.querySelectorAll('.cost-circle');
                    const value = index + 1;
                    
                    circles.forEach((c, i) => {
                        if (i < value) {
                            c.classList.remove('empty');
                        } else {
                            c.classList.add('empty');
                        }
                    });
                    
                    const costText = this.parentElement.parentElement.querySelector('.cost-text');
                    const labels = ['Muy barato', 'Barato', 'Moderado', 'Caro', 'Muy caro'];
                    costText.textContent = `${value}/5 ‚Äî ${labels[value-1]}`;
                    
                    // Actualizar config
                    TEMPLATE_CONFIG.coste_nivel = value;
                });
            });
        }

        function cyclePlaceBadge(badge) {
            saveState();
            
            const types = ['must', 'skip', 'eco', 'family'];
            const labels = ['MUST', 'SKIP', 'ECO', 'FAMILY'];
            const currentIndex = types.findIndex(type => badge.classList.contains(type));
            const nextIndex = (currentIndex + 1) % types.length;
            
            badge.className = `place-badge ${types[nextIndex]}`;
            badge.textContent = labels[nextIndex];
        }

        function checkOverflow() {
            const allElements = document.querySelectorAll('.flow-item, .component');
            let hasOverflow = false;
            
            allElements.forEach(item => {
                const rect = item.getBoundingClientRect();
                const pageRect = document.querySelector('.page').getBoundingClientRect();
                
                if (rect.bottom > pageRect.bottom + 100) {
                    item.classList.add('overflow-warning');
                    hasOverflow = true;
                } else {
                    item.classList.remove('overflow-warning');
                }
            });
        }

        function reindexCounters() {
            const dayCards = document.querySelectorAll('[data-component="ITINERARY_CARD"]');
            dayCards.forEach((card, index) => {
                const dayTitle = card.querySelector('.day-title .editable');
                if (dayTitle) {
                    const currentText = dayTitle.textContent.replace(/D√≠a \d+/, `D√≠a ${index + 1}`);
                    dayTitle.textContent = currentText;
                }
            });
            
            const cityItems = document.querySelectorAll('[data-component="CITY_ITEM"]');
            cityItems.forEach((item, index) => {
                const numberEl = item.querySelector('div[style*="background: var(--teal-primary)"]');
                if (numberEl) {
                    numberEl.textContent = index + 1;
                }
            });
            
            const mapPins = document.querySelectorAll('[data-component="MAP_PIN"]');
            mapPins.forEach((pin, index) => {
                pin.textContent = index + 1;
                pin.dataset.pin = index + 1;
            });
        }

        // ===== DESHACER =====
        function saveState() {
            const state = serializeTemplate();
            undoStack.push(JSON.stringify(state));
            
            if (undoStack.length > MAX_UNDO) {
                undoStack.shift();
            }
            
            const undoBtn = document.getElementById('undoBtn');
            if (undoBtn) {
                undoBtn.disabled = false;
            }
        }

        function undo() {
            if (undoStack.length === 0) return;
            
            const previousState = undoStack.pop();
            if (previousState) {
                restoreTemplate(JSON.parse(previousState));
                
                const undoBtn = document.getElementById('undoBtn');
                if (undoBtn && undoStack.length === 0) {
                    undoBtn.disabled = true;
                }
                
                showToast('Cambio deshecho');
            }
        }

        // ===== GUARDAR/CARGAR =====
        function autosaveJSON() {
            try {
                const templateData = serializeTemplate();
                localStorage.setItem('canva_travel_template_v51', JSON.stringify(templateData));
                
                const statusDot = document.getElementById('saveStatus');
                const statusText = document.getElementById('saveText');
                if (statusDot && statusText) {
                    statusDot.className = 'status-dot';
                    statusText.textContent = '‚úÖ Guardado';
                }
                
                setTimeout(() => {
                    if (statusText) statusText.textContent = 'Listo';
                }, 2000);
            } catch (error) {
                const statusDot = document.getElementById('saveStatus');
                const statusText = document.getElementById('saveText');
                if (statusDot && statusText) {
                    statusDot.className = 'status-dot error';
                    statusText.textContent = 'Error';
                }
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('canva_travel_template_v51');
                if (saved) {
                    const templateData = JSON.parse(saved);
                    restoreTemplate(templateData);
                }
            } catch (error) {
                console.error('Error al cargar:', error);
            }
        }

        function serializeTemplate() {
            const data = {
                version: '5.1',
                timestamp: new Date().toISOString(),
                counters: { ...counters },
                autoExtendEnabled: autoExtendEnabled,
                editableContent: {},
                images: {},
                components: {},
                mapData: {
                    type: TEMPLATE_CONFIG.mapa_tipo,
                    url: TEMPLATE_CONFIG.mapa_url
                }
            };
            
            document.querySelectorAll('.editable').forEach(el => {
                const varName = el.dataset.var || `editable_${Date.now()}_${Math.random()}`;
                data.editableContent[varName] = el.textContent.replace(/\d+\/\d+/, '').trim();
            });
            
            document.querySelectorAll('.photo-frame.has-image').forEach(frame => {
                const frameId = frame.dataset.frame || `img_${Date.now()}`;
                data.images[frameId] = {
                    backgroundImage: frame.style.backgroundImage
                };
            });
            
            const logoImg = document.querySelector('.logo-slot img');
            if (logoImg && logoImg.src) {
                data.logo = logoImg.src;
            }
            
            document.querySelectorAll('.cost-circle:not(.empty)').forEach((circle, index) => {
                data.components.costRating = index + 1;
            });
            
            const mapPins = document.querySelectorAll('.map-pin');
            data.components.mapPins = Array.from(mapPins).map(pin => ({
                number: pin.textContent,
                top: pin.style.top,
                left: pin.style.left
            }));
            
            return data;
        }

        function restoreTemplate(data) {
            if (!data || !data.version) {
                console.warn('Versi√≥n de template incompatible');
                return;
            }
            
            counters = { ...data.counters };
            
            if (data.autoExtendEnabled !== undefined) {
                autoExtendEnabled = data.autoExtendEnabled;
                const btn = document.getElementById('autoExtendBtn');
                if (btn) {
                    btn.textContent = autoExtendEnabled ? 'üìè Auto ON' : 'üìè Auto OFF';
                    btn.classList.toggle('active', autoExtendEnabled);
                }
            }
            
            Object.entries(data.editableContent).forEach(([varName, content]) => {
                const element = document.querySelector(`[data-var="${varName}"]`);
                if (element) {
                    const counter = element.querySelector('.char-counter');
                    element.innerHTML = content + (counter ? counter.outerHTML : '');
                }
            });
            
            Object.entries(data.images).forEach(([frameId, imageData]) => {
                const frame = document.querySelector(`[data-frame="${frameId}"]`);
                if (frame) {
                    frame.style.backgroundImage = imageData.backgroundImage;
                    frame.classList.add('has-image');
                    
                    const placeholder = frame.querySelector('.photo-placeholder');
                    if (placeholder) placeholder.style.display = 'none';
                }
            });
            
            if (data.logo) {
                const logoSlot = document.querySelector('.logo-slot');
                const img = logoSlot.querySelector('img');
                const placeholder = logoSlot.querySelector('.logo-placeholder');
                
                img.src = data.logo;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                logoSlot.classList.add('has-logo');
            }
            
            if (data.components.costRating) {
                const circles = document.querySelectorAll('.cost-circle');
                circles.forEach((circle, index) => {
                    if (index < data.components.costRating) {
                        circle.classList.remove('empty');
                    } else {
                        circle.classList.add('empty');
                    }
                });
            }
            
            if (data.mapData && data.mapData.url) {
                TEMPLATE_CONFIG.mapa_url = data.mapData.url;
                const mapContainer = document.querySelector('.map-container');
                const existingPins = Array.from(mapContainer.querySelectorAll('.map-pin'));
                
                const img = document.createElement('img');
                img.src = data.mapData.url;
                img.style.cssText = 'width: 100%; height: 100%; object-fit: contain; object-position: center;';
                mapContainer.innerHTML = '';
                mapContainer.appendChild(img);
                mapContainer.classList.add('has-custom-map');
                
                existingPins.forEach(pin => {
                    mapContainer.appendChild(pin);
                });
            }
            
            if (data.components.mapPins) {
                setTimeout(() => {
                    data.components.mapPins.forEach(pinData => {
                        const pin = document.querySelector(`[data-pin="${pinData.number}"]`);
                        if (pin) {
                            pin.style.top = pinData.top;
                            pin.style.left = pinData.left;
                        }
                    });
                }, 100);
            }
            
            updateAllCounters();
            updateCompletionProgress();
            document.querySelectorAll('.editable').forEach(setupEditableElement);
            setTimeout(() => {
                expandPageToFit();
            }, 100);
        }

        // ===== EXPORTAR =====
        function exportTemplate(format) {
            switch (format) {
                case 'A4':
                    exportA4PDF();
                    break;
                default:
                    console.log('Formato no soportado:', format);
            }
        }

        function exportA4PDF() {
            document.querySelectorAll('.component-controls, .add-btn, .control-panel, .map-controls, .validation-warning, #mapMessage').forEach(el => {
                el.style.display = 'none';
            });
            
            document.querySelectorAll('.editable').forEach(el => {
                el.style.background = 'transparent';
                el.style.border = 'none';
            });
            
            setTimeout(() => {
                window.print();
                
                setTimeout(() => {
                    document.querySelectorAll('.component-controls, .add-btn, .control-panel, .map-controls').forEach(el => {
                        el.style.display = '';
                    });
                    
                    document.querySelectorAll('.editable').forEach(el => {
                        el.style.background = '';
                        el.style.border = '';
                    });
                }, 1000);
            }, 500);
        }

        function toggleHelp() {
            alert(`üéØ GU√çA DE USO - V5.1

‚úÖ CORRECCIONES IMPLEMENTADAS:
‚Ä¢ Campo embajada eliminado
‚Ä¢ Consejos r√°pidos funcionando correctamente
‚Ä¢ Limpieza autom√°tica al recargar (evita duplicados)
‚Ä¢ Secci√≥n de informaci√≥n r√°pida totalmente editable
‚Ä¢ Carga m√∫ltiple de im√°genes con bot√≥n "üì∏ Cargar Fotos"

üîß SISTEMA DE CONFIGURACI√ìN:
‚Ä¢ Modifica TEMPLATE_CONFIG al inicio del c√≥digo
‚Ä¢ Agrega ciudades: ciudad1, ciudad2, ciudad3... hasta ciudad12
‚Ä¢ Agrega d√≠as: dia1, actividad1, dia2, actividad2... hasta dia10
‚Ä¢ Agrega lugares: lugar1, ciudad_lugar1, desc_lugar1, tipo_lugar1...
‚Ä¢ Agrega consejos: tip1, tip2, tip3... hasta tip12
‚Ä¢ Click "üîÑ Recargar Config" para aplicar cambios

‚å®Ô∏è ATAJOS DE TECLADO:
‚Ä¢ Ctrl+S (Cmd+S): Guardar manualmente
‚Ä¢ Ctrl+Z (Cmd+Z): Deshacer √∫ltima acci√≥n
‚Ä¢ Ctrl+P (Cmd+P): Activar vista previa
‚Ä¢ Escape: Salir de vista previa

üó∫Ô∏è SISTEMA DE MAPAS:
‚Ä¢ "üì§ Subir Mapa": Carga imagen personalizada del pa√≠s
‚Ä¢ "üéØ Auto-ubicar": Posiciona pins inteligentemente
‚Ä¢ "üîÑ Reset Pins": Elimina y regenera pins
‚Ä¢ Arrastra pins manualmente para ajustar

üì∏ CARGAR IM√ÅGENES:
‚Ä¢ "üì∏ Cargar Fotos": Sube m√∫ltiples im√°genes a la vez
‚Ä¢ Drag & drop individual en cada marco
‚Ä¢ Click en marco vac√≠o para seleccionar imagen

üìä BARRA DE PROGRESO:
‚Ä¢ Verde (>80%): Gu√≠a casi completa
‚Ä¢ Amarillo (50-80%): Faltan algunos datos
‚Ä¢ Rojo (<50%): Muchos campos vac√≠os

üí° FLUJO RECOMENDADO:
1. Modifica TEMPLATE_CONFIG con datos del pa√≠s
2. Click "üîÑ Recargar Config"
3. Sube mapa con "üì§ Subir Mapa"
4. Carga fotos con "üì∏ Cargar Fotos"
5. Ajusta textos haciendo click sobre ellos
6. Arrastra pins del mapa a posiciones correctas
7. Revisa con "üëÅÔ∏è Preview"
8. Exporta con "üìÑ PDF A4"

‚ú® MEJORAS V5.1:
‚Ä¢ Tooltips en todos los botones (pasa el mouse)
‚Ä¢ Validaci√≥n de campos vac√≠os
‚Ä¢ Barra de progreso de completitud
‚Ä¢ Atajos de teclado
‚Ä¢ Tutorial de primer uso
‚Ä¢ Carga m√∫ltiple de im√°genes
‚Ä¢ Bugs corregidos

üöÄ ¬°Tu gu√≠a est√° lista para compartir!`);
        }

        function togglePreview() {
            const isPreview = document.body.classList.toggle('preview-mode');
            
            document.querySelectorAll('.component-controls, .add-btn, .map-controls, .validation-warning, #mapMessage').forEach(el => {
                el.style.display = isPreview ? 'none' : '';
            });
            
            document.querySelectorAll('.editable').forEach(el => {
                if (isPreview) {
                    el.style.background = 'transparent';
                    el.style.border = 'none';
                    el.contentEditable = false;
                } else {
                    el.style.background = '';
                    el.style.border = '';
                }
            });
            
            const btn = document.querySelector('.preview-btn');
            if (btn) {
                btn.textContent = isPreview ? '‚úèÔ∏è Editar' : 'üëÅÔ∏è Preview';
            }
            
            const controlPanel = document.querySelector('.control-panel');
            if (controlPanel) {
                controlPanel.style.opacity = isPreview ? '0.5' : '1';
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Mensaje de bienvenida en consola
        console.log(`
üéØ SISTEMA V5.1 - MEJORADO Y CORREGIDO
====================================

‚úÖ PROBLEMAS CORREGIDOS:
‚Ä¢ ‚úì Campo embajada eliminado
‚Ä¢ ‚úì Consejos r√°pidos funcionan correctamente
‚Ä¢ ‚úì Limpieza autom√°tica (no m√°s duplicados)
‚Ä¢ ‚úì Informaci√≥n r√°pida editable
‚Ä¢ ‚úì Carga m√∫ltiple de im√°genes

üÜï NUEVAS CARACTER√çSTICAS:
‚Ä¢ ‚å®Ô∏è Atajos de teclado (Ctrl+S, Ctrl+Z, Esc)
‚Ä¢ üìä Barra de progreso de completitud
‚Ä¢ üí° Tooltips en todos los botones
‚Ä¢ ‚ö†Ô∏è Validaci√≥n de campos vac√≠os
‚Ä¢ üéì Tutorial de primer uso
‚Ä¢ üì∏ Carga batch de im√°genes

üìä CONFIGURACI√ìN ACTUAL:
‚Ä¢ Pa√≠s: ${TEMPLATE_CONFIG.pais}
‚Ä¢ Ciudades: ${detectConfigCounts(TEMPLATE_CONFIG).ciudades}
‚Ä¢ D√≠as: ${detectConfigCounts(TEMPLATE_CONFIG).dias}
‚Ä¢ Lugares: ${detectConfigCounts(TEMPLATE_CONFIG).lugares}
‚Ä¢ Consejos: ${detectConfigCounts(TEMPLATE_CONFIG).tips}

üîß PERSONALIZACI√ìN:
‚Ä¢ Edita TEMPLATE_CONFIG al inicio
‚Ä¢ Click "üîÑ Recargar Config" para aplicar
‚Ä¢ Usa "üì§ Subir Mapa" para imagen personalizada
‚Ä¢ Usa "üì∏ Cargar Fotos" para m√∫ltiples im√°genes

¬°Sistema listo para GitHub Pages! üöÄ
        `);
    </script>
</body>
</html>

